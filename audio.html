<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escuchar Biblia - Biblia de Poder y Milagros</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="apple-touch-icon" href="icons/pymicon.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Audio page mobile modern layout */
        body { margin: 0; background: #121212; color: #fff; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        #player-controls { position: relative; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 20px; box-sizing: border-box; overflow: hidden; }
        #player-controls::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('icons/pymicon.png') center/cover no-repeat; filter: blur(20px) brightness(40%); z-index: -1; }
        .audio-cover { width: 200px; height: 200px; border-radius: 50%; overflow: hidden; margin-top: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .audio-cover img { width: 100%; height: 100%; object-fit: cover; }
        .player-header { font-size: 1.2em; margin: 20px 0 10px; }
        .seek-slider { width: calc(100% - 40px); accent-color: #1DB954; margin: 0 20px; }
        .time-display { display: flex; justify-content: space-between; width: calc(100% - 40px); font-size: 0.9em; margin: 10px 20px; }
        .player-buttons { display: flex; justify-content: center; align-items: center; gap: 40px; margin-bottom: 30px; }
        .player-button { background: none; border: none; color: #fff; font-size: 2em; width: 60px; height: 60px; cursor: pointer; }
        .player-button:hover { color: #1DB954; }
        /* Mostrar men√∫ lateral y lista de cap√≠tulos */
        /* .sidebar, #menu-toggle, #menu-panel, #chapters-list { display: none !important; } */
    </style>
</head>
<body>
    <button id="menu-toggle" style="position:fixed; top:10px; right:10px; z-index:1001;">üìñ Seleccionar Libro</button>
    <div id="menu-panel">
        <h2>Libros</h2>
        <input type="search" id="menu-search" placeholder="Buscar libro...">
        <ul id="menu-books-list"></ul>
    </div>
    <div class="controls" id="controls">
        <div class="top-row">
            <a href="index.html" class="home-icon">üè†</a>
            <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">üåô</button>
        </div>
    </div>
    <div class="audio-container" style="display:flex; gap:20px; margin-top:80px; padding:20px;">
        <div class="sidebar" style="flex:1; max-width:300px;">
            <h2>Selecciona un libro</h2>
            <input type="search" id="book-search" placeholder="Buscar libro..." style="width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:4px;">
            <ul id="books-list" class="select-css" style="list-style:none;padding:0;max-height:60vh;overflow:auto;"></ul>
        </div>
        <div class="main" style="flex:2;">
            <h2 id="book-title">Informaci√≥n del libro</h2>
            <div id="book-info" style="margin-bottom:20px;">Selecciona un libro para ver detalles.</div>
            <div id="audio-settings" style="margin:10px 0; display:flex; align-items:center; gap:20px;">
                <label>Velocidad: <input type="range" id="speed-slider" min="0.5" max="2" step="0.1" value="1"><span id="speed-value">1</span>x</label>
            </div>
            <div id="dropdowns" style="display:flex; gap:10px; align-items:center; margin-bottom:20px;">
                <div class="dropdown">
                    <button id="book-dropdown-btn" class="dropdown-btn">Libro: <span id="book-dropdown-label">Seleccione</span> ‚ñº</button>
                    <ul id="book-dropdown-list" class="dropdown-list"></ul>
                </div>
                <div class="dropdown">
                    <button id="chapter-dropdown-btn" class="dropdown-btn">Cap√≠tulo: <span id="chapter-dropdown-label">1</span> ‚ñº</button>
                    <ul id="chapter-dropdown-list" class="dropdown-list"></ul>
                </div>
            </div>
            <ul id="chapters-list" class="select-css" style="list-style:none;padding:0;"></ul>
            <div id="player-controls" style="display:none;">
                <div class="audio-cover"><img src="icons/pymicon.png" alt="Cover"></div>
                <h3 id="now-playing"></h3>
                <input type="range" id="seek-slider" class="seek-slider" min="0" max="100" value="0" step="0.1">
                <div class="time-display"><span id="current-time">0:00</span><span id="duration">0:00</span></div>
                <div class="player-buttons">
                    <button id="prev-reading" class="player-button" title="Anterior"><i class="fas fa-backward"></i></button>
                    <button id="play-pause" class="player-button" title="Play/Pause"><i class="fas fa-play"></i></button>
                    <button id="next-reading" class="player-button" title="Siguiente"><i class="fas fa-forward"></i></button>
                </div>
                <audio id="audio-player" playsinline style="display:none;"></audio>
            </div>
        </div>
    </div>
    <script>
        // Mapa de c√≥digos a nombres completos global
        const bookDisplayNames = {
            'genesis': 'G√©nesis', 'exodus': '√âxodo', 'lev': 'Lev√≠tico', 'num': 'N√∫meros', 'deu': 'Deuteronomio',
            'joshua': 'Josu√©', 'judges': 'Jueces', 'ruth': 'Rut', '1sam': '1 Samuel', '2sam': '2 Samuel',
            '1kin': '1 Reyes', '2kin': '2 Reyes', '1chron': '1 Cr√≥nicas', '2chron': '2 Cr√≥nicas',
            'ezra': 'Esdras', 'nehemiah': 'Nehem√≠as', 'esther': 'Ester', 'job': 'Job', 'psalm': 'Salmos',
            'proverbs': 'Proverbios', 'ecc': 'Eclesiast√©s', 'song': 'Cantar de los Cantares', 'wisdom': 'Sabidur√≠a',
            'sirach': 'Eclesi√°stico', 'isaiah': 'Isa√≠as', 'jere': 'Jerem√≠as', 'lam': 'Lamentaciones', 'ezek': 'Ezequiel',
            'dan': 'Daniel', 'hosea': 'Oseas', 'joel': 'Joel', 'amos': 'Am√≥s', 'oba': 'Abd√≠as', 'jonah': 'Jon√°s',
            'micah': 'Miqueas', 'nahum': 'Nah√∫m', 'habak': 'Habacuc', 'haggai': 'Hageo', 'zeph': 'Sofon√≠as',
            'zech': 'Zacar√≠as', 'mal': 'Malaqu√≠as', 'matt': 'Mateo', 'mark': 'Marcos', 'luke': 'Lucas',
            'john': 'Juan', 'acts': 'Hechos de los Ap√≥stoles', 'romans': 'Romanos', '1cor': '1 Corintios',
            '2cor': '2 Corintios', 'gal': 'G√°latas', 'eph': 'Efesios', 'phil': 'Filipenses', 'phi': 'Filem√≥n',
            'col': 'Colosenses', '1the': '1 Tesalonicenses', '2the': '2 Tesalonicenses',
            '1tim': '1 Timoteo', '2tim': '2 Timoteo', 'tit': 'Tito',
            'heb': 'Hebreos', 'jam': 'Santiago',
            '1pet': '1 Pedro', '2pet': '2 Pedro', '1joh': '1 Juan', '2joh': '2 Juan', '3joh': '3 Juan',
            'jude': 'Judas', 'rev': 'Apocalipsis'
        };
        // Mapa de metadatos de libros para descripci√≥n (autor, fecha, tema, descripci√≥n, temas clave)
        const bookMeta = {
            'genesis': {
                author: 'Mois√©s',
                date: '1445-1405 a.C.',
                theme: 'Los or√≠genes y el pacto de Dios',
                description: 'El libro del G√©nesis narra la creaci√≥n del mundo, la ca√≠da del hombre, el diluvio universal y las historias de los patriarcas Abraham, Isaac y Jacob. Establece los fundamentos de la relaci√≥n entre Dios y la humanidad.',
                keyTopics: ['La Creaci√≥n', 'El Diluvio', 'Abraham y el Pacto', 'Jos√© en Egipto']
            },
            'tit': {
                author: 'Pablo',
                date: 'c. 63-65 d.C.',
                theme: 'Organizaci√≥n de la Iglesia y Conducta Cristiana',
                description: 'La carta a Tito contiene instrucciones pastorales para el liderazgo de la iglesia en Creta y la conducta de los creyentes.',
                keyTopics: ['Liderazgo Pastoral', 'Car√°cter Cristiano', 'Vida en Comunidad']
            }
        };
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        const audioPlayer = document.getElementById('audio-player');
        const chaptersListEl = document.getElementById('chapters-list');
        const bookSearch = document.getElementById('book-search');
        const bookTitleEl = document.getElementById('book-title');
        const bookInfoEl = document.getElementById('book-info');
        const menuToggle = document.getElementById('menu-toggle');
        const menuPanel = document.getElementById('menu-panel');
        const menuSearch = document.getElementById('menu-search');
        const menuBooksListEl = document.getElementById('menu-books-list');
        console.log('Audio page script loaded');
        // Filtrar lista de libros por b√∫squeda
        bookSearch.oninput = () => {
            const filter = bookSearch.value.toLowerCase();
            Array.from(booksListEl.children).forEach(li => {
                li.style.display = li.textContent.toLowerCase().includes(filter) ? '' : 'none';
            });
        };
        menuToggle.onclick = () => menuPanel.classList.toggle('open');
        menuSearch.oninput = () => {
            const filter = menuSearch.value.toLowerCase();
            Array.from(menuBooksListEl.children).forEach(li => {
                li.style.display = li.textContent.toLowerCase().includes(filter) ? '' : 'none';
            });
        };
        // Mostrar indicador inicial de carga
        const booksListEl = document.getElementById('books-list');
        booksListEl.innerHTML = '<li>Cargando libros...</li>';
        let xmlDoc, manifestData, playlist = [], trackIndex = 0, currentBookName, currentBookNode;

        // Actualizar velocidad
        speedSlider.oninput = () => speedValue.textContent = speedSlider.value;

        // Orden can√≥nico de los libros
        const bibleOrder = ['genesis','exodus','lev','num','deu','joshua','judges','ruth','1sam','2sam','1kin','2kin','1chron','2chron','ezra','nehemiah','esther','job','psalm','proverbs','ecc','song','wisdom','sirach','isaiah','jere','lam','ezek','dan','hosea','joel','amos','oba','jonah','micah','nahum','habak','haggai','zeph','zech','mal','matt','mark','luke','john','acts','romans','1cor','2cor','gal','eph','phil','phi','col','1the','2the','1tim','2tim','tit','heb','jam','1pet','2pet','1joh','2joh','3joh','jude','rev'];

        // Cargar lista de libros desde el manifest.json din√°mico
        async function loadBooks() {
            try {
                const res = await fetch('audio/manifest.json');
                if (!res.ok) throw new Error(res.statusText);
                const manifest = await res.json();
                manifestData = manifest;
                // extraer c√≥digos √∫nicos (abreviaciones)
                let codes = [...new Set(manifest.map(item => item.name.split(/[-_]/)[0].toLowerCase()))];
                codes.sort((a,b) => bibleOrder.indexOf(a) - bibleOrder.indexOf(b));
                booksListEl.innerHTML = '';
                menuBooksListEl.innerHTML = '';
                chaptersListEl.innerHTML = '';
                bookTitleEl.textContent = 'Informaci√≥n del libro';
                bookInfoEl.innerHTML = 'Selecciona un libro para ver detalles.';
                codes.forEach(code => {
                    const li = document.createElement('li');
                    li.style.cursor = 'pointer';
                    li.textContent = bookDisplayNames[code] || code;
                    li.onclick = () => loadChaptersForBook(code, manifest);
                    booksListEl.appendChild(li);
                });
                // populate floating menu list
                codes.forEach(code => {
                    const mli = document.createElement('li');
                    mli.style.cursor = 'pointer';
                    mli.textContent = bookDisplayNames[code] || code;
                    mli.onclick = () => {
                        loadChaptersForBook(code, manifest);
                        menuPanel.classList.remove('open');
                        // Auto-play cap√≠tulo 1
                        const first = manifest.find(item => item.name === `${code}-1`);
                        if (first) playCustom(`${bookDisplayNames[code]} 1`, `audio/${first.file}`);
                    };
                    menuBooksListEl.appendChild(mli);
                });
                // Inicializar dropdown de libros tras cargar manifest
                setupDropdowns();
            } catch (err) {
                console.error('Error cargando manifest:', err);
                booksListEl.innerHTML = '<li>Error cargando audio</li>';
            }
        }

        // Mostrar cap√≠tulos de un libro seleccionado
        function loadChaptersForBook(code, manifest) {
            // Filtrar archivos cuyo nombre de archivo (item.file) comience con el c√≥digo y separador '_'
            const chapters = manifest
                .filter(item => item.file.startsWith(code + '_'))
                .sort((a, b) => {
                    const numA = parseInt(a.file.match(/_(\d+)/)[1]);
                    const numB = parseInt(b.file.match(/_(\d+)/)[1]);
                    return numA - numB;
                });
            chaptersListEl.innerHTML = '';
            showBookInfo(code, chapters);
            chapters.forEach(item => {
                const chapNum = item.file.match(/_(\d+)/)[1];
                const li = document.createElement('li');
                li.style.cursor = 'pointer';
                li.textContent = chapNum;
                li.onclick = () => playCustom(`${bookDisplayNames[code]} ${chapNum}`, `audio/${item.file}`);
                chaptersListEl.appendChild(li);
            });
            setupChapterDropdown();
        }

        // Reproducci√≥n de libro (solo MP3)
        function playBook(bookName, bookNode) {
            currentBookName = bookName;
            currentBookNode = bookNode;
            document.getElementById('now-playing').textContent = 'Escuchando ' + bookName;
            document.getElementById('player-controls').style.display = '';
            const chapters = Array.from(bookNode.getElementsByTagName('c'));
            playlist = chapters.map(c => {
                const chap = c.getAttribute('n');
                return `audio/${encodeURIComponent(bookName)}-${chap}.mp3`;
            });
            trackIndex = 0;
            audioPlayer.style.display = '';
            audioPlayer.playbackRate = parseFloat(speedSlider.value);
            audioPlayer.src = playlist[trackIndex];
            audioPlayer.play().catch(err => console.error('Error MP3:', err));
        }

        function playCustom(name, src) {
            console.log('playCustom src:', src);
            // Construir playlist completo del libro
            const fileName = src.split('/').pop();
            const [code] = fileName.replace('.mp3','').split(/[-_]/);
            const chapters = manifestData
                .filter(item => item.file.startsWith(code + '_'))
                .sort((a,b) => parseInt(a.file.match(/_(\d+)/)[1]) - parseInt(b.file.match(/_(\d+)/)[1]));
            playlist = chapters.map(item => `audio/${item.file}`);
            trackIndex = playlist.indexOf(src);
            // Mostrar y reproducir en cadena
            document.getElementById('now-playing').textContent = 'Escuchando ' + name;
            document.getElementById('player-controls').style.display = 'block';
            audioPlayer.style.display = 'block';
            audioPlayer.playbackRate = parseFloat(speedSlider.value);
            audioPlayer.src = playlist[trackIndex];
            audioPlayer.play().catch(err => console.error('Error MP3:', err));
        }

        // Funci√≥n para reproducir track y actualizar indicador
        function playTrack(index) {
            const src = playlist[index];
            audioPlayer.src = src;
            const fileName = src.split('/').pop().replace('.mp3','');
            const parts = fileName.includes('-') ? fileName.split('-') : fileName.split('_');
            const code = parts[0], chap = parts[1];
            document.getElementById('now-playing').textContent = `Escuchando ${bookDisplayNames[code]} ${chap}`;
            audioPlayer.play();
        }

        // Controles pausa y stop
        document.getElementById('prev-reading').onclick = () => {
            if (trackIndex > 0) { trackIndex--; playTrack(trackIndex); }
        };
        document.getElementById('next-reading').onclick = () => {
            if (trackIndex < playlist.length - 1) { trackIndex++; playTrack(trackIndex); }
        };
        document.getElementById('stop-reading').onclick = () => {
            audioPlayer.pause(); audioPlayer.currentTime = 0;
            document.getElementById('player-controls').style.display = 'none';
        };
        // MP3 cambia track
        audioPlayer.addEventListener('ended', () => {
            if (trackIndex < playlist.length - 1) {
                trackIndex++;
                playTrack(trackIndex);
            }
        });
        // Play/Pause toggle
        const playPauseBtn = document.getElementById('play-pause');
        playPauseBtn.onclick = () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                audioPlayer.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        };
        // Seek slider and time update
        const seekSlider = document.getElementById('seek-slider');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        function formatTime(sec) {
            const m = Math.floor(sec/60);
            const s = String(Math.floor(sec%60)).padStart(2, '0');
            return `${m}:${s}`;
        }
        audioPlayer.addEventListener('loadedmetadata', () => {
            seekSlider.max = audioPlayer.duration;
            durationEl.textContent = formatTime(audioPlayer.duration);
        });
        audioPlayer.addEventListener('timeupdate', () => {
            seekSlider.value = audioPlayer.currentTime;
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        });
        seekSlider.oninput = () => {
            audioPlayer.currentTime = seekSlider.value;
        };
        // Iniciar lista y reproducci√≥n
        loadBooks();
        // Funci√≥n para mostrar info del libro con detalles
        function showBookInfo(code, chapters) {
            const key = code.toLowerCase();
            bookTitleEl.textContent = `Libro: ${bookDisplayNames[key] || code}`;
            const meta = bookMeta[key];
            if (meta) {
                bookInfoEl.innerHTML = `
                    <p>Autor: ${meta.author}</p>
                    <p>Fecha: ${meta.date}</p>
                    <p>Tema: ${meta.theme}</p>
                    <p>${meta.description}</p>
                    <p>Temas Clave: ${meta.keyTopics.join(' ¬∑ ')}</p>
                `;
            } else {
                bookInfoEl.innerHTML = `<p>N√∫mero de cap√≠tulos: ${chapters.length}</p>`;
            }
        }
        // Funciones dropdowns
        function setupDropdowns() {
            const list = document.getElementById('book-dropdown-list');
            const lbl = document.getElementById('book-dropdown-label');
            const btn = document.getElementById('book-dropdown-btn');
            list.innerHTML = '';
            // Solo c√≥digos disponibles en el manifest (ej. 'tit', no 'titus')
            const codes = [...new Set(manifestData.map(item => item.name))];
            // Orden can√≥nico seg√∫n bibleOrder
            codes.sort((a, b) => bibleOrder.indexOf(a) - bibleOrder.indexOf(b));
            codes.forEach(code => {
                const li = document.createElement('li');
                li.textContent = bookDisplayNames[code] || code;
                li.onclick = () => {
                    loadChaptersForBook(code, manifestData);
                    lbl.textContent = bookDisplayNames[code] || code;
                    list.style.display = 'none';
                    // Auto-play cap√≠tulo 1
                    const firstItem = manifestData.find(item => item.name === code && item.file.startsWith(code + '_1'));
                    if (firstItem) {
                        playCustom(`${bookDisplayNames[code] || code} 1`, `audio/${firstItem.file}`);
                    }
                };
                list.appendChild(li);
            });
            btn.onclick = () => list.style.display = list.style.display === 'block' ? 'none' : 'block';
        }
        function setupChapterDropdown() {
            const list = document.getElementById('chapter-dropdown-list');
            const btn = document.getElementById('chapter-dropdown-btn');
            list.innerHTML = '';
            document.querySelectorAll('#chapters-list li').forEach(el => {
                const num = el.textContent;
                const li = document.createElement('li');
                li.textContent = num;
                li.onclick = () => {
                    document.getElementById('chapter-dropdown-label').textContent = num;
                    el.click();
                    list.style.display = 'none';
                };
                list.appendChild(li);
            });
            btn.onclick = () => list.style.display = list.style.display === 'block' ? 'none' : 'block';
        }
    </script>
</body>
</html>
