<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escuchar Biblia - Biblia de Poder y Milagros</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="apple-touch-icon" href="icons/pymicon.png">
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Audio page mobile modern layout */
        body { margin: 0; background: #121212; color: #fff; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        #player-controls { position: relative; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 20px; box-sizing: border-box; overflow: hidden; }
        #player-controls::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('icons/pymicon.png') center/cover no-repeat; filter: blur(20px) brightness(40%); z-index: -1; }
        .audio-cover { width: 200px; height: 200px; border-radius: 50%; overflow: hidden; margin: 40px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.5); background-color: #fff; }
        .audio-cover img { width: 100%; height: 100%; object-fit: contain; object-position: center center; }
        .player-header { font-size: 1.2em; margin: 20px 0 10px; }
        .seek-slider { width: calc(100% - 40px); accent-color: #1DB954; margin: 0 20px; }
        .time-display { display: flex; justify-content: space-between; width: calc(100% - 40px); font-size: 0.9em; margin: 10px 20px; }
        .player-buttons { display: flex !important; justify-content: center; align-items: center; gap: 30px; visibility: visible !important; opacity: 1 !important; }
        .player-button { background: none; border: none; color: #fff; font-size: 2em; width: 60px; height: 60px; cursor: pointer; display: block !important; visibility: visible !important; }
        .player-button:hover { color: #1DB954; }
        /* Menú lateral */
        .side-menu { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background: #121212; color: #fff; box-shadow: 2px 0 8px rgba(0,0,0,0.5); transition: left 0.3s ease; z-index: 1001; }
        .side-menu.active { left: 0; }
        .side-menu ul { list-style: none; padding: 20px; margin: 0; }
        .side-menu ul li { padding: 10px 0; cursor: pointer; }
        .side-menu ul li:hover { background: rgba(255,255,255,0.1); }
        .side-menu-toggle { background: none; border: none; font-size: 2em; color: #fff; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 8px; }
        .side-menu-toggle:hover { background-color: rgba(255,255,255,0.1); border-radius: 50%; }
        
        /* Forzar visibilidad de botones */
        #prev-reading, #play-pause, #next-reading {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 9999 !important;
            width: 60px !important;
            height: 60px !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border-radius: 50% !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
        }
        
        #prev-reading:hover, #play-pause:hover, #next-reading:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
        }
        
        /* Forzar contenedor de botones */
        .player-buttons {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 9999 !important;
            background: rgba(0, 0, 0, 0.3) !important;
            padding: 15px !important;
            border-radius: 15px !important;
        }
    </style>
</head>
<body>
    <!-- Menú lateral -->
    <div id="side-menu" class="side-menu">
        <ul>
            <li onclick="window.location.href='index.html'">Página principal</li>
            <li onclick="window.location.href='lectura.html'">Leer Biblia</li>
            <li onclick="window.location.href='audio.html'">Escuchar</li>
            <li onclick="window.location.href='memorizados.html'">Memorizados</li>
            <li onclick="window.location.href='historias.html'">Historias</li>
            <li onclick="window.location.href='diccionario.html'">Diccionario</li>
            <li onclick="window.location.href='bookmarks.html'">Marcados</li>
            <li onclick="window.location.href='comments.html'">Comentarios</li>
            <li onclick="window.location.href='temas.html'">Temas</li>
        </ul>
    </div>
    <div class="controls" id="controls">
        <div class="top-row">
            <button id="side-menu-toggle" class="side-menu-toggle">☰</button>
            <!-- Book and Chapter selectors -->
            <div class="selects" style="display:flex; gap:10px; align-items:center; margin-left:20px;">
                <select id="book-select" style="padding:8px;border-radius:4px;background:#fff;color:#000;">
                    <option disabled selected>Selecciona un libro</option>
                </select>
                <select id="chapter-select" disabled style="padding:8px;border-radius:4px;background:#fff;color:#000;">
                    <option disabled selected>Selecciona un capítulo</option>
                </select>
            </div>
        </div>
    </div>
    <div class="audio-container" style="margin-top:80px; padding:20px;">
        <div class="main" style="width:100%;">
            <!-- Player controls -->
            <div id="player-controls" style="display:flex; flex-direction:column; align-items:center; padding:20px; background:rgba(0,0,0,0.8); border-radius:10px; min-height:400px;">
                <div class="audio-cover" style="width:150px; height:150px; border-radius:50%; overflow:hidden; margin-bottom:15px; background:#fff;">
                    <img src="logo-blanco.png" alt="Cover" style="width:100%; height:100%; object-fit:contain;">
                </div>
                <h3 id="now-playing" style="color:#fff; margin:10px 0; text-shadow:0 0 5px rgba(255,255,255,0.5);">Selecciona un libro para comenzar</h3>
                <input type="range" id="seek-slider" style="width:100%; margin:10px 0;" min="0" max="100" value="0" step="0.1">
                <div class="time-display" style="display:flex; justify-content:space-between; width:100%; color:#fff; margin-bottom:15px;">
                    <span id="current-time">0:00</span>
                    <span id="duration">0:00</span>
                </div>
                <div class="player-buttons" style="display:flex !important; justify-content:center; align-items:center; gap:30px; visibility:visible !important; opacity:1 !important;">
                    <button id="prev-reading" class="player-button" style="background:none; border:none; color:#fff; font-size:2em; cursor:pointer; padding:10px; text-shadow:0 0 5px rgba(255,255,255,0.5); display:block !important; visibility:visible !important;" title="Anterior">
                        <i class="fas fa-backward"></i>
                    </button>
                    <button id="play-pause" class="player-button" style="background:none; border:none; color:#fff; font-size:2.5em; cursor:pointer; padding:10px; text-shadow:0 0 5px rgba(255,255,255,0.5); display:block !important; visibility:visible !important;" title="Play/Pause">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="next-reading" class="player-button" style="background:none; border:none; color:#fff; font-size:2em; cursor:pointer; padding:10px; text-shadow:0 0 5px rgba(255,255,255,0.5); display:block !important; visibility:visible !important;" title="Siguiente">
                        <i class="fas fa-forward"></i>
                    </button>
                </div>
                <audio id="audio-player" playsinline style="display:none;"></audio>
            </div>
        </div>
    </div>
    <script>
        // Configuración de rutas
        const AUDIO_BASE_PATH = window.location.hostname === 'localhost' ? '' : '/biblia-poder-milagros';
        
        // Mapa de códigos a nombres completos global
        const bookDisplayNames = {
            'genesis': 'Génesis', 'exodus': 'Éxodo', 'lev': 'Levítico', 'num': 'Números', 'deu': 'Deuteronomio',
            'joshua': 'Josué', 'judges': 'Jueces', 'ruth': 'Rut', '1sam': '1 Samuel', '2sam': '2 Samuel',
            '1kin': '1 Reyes', '2kin': '2 Reyes', '1chron': '1 Crónicas', '2chron': '2 Crónicas',
            'ezra': 'Esdras', 'nehemiah': 'Nehemías', 'esther': 'Ester', 'job': 'Job', 'psalm': 'Salmos',
            'proverbs': 'Proverbios', 'ecc': 'Eclesiastés', 'song': 'Cantar de los Cantares', 'wisdom': 'Sabiduría',
            'sirach': 'Eclesiástico', 'isaiah': 'Isaías', 'jere': 'Jeremías', 'lam': 'Lamentaciones', 'ezek': 'Ezequiel',
            'dan': 'Daniel', 'hosea': 'Oseas', 'joel': 'Joel', 'amos': 'Amós', 'oba': 'Abdías', 'jonah': 'Jonás',
            'micah': 'Miqueas', 'nahum': 'Nahúm', 'habak': 'Habacuc', 'haggai': 'Hageo', 'zeph': 'Sofonías',
            'zech': 'Zacarías', 'mal': 'Malaquías', 'matt': 'Mateo', 'mark': 'Marcos', 'luke': 'Lucas',
            'john': 'Juan', 'acts': 'Hechos de los Apóstoles', 'romans': 'Romanos', '1cor': '1 Corintios',
            '2cor': '2 Corintios', 'gal': 'Gálatas', 'eph': 'Efesios', 'phil': 'Filipenses', 'phi': 'Filemón',
            'col': 'Colosenses', '1the': '1 Tesalonicenses', '2the': '2 Tesalonicenses',
            '1tim': '1 Timoteo', '2tim': '2 Timoteo', 'tit': 'Tito',
            'heb': 'Hebreos', 'jam': 'Santiago',
            '1pet': '1 Pedro', '2pet': '2 Pedro', '1joh': '1 Juan', '2joh': '2 Juan', '3joh': '3 Juan',
            'jude': 'Judas', 'rev': 'Apocalipsis'
        };

        const audioPlayer = document.getElementById('audio-player');
        console.log('Audio page script loaded');
        
        // Get book <select>
        const bookSelect = document.getElementById('book-select');
        const chapterSelect = document.getElementById('chapter-select');
        
        // Orden canónico de los libros
        const bibleOrder = ['genesis','exodus','lev','num','deu','joshua','judges','ruth','1sam','2sam','1kin','2kin','1chron','2chron','ezra','nehemiah','esther','job','psalm','proverbs','ecc','song','wisdom','sirach','isaiah','jere','lam','ezek','dan','hosea','joel','amos','oba','jonah','micah','nahum','habak','haggai','zeph','zech','mal','matt','mark','luke','john','acts','romans','1cor','2cor','gal','eph','phil','phi','col','1the','2the','1tim','2tim','tit','heb','jam','1pet','2pet','1joh','2joh','3joh','jude','rev'];

        // Cargar lista de libros desde el manifest.json dinámico
        async function loadBooks() {
            try {
                const res = await fetch('audio/manifest.json');
                if (!res.ok) throw new Error(res.statusText);
                const manifest = await res.json();
                
                // Store manifest globally
                manifestData = manifest;
                
                // Get book <select>
                const bookSelect = document.getElementById('book-select');
                const chapterSelect = document.getElementById('chapter-select');
                
                // Populate native book <select> en orden bíblico
                const codes = [...new Set(manifest.map(item => item.name))];
                codes.sort((a,b) => bibleOrder.indexOf(a) - bibleOrder.indexOf(b));
                
                // Clear existing options
                bookSelect.innerHTML = '<option disabled selected>Selecciona un libro</option>';
                codes.forEach(code => {
                    const opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = bookDisplayNames[code] || code;
                    bookSelect.appendChild(opt);
                });
                
                // On book selection, populate chapter-select and play first
                bookSelect.onchange = () => {
                    const code = bookSelect.value;
                    localStorage.setItem('audio-last-book', code);
                    
                    const chapters = manifestData
                        .filter(item => item.name === code)
                        .sort((a, b) => parseInt(a.file.match(/_(\d+)/)[1]) - parseInt(b.file.match(/_(\d+)/)[1]));
                    
                    chapterSelect.disabled = false;
                    chapterSelect.innerHTML = '<option disabled selected>Selecciona un capítulo</option>';
                    chapters.forEach(item => {
                        const num = item.file.match(/_(\d+)/)[1];
                        const opt = document.createElement('option');
                        opt.value = item.file;
                        opt.textContent = (bookDisplayNames[code] || code) + ' ' + num;
                        chapterSelect.appendChild(opt);
                    });
                    
                    if (chapters.length > 0) {
                        const first = chapters[0];
                        const num = first.file.match(/_(\d+)/)[1];
                        playCustom(`${bookDisplayNames[code] || code} ${num}`, `${AUDIO_BASE_PATH}/audio/${first.file}`, code, first.file);
                    }
                    
                    // Guardar la función onchange en una variable para evitar duplicados
                    if (chapterSelect._onchange) {
                        chapterSelect.removeEventListener('change', chapterSelect._onchange);
                    }
                    
                    const onChapterChange = (e) => {
                        const file = e.target.value;
                        console.log('Cambio de capítulo:', file);
                        if (!file) {
                            console.error('No se seleccionó ningún archivo');
                            return;
                        }
                        
                        localStorage.setItem('audio-last-book', code);
                        localStorage.setItem('audio-last-file', file);
                        const num = file.match(/_(\d+)/)[1];
                        const bookName = bookDisplayNames[code] || code;
                        const audioPath = `${AUDIO_BASE_PATH}/audio/${file}`;
                        
                        console.log('Reproduciendo:', bookName, num, audioPath);
                        playCustom(`${bookName} ${num}`, audioPath, code, file);
                    };
                    
                    chapterSelect.addEventListener('change', onChapterChange);
                    chapterSelect._onchange = onChapterChange;
                };
                
                // Restore last selection if exists
                const lastBook = localStorage.getItem('audio-last-book');
                const lastFile = localStorage.getItem('audio-last-file');
                const lastPosition = localStorage.getItem('audio-last-position');
                
                if (lastBook && lastFile) {
                    bookSelect.value = lastBook;
                    bookSelect.onchange();
                    if (lastFile) {
                        setTimeout(() => {
                            chapterSelect.value = lastFile;
                            chapterSelect.dispatchEvent(new Event('change'));
                            // Restaurar posición y reproducir automáticamente
                            if (lastPosition) {
                                setTimeout(() => {
                                    audioPlayer.currentTime = parseFloat(lastPosition);
                                    // Auto-reproducir después de restaurar posición
                                    audioPlayer.play().then(() => {
                                        document.getElementById('play-pause').innerHTML = '<i class="fas fa-pause"></i>';
                                    }).catch(err => {
                                        console.log('Auto-play bloqueado, esperando interacción del usuario');
                                    });
                                }, 1000);
                            } else {
                                // Auto-reproducir incluso sin posición guardada
                                setTimeout(() => {
                                    audioPlayer.play().then(() => {
                                        document.getElementById('play-pause').innerHTML = '<i class="fas fa-pause"></i>';
                                    }).catch(err => {
                                        console.log('Auto-play bloqueado, esperando interacción del usuario');
                                    });
                                }, 500);
                            }
                        }, 100);
                    }
                }
            } catch (e) {
                console.error('Error cargando libros:', e);
                alert('Error cargando lista de libros. Por favor, recarga la página.');
            }
        }

        // Variables globales para el reproductor
        let manifestData, currentPlaylist = [], currentTrackIndex = 0;

        // Función para reproducir audio
        function playCustom(name, src, bookCode, chapterFile) {
            document.getElementById('now-playing').textContent = name;
            audioPlayer.src = src;
            audioPlayer.play().catch(err => console.error('Error MP3:', err));
            document.getElementById('play-pause').innerHTML = '<i class="fas fa-pause"></i>';

            // Actualizar currentPlaylist para navegación
            if (bookCode && manifestData) {
                currentPlaylist = manifestData
                    .filter(item => item.name === bookCode)
                    .sort((a, b) => parseInt(a.file.match(/_(\d+)/)[1]) - parseInt(b.file.match(/_(\d+)/)[1]))
                    .map(item => `${AUDIO_BASE_PATH}/audio/${item.file}`);
                currentTrackIndex = currentPlaylist.findIndex(path => path === src);
            }
        }

        // Controles de navegación
        document.getElementById('prev-reading').onclick = () => {
            if (currentTrackIndex > 0) {
                currentTrackIndex--;
                const prevSrc = currentPlaylist[currentTrackIndex];
                const fileName = prevSrc.split('/').pop().replace('.mp3','');
                const parts = fileName.split('_');
                const code = parts[0];
                const chapNum = parts[1]; // Obtener el número del capítulo
                
                const bookCode = localStorage.getItem('audio-last-book');
                playCustom(`${bookDisplayNames[code] || code} ${chapNum}`, prevSrc, bookCode, fileName + '.mp3');
                
                // Actualizar selector de capítulos
                const chapterSelect = document.getElementById('chapter-select');
                chapterSelect.value = fileName + '.mp3';
            }
        };
        
        document.getElementById('next-reading').onclick = () => {
            if (currentTrackIndex < currentPlaylist.length - 1) {
                currentTrackIndex++;
                const nextSrc = currentPlaylist[currentTrackIndex];
                const fileName = nextSrc.split('/').pop().replace('.mp3','');
                const parts = fileName.split('_');
                const code = parts[0];
                const chapNum = parts[1]; // Obtener el número del capítulo
                
                const bookCode = localStorage.getItem('audio-last-book');
                playCustom(`${bookDisplayNames[code] || code} ${chapNum}`, nextSrc, bookCode, fileName + '.mp3');
                
                // Actualizar selector de capítulos
                const chapterSelect = document.getElementById('chapter-select');
                chapterSelect.value = fileName + '.mp3';
            }
        };
        
        // Play/Pause toggle
        const playPauseBtn = document.getElementById('play-pause');
        playPauseBtn.onclick = () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                audioPlayer.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        };
        
        // Seek slider and time update
        const seekSlider = document.getElementById('seek-slider');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        
        function formatTime(sec) {
            const m = Math.floor(sec/60);
            const s = String(Math.floor(sec%60)).padStart(2, '0');
            return `${m}:${s}`;
        }
        
        audioPlayer.addEventListener('loadedmetadata', () => {
            if (isFinite(audioPlayer.duration) && !isNaN(audioPlayer.duration)) {
                seekSlider.max = Math.floor(audioPlayer.duration);
                durationEl.textContent = formatTime(audioPlayer.duration);
            }
        });
        
        audioPlayer.addEventListener('timeupdate', () => {
            seekSlider.value = audioPlayer.currentTime;
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            // Guardar posición actual
            localStorage.setItem('audio-last-position', audioPlayer.currentTime.toString());
        });
        
        seekSlider.oninput = () => {
            audioPlayer.currentTime = seekSlider.value;
        };
        
        // Auto-avanzar al siguiente capítulo
        audioPlayer.addEventListener('ended', () => {
            if (currentTrackIndex < currentPlaylist.length - 1) {
                document.getElementById('next-reading').click();
            }
        });
        
        // Manejar errores
        audioPlayer.addEventListener('error', (e) => {
            console.error('Error al cargar el audio:', e);
            console.error('Ruta del audio:', audioPlayer.src);
            alert('Error al cargar el audio. Por favor, verifica la consola para más detalles.');
        });
        
        // Iniciar lista y reproducción
        loadBooks();
        
        // Forzar visibilidad de botones
        setTimeout(() => {
            const buttons = document.querySelectorAll('#prev-reading, #play-pause, #next-reading');
            const container = document.querySelector('.player-buttons');
            
            if (buttons.length > 0) {
                console.log('Forzando visibilidad de botones...');
                
                // Forzar cada botón individualmente
                buttons.forEach(btn => {
                    btn.style.display = 'block !important';
                    btn.style.visibility = 'visible !important';
                    btn.style.opacity = '1 !important';
                    btn.style.position = 'relative !important';
                    btn.style.zIndex = '9999 !important';
                    btn.style.width = '60px !important';
                    btn.style.height = '60px !important';
                    btn.style.background = 'rgba(255, 255, 255, 0.1) !important';
                    btn.style.border = '2px solid rgba(255, 255, 255, 0.3) !important';
                    btn.style.borderRadius = '50% !important';
                });
                
                // Forzar contenedor
                if (container) {
                    container.style.display = 'flex !important';
                    container.style.visibility = 'visible !important';
                    container.style.opacity = '1 !important';
                    container.style.position = 'relative !important';
                    container.style.zIndex = '9999 !important';
                    container.style.background = 'rgba(0, 0, 0, 0.3) !important';
                    container.style.padding = '15px !important';
                    container.style.borderRadius = '15px !important';
                }
                
                console.log('Botones forzados:', buttons.length, 'Contenedor:', !!container);
            } else {
                console.error('No se encontraron los botones');
            }
        }, 1000);
    </script>
    <script>
        // Menu functionality
        const menuBtn = document.getElementById('side-menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        if (menuBtn) menuBtn.addEventListener('click', () => sideMenu.classList.toggle('active'));
        document.addEventListener('click', e => {
            if (sideMenu.classList.contains('active') && !sideMenu.contains(e.target) && !menuBtn.contains(e.target)) {
                sideMenu.classList.remove('active');
            }
        });
    </script>
</body>
</html>
