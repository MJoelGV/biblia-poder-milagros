<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escuchar Biblia - Biblia de Poder y Milagros</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="apple-touch-icon" href="icons/pymicon.png">
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Audio page mobile modern layout */
        body { margin: 0; background: #121212; color: #fff; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        #player-controls { position: relative; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 20px; box-sizing: border-box; overflow: hidden; }
        #player-controls::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('icons/pymicon.png') center/cover no-repeat; filter: blur(20px) brightness(40%); z-index: -1; }
        .audio-cover { width: 200px; height: 200px; border-radius: 50%; overflow: hidden; margin: 40px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.5); background-color: #fff; }
        .audio-cover img { width: 100%; height: 100%; object-fit: contain; object-position: center center; }
        .player-header { font-size: 1.2em; margin: 20px 0 10px; }
        .seek-slider { width: calc(100% - 40px); accent-color: #1DB954; margin: 0 20px; }
        .time-display { display: flex; justify-content: space-between; width: calc(100% - 40px); font-size: 0.9em; margin: 10px 20px; }
        .player-buttons { display: flex; justify-content: center; align-items: center; gap: 40px; margin-bottom: 30px; }
        .player-button { background: none; border: none; color: #fff; font-size: 2em; width: 60px; height: 60px; cursor: pointer; }
        .player-button:hover { color: #1DB954; }
        /* Menú lateral */
        .side-menu { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background: #121212; color: #fff; box-shadow: 2px 0 8px rgba(0,0,0,0.5); transition: left 0.3s ease; z-index: 1001; }
        .side-menu.active { left: 0; }
        .side-menu ul { list-style: none; padding: 20px; margin: 0; }
        .side-menu ul li { padding: 10px 0; cursor: pointer; }
        .side-menu ul li:hover { background: rgba(255,255,255,0.1); }
        .side-menu-toggle { background: none; border: none; font-size: 2em; color: #fff; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 8px; }
        .side-menu-toggle:hover { background-color: rgba(255,255,255,0.1); border-radius: 50%; }
    </style>
</head>
<body>
    <!-- Menú lateral -->
    <div id="side-menu" class="side-menu">
        <ul>
            <li onclick="window.location.href='index.html'">Página principal</li>
            <li onclick="window.location.href='lectura.html'">Leer Biblia</li>
            <li onclick="window.location.href='audio.html'">Escuchar</li>
            <li onclick="window.location.href='memorizados.html'">Memorizados</li>
            <li onclick="window.location.href='historias.html'">Historias</li>
            <li onclick="window.location.href='diccionario.html'">Diccionario</li>
            <li onclick="window.location.href='bookmarks.html'">Marcados</li>
            <li onclick="window.location.href='comments.html'">Comentarios</li>
            <li onclick="window.location.href='temas.html'">Temas</li>
        </ul>
    </div>
    <div class="controls" id="controls">
        <div class="top-row">
            <button id="side-menu-toggle" class="side-menu-toggle">☰</button>
            <!-- Book and Chapter selectors -->
            <div class="selects" style="display:flex; gap:10px; align-items:center; margin-left:20px;">
                <select id="book-select" style="padding:8px;border-radius:4px;background:#fff;color:#000;">
                    <option disabled selected>Selecciona un libro</option>
                </select>
                <select id="chapter-select" disabled style="padding:8px;border-radius:4px;background:#fff;color:#000;">
                    <option disabled selected>Selecciona un capítulo</option>
                </select>
            </div>
        </div>
    </div>
    <div class="audio-container" style="margin-top:80px; padding:20px;">
        <div class="main" style="width:100%;">
            <!-- chapters list hidden in favor of chapter-select -->
            <div id="player-controls">
                <div class="audio-cover"><img src="logo-blanco.png" alt="Cover"></div>
                <h3 id="now-playing"></h3>
                <input type="range" id="seek-slider" class="seek-slider" min="0" max="100" value="0" step="0.1">
                <div class="time-display"><span id="current-time">0:00</span><span id="duration">0:00</span></div>
                <div class="player-buttons">
                    <button id="prev-reading" class="player-button" title="Anterior"><i class="fas fa-backward"></i></button>
                    <button id="play-pause" class="player-button" title="Play/Pause"><i class="fas fa-play"></i></button>
                    <button id="next-reading" class="player-button" title="Siguiente"><i class="fas fa-forward"></i></button>
                </div>
                <audio id="audio-player" playsinline style="display:none;"></audio>
            </div>
        </div>
    </div>
    <script>
        // Mapa de códigos a nombres completos global
        const bookDisplayNames = {
            'genesis': 'Génesis', 'exodus': 'Éxodo', 'lev': 'Levítico', 'num': 'Números', 'deu': 'Deuteronomio',
            'joshua': 'Josué', 'judges': 'Jueces', 'ruth': 'Rut', '1sam': '1 Samuel', '2sam': '2 Samuel',
            '1kin': '1 Reyes', '2kin': '2 Reyes', '1chron': '1 Crónicas', '2chron': '2 Crónicas',
            'ezra': 'Esdras', 'nehemiah': 'Nehemías', 'esther': 'Ester', 'job': 'Job', 'psalm': 'Salmos',
            'proverbs': 'Proverbios', 'ecc': 'Eclesiastés', 'song': 'Cantares', 'isaiah': 'Isaías', 'jere': 'Jeremías',
            'lam': 'Lamentaciones', 'ezek': 'Ezequiel', 'dan': 'Daniel', 'hosea': 'Oseas', 'joel': 'Joel', 'amos': 'Amós',
            'oba': 'Abdías', 'jonah': 'Jonás', 'micah': 'Miqueas', 'nahum': 'Nahúm', 'habak': 'Habacuc', 'zeph': 'Sofonías',
            'haggai': 'Hageo', 'zech': 'Zacarías', 'mal': 'Malaquías', 'matt': 'Mateo', 'mark': 'Marcos', 'luke': 'Lucas',
            'john': 'Juan', 'acts': 'Hechos', 'romans': 'Romanos', '1cor': '1 Corintios', '2cor': '2 Corintios', 'gal': 'Gálatas',
            'eph': 'Efesios', 'phil': 'Filipenses', 'col': 'Colosenses', '1the': '1 Tesalonicenses', '2the': '2 Tesalonicenses',
            '1tim': '1 Timoteo', '2tim': '2 Timoteo', 'tit': 'Tito', 'philem': 'Filemón', 'heb': 'Hebreos', 'jam': 'Santiago',
            '1pet': '1 Pedro', '2pet': '2 Pedro', '1joh': '1 Juan', '2joh': '2 Juan', '3joh': '3 Juan', 'jude': 'Judas', 'rev': 'Apocalipsis'
        };
        // Mapa de metadatos de libros para descripción (autor, fecha, tema, descripción, temas clave)
        const bookMeta = {
            'genesis': {
                author: 'Moisés',
                date: '1445-1405 a.C.',
                theme: 'Los orígenes y el pacto de Dios',
                description: 'El libro del Génesis narra la creación del mundo, la caída del hombre, el diluvio universal y las historias de los patriarcas Abraham, Isaac y Jacob. Establece los fundamentos de la relación entre Dios y la humanidad.',
                keyTopics: ['La Creación', 'El Diluvio', 'Abraham y el Pacto', 'José en Egipto']
            },
            'tit': {
                author: 'Pablo',
                date: 'c. 63-65 d.C.',
                theme: 'Organización de la Iglesia y Conducta Cristiana',
                description: 'La carta a Tito contiene instrucciones pastorales para el liderazgo de la iglesia en Creta y la conducta de los creyentes.',
                keyTopics: ['Liderazgo Pastoral', 'Carácter Cristiano', 'Vida en Comunidad']
            }
        };
        const audioPlayer = document.getElementById('audio-player');
        console.log('Audio page script loaded');
        // Get book <select>
        const bookSelect = document.getElementById('book-select');
        const chapterSelect = document.getElementById('chapter-select');
        // Orden canónico de los libros
        const bibleOrder = ['genesis','exodus','lev','num','deu','joshua','judges','ruth','1sam','2sam','1kin','2kin','1chron','2chron','ezra','nehemiah','esther','job','psalm','proverbs','ecc','song','wisdom','sirach','isaiah','jere','lam','ezek','dan','hosea','joel','amos','oba','jonah','micah','nahum','habak','haggai','zeph','zech','mal','matt','mark','luke','john','acts','romans','1cor','2cor','gal','eph','phil','phi','col','1the','2the','1tim','2tim','tit','heb','jam','1pet','2pet','1joh','2joh','3joh','jude','rev'];

        // Cargar lista de libros desde el manifest.json dinámico
        async function loadBooks() {
            try {
                // Mostrar mensaje de carga
                const nowPlaying = document.getElementById('now-playing');
                nowPlaying.textContent = 'Cargando lista de libros...';
                
                // Intentar cargar el manifest desde varias ubicaciones posibles
                const manifestPaths = [
                    './audio/manifest.json',
                    'https://mjoelgv.github.io/biblia-poder-milagros/audio/manifest.json',
                    'https://raw.githubusercontent.com/mjoelgv/biblia-poder-milagros/main/audio/manifest.json'
                ];
                
                let manifest;
                let lastError;
                
                for (const path of manifestPaths) {
                    try {
                        console.log(`Intentando cargar manifest desde: ${path}`);
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 segundos de timeout
                        
                        const res = await fetch(path, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        manifest = await res.json();
                        
                        // Verificar que el manifest tenga el formato correcto
                        if (!Array.isArray(manifest) || manifest.length === 0) {
                            throw new Error('El manifest está vacío o tiene un formato incorrecto');
                        }
                        
                        console.log('Manifest cargado correctamente desde:', path);
                        break; // Si llegamos aquí, salir del bucle
                    } catch (err) {
                        console.error(`Error al cargar ${path}:`, err);
                        lastError = err;
                    }
                }
                
                if (!manifest) {
                    const errorMsg = `No se pudo cargar el manifest. ${lastError?.message || 'Verifica tu conexión a internet e intenta recargar la página.'}`;
                    console.error(errorMsg);
                    nowPlaying.textContent = 'Error al cargar la lista de libros. Recarga la página.';
                    throw new Error(errorMsg);
                }
                // Store manifest globally
                manifestData = manifest;
                // Populate native book <select>
                const codes = [...new Set(manifest.map(item => item.name))];
                codes.sort((a,b) => bibleOrder.indexOf(a) - bibleOrder.indexOf(b));
                // Clear existing options
                bookSelect.innerHTML = '<option disabled selected>Selecciona un libro</option>';
                codes.forEach(code => {
                    const opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = bookDisplayNames[code] || code;
                    bookSelect.appendChild(opt);
                });
                // On book selection, populate chapter-select and play first
                bookSelect.onchange = () => {
                    try {
                        const code = bookSelect.value;
                        console.log('Libro seleccionado:', code);
                        
                        if (!code) {
                            console.warn('No se seleccionó ningún libro');
                            return;
                        }
                        
                        localStorage.setItem('audio-last-book', code);
                        
                        // Filtrar y ordenar capítulos para el libro seleccionado
                        const chapters = manifestData
                            .filter(item => {
                                if (!item || !item.file) return false;
                                // Obtener el prefijo del archivo (nombre del libro)
                                const filePrefix = item.file.split(/[-_]/)[0];
                                // Comparar con el código del libro seleccionado
                                return filePrefix === code;
                            })
                            .sort((a, b) => {
                                // Usar la función global getChapterNum para ordenar los capítulos
                                const aNum = getChapterNum(a.file);
                                const bNum = getChapterNum(b.file);
                                return aNum - bNum;
                            });
                            
                        console.log(`Capítulos encontrados para ${code}:`, chapters);
                        
                        console.log(`Encontrados ${chapters.length} capítulos para ${code}`);
                        
                        // Limpiar y deshabilitar el selector de capítulos
                        chapterSelect.disabled = true;
                        chapterSelect.innerHTML = '<option disabled selected>Cargando capítulos...</option>';
                        
                        // Usar setTimeout para permitir que la UI se actualice
                        setTimeout(() => {
                            try {
                                chapterSelect.innerHTML = '<option disabled selected>Selecciona un capítulo</option>';
                                
                                if (chapters.length === 0) {
                                    console.warn('No se encontraron capítulos para el libro:', code);
                                    chapterSelect.disabled = true;
                                    return;
                                }
                                
                                // Llenar el selector de capítulos
                                chapters.forEach(item => {
                                    const num = getChapterNum(item.file, true); // Obtener solo el número como string
                                    const opt = document.createElement('option');
                                    opt.value = item.file;
                                    opt.textContent = `Capítulo ${num}`; // Mostrar solo "Capítulo X"
                                    opt.dataset.chapterNum = num; // Guardar el número para referencia
                                    chapterSelect.appendChild(opt);
                                });
                                
                                chapterSelect.disabled = false;
                                
                                // Reproducir automáticamente el primer capítulo
                                if (chapters.length > 0) {
                                    const first = chapters[0];
                                    const num = (first.file.match(/\d+/) || ['?'])[0];
                                    const isLocal = window.location.href.startsWith('file://');
                                    const basePath = isLocal ? './audio/' : 'https://mjoelgv.github.io/biblia-poder-milagros/audio/';
                                    const audioUrl = basePath + first.file;
                                    
                                    console.log('Reproduciendo primer capítulo:', audioUrl);
                                    playCustom(`${bookDisplayNames[code] || code} ${num}`, audioUrl);
                                }
                            } catch (error) {
                                console.error('Error al cargar capítulos:', error);
                                chapterSelect.innerHTML = '<option disabled>Error al cargar capítulos</option>';
                            }
                        }, 100);
                        
                                        // Configurar el manejador de cambio de capítulo
                        chapterSelect.onchange = async e => {
                            try {
                                const file = e.target.value;
                                if (!file) return;
                                
                                console.log('Capítulo seleccionado:', file);
                                
                                localStorage.setItem('audio-last-file', file);
                                
                                // Usar la función global getChapterNum para obtener el número de capítulo
                                const num = getChapterNum(file, true);
                                const isLocal = window.location.href.startsWith('file://');
                                const basePath = isLocal ? './audio/' : 'https://mjoelgv.github.io/biblia-poder-milagros/audio/';
                                const audioUrl = basePath + file;
                                
                                console.log('Preparando para reproducir capítulo:', audioUrl);
                                
                                // Actualizar la lista de reproducción
                                const currentBook = bookSelect.value;
                                
                                // Filtrar y ordenar los capítulos del libro actual
                                playlist = manifestData
                                    .filter(item => {
                                        if (!item || !item.file) return false;
                                        const filePrefix = item.file.split(/[-_]/)[0];
                                        return filePrefix === currentBook;
                                    })
                                    .sort((a, b) => {
                                        const aNum = getChapterNum(a.file);
                                        const bNum = getChapterNum(b.file);
                                        return aNum - bNum;
                                    })
                                    .map(item => basePath + item.file);
                                
                                // Establecer el índice del track actual
                                trackIndex = playlist.findIndex(url => url.endsWith(file));
                                console.log('Lista de reproducción actualizada:', {
                                    currentBook,
                                    trackCount: playlist.length,
                                    currentTrackIndex: trackIndex,
                                    currentFile: file
                                });
                                
                                // Obtener el nombre del libro actual
                                const currentBookName = bookDisplayNames[currentBook] || currentBook;
                                
                                // Actualizar la interfaz de usuario
                                document.getElementById('now-playing').textContent = `Cargando: ${currentBookName} ${num}`;
                                
                                // Actualizar el título de la página para mostrar el capítulo actual
                                document.title = `${currentBookName} ${num} - Biblia de Poder y Milagros`;
                                
                                // Cargar el audio primero
                                audioPlayer.pause();
                                audioPlayer.src = audioUrl;
                                audioPlayer.load();
                                
                                // Esperar a que el audio esté listo para reproducir
                                await new Promise((resolve) => {
                                    const onCanPlay = () => {
                                        audioPlayer.removeEventListener('canplay', onCanPlay);
                                        resolve();
                                    };
                                    audioPlayer.addEventListener('canplay', onCanPlay, { once: true });
                                    
                                        // Timeout en caso de que el audio no se cargue
                                    setTimeout(() => {
                                        audioPlayer.removeEventListener('canplay', onCanPlay);
                                        resolve(); // Continuar de todos modos
                                    }, 3000);
                                });
                                
                                // Iniciar la reproducción
                                console.log('Iniciando reproducción de:', audioUrl);
                                await audioPlayer.play();
                                
                                // Actualizar la interfaz con el estado de reproducción
                                document.getElementById('now-playing').textContent = `Escuchando: ${currentBookName} ${num}`;
                                document.title = `${currentBookName} ${num} - Biblia de Poder y Milagros`;
                                updatePlayPauseButton(true);
                                
                                console.log('Reproducción iniciada correctamente');
                                
                            } catch (error) {
                                console.error('Error al cambiar de capítulo:', error);
                                document.getElementById('now-playing').textContent = 'Error al cargar el capítulo';
                                updatePlayPauseButton(false);
                            }
                        };
                    } catch (error) {
                        console.error('Error al manejar la selección de libro:', error);
                    }
                };
                
                // Auto-load last listened book and chapter
                const lastBook = localStorage.getItem('audio-last-book');
                const lastFile = localStorage.getItem('audio-last-file');
                const autoPlayEnabled = localStorage.getItem('audio-autoplay') !== 'false';
                
                // Función para activar/desactivar controles
                const updateControls = (enabled = true) => {
                    const nextBtn = document.querySelector('.next-btn');
                    const prevBtn = document.querySelector('.prev-btn');
                    if (nextBtn) nextBtn.disabled = !enabled;
                    if (prevBtn) prevBtn.disabled = !enabled;
                };

                // Función para cargar y reproducir un capítulo
                const loadAndPlayChapter = (file, code) => {
                    if (!file || !code) {
                        updateControls(false);
                        return;
                    }
                    
                    // Extraer el número del capítulo del nombre del archivo (ej: '1chron_01.mp3' -> '1')
                    const match = file.match(/(\d+)\.mp3$/);
                    const num = match ? match[1] : '1';  // Usar '1' como valor por defecto
                    // Usar la ruta correcta a los archivos de audio
                    const audioUrl = `https://raw.githubusercontent.com/MJoelGV/biblia-poder-milagros/main/docs/audio/${file}`;
                    playCustom(`${bookDisplayNames[code] || code} ${num}`, audioUrl);
                    
                    // Activar controles
                    updateControls(true);
                    
                    if (autoPlayEnabled) {
                        const audioPlayer = document.getElementById('audio-player');
                        audioPlayer.play().catch(error => {
                            console.log('Error al reproducir automáticamente:', error);
                        });
                    }
                };

                // Configurar evento de cambio de capítulo
                chapterSelect.onchange = e => {
                    const file = e.target.value;
                    if (!file) return;
                    
                    const code = bookSelect.value;
                    localStorage.setItem('audio-last-book', code);
                    localStorage.setItem('audio-last-file', file);
                    
                    console.log('Reproduciendo:', file, 'code:', code);
                    loadAndPlayChapter(file, code);
                };

                // Cargar último capítulo escuchado si existe
                if (lastBook && codes.includes(lastBook)) {
                    bookSelect.value = lastBook;
                    // Disparar evento change para cargar los capítulos
                    const event = new Event('change');
                    bookSelect.dispatchEvent(event);
                    
                    // Esperar a que se carguen las opciones del select
                    setTimeout(() => {
                        if (lastFile) {
                            const optValues = Array.from(chapterSelect.options).map(o => o.value);
                            if (optValues.includes(lastFile)) {
                                chapterSelect.value = lastFile;
                                // Activar controles inmediatamente
                                updateControls(true);
                                // Disparar evento change para reproducir
                                const changeEvent = new Event('change');
                                chapterSelect.dispatchEvent(changeEvent);
                            } else {
                                // Si no hay archivo válido, desactivar controles
                                updateControls(false);
                            }
                        } else {
                            updateControls(false);
                        }
                    }, 100);
                } else {
                    // Si no hay libro guardado, desactivar controles
                    updateControls(false);
                }
            } catch (err) {
                console.error(err);
            }
        }

        // Reproducción de libro (solo MP3)
        function playBook(bookName, bookNode) {
            document.getElementById('now-playing').textContent = 'Escuchando ' + bookName;
            document.getElementById('player-controls').style.display = 'flex';
            const chapters = Array.from(bookNode.getElementsByTagName('c'));
            const playlist = chapters.map(c => {
                const chap = c.getAttribute('n');
                return `/audio/${encodeURIComponent(bookName)}-${chap}.mp3`;
            });
            trackIndex = 0;
            audioPlayer.style.display = '';
            audioPlayer.src = playlist[trackIndex];
            audioPlayer.play().catch(err => console.error('Error MP3:', err));
            document.getElementById('play-pause').innerHTML = '<i class="fas fa-pause"></i>';
        }

        function playCustom(name, src) {
            console.log('playCustom - Iniciando con src:', src);
            
            // Mostrar mensaje de carga
            const nowPlaying = document.getElementById('now-playing');
            nowPlaying.textContent = `Cargando ${name}...`;
            
            // Extraer el código del libro del nombre del archivo
            const fileName = src.split('/').pop();
            const [code] = fileName.replace('.mp3','').split(/[-_]/);
            
            // Verificar si el código es válido
            if (!code) {
                const errorMsg = 'No se pudo determinar el código del libro para: ' + src;
                console.error(errorMsg);
                nowPlaying.textContent = 'Error: ' + errorMsg;
                return;
            }
            
            // Verificar que exista manifestData
            if (!manifestData || !Array.isArray(manifestData)) {
                const errorMsg = 'No se han cargado los datos de la Biblia. Por favor, recarga la página.';
                console.error(errorMsg);
                nowPlaying.textContent = errorMsg;
                return;
            }
            
            console.log('Buscando capítulos para el libro:', code);
            
            // Filtrar y ordenar capítulos
            const chapters = manifestData
                .filter(item => item && item.file && item.file.startsWith(code + '_'))
                .sort((a,b) => {
                    const aNum = parseInt((a.file.match(/\d+/) || ['0'])[0]) || 0;
                    const bNum = parseInt((b.file.match(/\d+/) || ['0'])[0]) || 0;
                    return aNum - bNum;
                });
            
            console.log(`Encontrados ${chapters.length} capítulos para ${code}`);
            
            if (chapters.length === 0) {
                const errorMsg = `No se encontraron capítulos para el libro: ${code}`;
                console.error(errorMsg);
                nowPlaying.textContent = 'Error: ' + errorMsg;
                return;
            }
            
            // Determinar la ruta base según el entorno
            const isLocal = window.location.href.startsWith('file://');
            const basePath = isLocal ? './audio/' : 'https://mjoelgv.github.io/biblia-poder-milagros/audio/';
            
            console.log('Ruta base para audios:', basePath);
            
            // Crear la lista de reproducción con las rutas completas
            playlist = chapters.map(item => {
                const path = basePath + item.file;
                console.log('Añadiendo a la lista de reproducción:', path);
                return path;
            });
            
            // Encontrar el índice del capítulo actual en la lista de reproducción
            const currentFile = fileName.includes('/') ? fileName.split('/').pop() : fileName;
            trackIndex = playlist.findIndex(url => url.endsWith('/' + currentFile) || url.endsWith(currentFile));
            
            console.log(`Capítulo actual: ${currentFile}, Índice: ${trackIndex}`);
            
            if (trackIndex === -1) {
                console.warn('No se encontró el capítulo en la lista, usando el primero');
                trackIndex = 0; // Usar el primer capítulo si no se encuentra
            }
            
            // Mostrar y reproducir en cadena
            document.getElementById('now-playing').textContent = 'Cargando ' + name + '...';
            document.getElementById('player-controls').style.display = 'flex';
            audioPlayer.style.display = 'block';
            
            // Cargar el audio
            const audioUrl = playlist[trackIndex];
            console.log('Intentando reproducir:', audioUrl);
            
            // Forzar precarga del audio
            audioPlayer.pause();
            audioPlayer.src = audioUrl;
            audioPlayer.load();
            
            // Actualizar botón de reproducción
            const playPauseBtn = document.getElementById('play-pause');
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            
            // Mostrar mensaje para el usuario
            document.getElementById('now-playing').textContent = 'Haz clic en el botón de reproducción para escuchar ' + name;
            
            // Habilitar controles
            playPauseBtn.disabled = false;
        }

        // Función para reproducir track y actualizar indicador
        function playTrack(index) {
            try {
                console.log('playTrack called with index:', index);
                if (!playlist || !playlist.length) {
                    console.error('Playlist is empty or not defined');
                    return;
                }
                
                const src = playlist[index];
                if (!src) {
                    console.error('No source found at index', index);
                    return;
                }
                
                console.log('Setting audio source to:', src);
                audioPlayer.src = src;
                
                // Actualizar la interfaz de usuario
                const playPauseBtn = document.getElementById('play-pause');
                if (playPauseBtn) {
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    playPauseBtn.setAttribute('title', 'Pausar');
                }
                
                // Extraer información del archivo para mostrar
                const fileName = src.split('/').pop().replace('.mp3','');
                const parts = fileName.includes('-') ? fileName.split('-') : fileName.split('_');
                if (parts.length >= 1) {
                    const code = parts[0];
                    const chap = parts[1] || '';
                    document.getElementById('now-playing').textContent = `Escuchando ${bookDisplayNames[code] || code} ${chap}`;
                }
                
                // Reproducir automáticamente
                return audioPlayer.play()
                    .then(() => {
                        console.log('Playback started successfully');
                        trackIndex = index; // Actualizar el índice del track actual
                        updatePlayPauseButton(true);
                    })
                    .catch(error => {
                        console.error('Error playing audio:', error);
                        updatePlayPauseButton(false);
                        throw error; // Propagar el error para manejarlo en el llamador
                    });
                    
            } catch (error) {
                console.error('Error in playTrack:', error);
                updatePlayPauseButton(false);
                throw error; // Propagar el error
            }
        }

        // Controles pausa y stop
        document.getElementById('prev-reading').onclick = () => {
            if (trackIndex > 0) { trackIndex--; playTrack(trackIndex); }
        };
        document.getElementById('next-reading').onclick = () => {
            if (trackIndex < playlist.length - 1) { trackIndex++; playTrack(trackIndex); }
        };
        const stopBtn = document.getElementById('stop-reading');
        if (stopBtn) {
            stopBtn.onclick = () => {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                document.getElementById('player-controls').style.display = 'none';
            };
        }
        // MP3 cambia track
        audioPlayer.addEventListener('ended', () => {
            if (trackIndex < playlist.length - 1) {
                trackIndex++;
                playTrack(trackIndex);
            }
        });
        // Play/Pause toggle
        const playPauseBtn = document.getElementById('play-pause');
        
        // Función para actualizar el estado del botón
        function updatePlayPauseButton(isPlaying) {
            if (!playPauseBtn) return;
            
            if (isPlaying) {
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                playPauseBtn.setAttribute('title', 'Pausar');
            } else {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.setAttribute('title', 'Reproducir');
            }
        }
        
        // Inicializar el estado del botón
        updatePlayPauseButton(false);
        
        // Función para manejar el clic en el botón Play/Pause
        function handlePlayPauseClick(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            console.log('Play/Pause clicked. Current state - paused:', audioPlayer.paused, 
                       'ended:', audioPlayer.ended, 
                       'src:', audioPlayer.src);
            
            // Si no hay fuente, no hacer nada
            if (!audioPlayer.src) {
                console.log('No hay fuente de audio cargada');
                return;
            }
            
            // Si está pausado o terminado, intentar reproducir
            if (audioPlayer.paused || audioPlayer.ended) {
                console.log('Iniciando reproducción...');
                const playPromise = audioPlayer.play();
                
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            console.log('Reproducción iniciada exitosamente');
                            // No es necesario actualizar el botón aquí, el evento 'play' lo hará
                        })
                        .catch(error => {
                            console.error('Error al reproducir:', error);
                            updatePlayPauseButton(false);
                            // Mostrar mensaje de error al usuario
                            const nowPlaying = document.getElementById('now-playing');
                            if (nowPlaying) {
                                nowPlaying.textContent = 'Error al reproducir el audio';
                            }
                        });
                }
            } else {
                // Si está reproduciendo, pausar
                console.log('Pausando reproducción...');
                audioPlayer.pause();
                // El evento 'pause' actualizará el botón
            }
        }
        
        // Función para inicializar los manejadores de eventos del reproductor
        function initializePlayerEventHandlers() {
            if (!playPauseBtn || !audioPlayer) {
                console.error('Error: No se pudo encontrar el botón de Play/Pause o el reproductor de audio');
                return;
            }
            
            console.log('Inicializando manejadores de eventos del reproductor...');
            
            // Limpiar manejadores de eventos previos para evitar duplicados
            playPauseBtn.removeEventListener('click', handlePlayPauseClick);
            
            // Configurar el manejador de clic para el botón de play/pausa
            playPauseBtn.addEventListener('click', handlePlayPauseClick);
            
            // Configurar manejadores de eventos del reproductor de audio
            const events = ['play', 'playing', 'pause', 'ended', 'error', 'waiting'];
            events.forEach(event => {
                audioPlayer.removeEventListener(event, handlePlayerStateChange);
                audioPlayer.addEventListener(event, handlePlayerStateChange);
            });
            
            console.log('Manejadores de eventos del reproductor inicializados correctamente');
        }
        
        // Función para manejar cambios de estado del reproductor
        function handlePlayerStateChange(event) {
            console.log(`Evento del reproductor: ${event.type}`, {
                paused: audioPlayer.paused,
                ended: audioPlayer.ended,
                currentTime: audioPlayer.currentTime,
                duration: audioPlayer.duration,
                readyState: audioPlayer.readyState
            });
            
            switch (event.type) {
                case 'play':
                case 'playing':
                    updatePlayPauseButton(true);
                    break;
                    
                case 'pause':
                    // Solo actualizar si no es por el final del audio
                    if (!audioPlayer.ended) {
                        updatePlayPauseButton(false);
                    }
                    break;
                    
                case 'ended':
                    updatePlayPauseButton(false);
                    break;
                    
                case 'error':
                    console.error('Error en el reproductor de audio:', audioPlayer.error);
                    updatePlayPauseButton(false);
                    break;
                    
                case 'waiting':
                    console.log('El reproductor está cargando datos...');
                    break;
            }
        }
        
        // Inicializar los manejadores de eventos
        initializePlayerEventHandlers();
        // Seek slider and time update
        const seekSlider = document.getElementById('seek-slider');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        function formatTime(sec) {
            const m = Math.floor(sec/60);
            const s = String(Math.floor(sec%60)).padStart(2, '0');
            return `${m}:${s}`;
        }
        audioPlayer.addEventListener('loadedmetadata', () => {
            seekSlider.max = audioPlayer.duration;
            durationEl.textContent = formatTime(audioPlayer.duration);
            // Ruta base relativa para los audios
            const AUDIO_BASE_PATH = './audio/';
            // Restore saved position
            const key = 'audio-pos-' + audioPlayer.src.split('/').pop();
            const saved = localStorage.getItem(key);
            if (saved) audioPlayer.currentTime = parseFloat(saved);
        });
        audioPlayer.addEventListener('timeupdate', () => {
            seekSlider.value = audioPlayer.currentTime;
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            // Save current position
            const key = 'audio-pos-' + audioPlayer.src.split('/').pop();
            localStorage.setItem(key, audioPlayer.currentTime);
        });
        seekSlider.oninput = () => {
            audioPlayer.currentTime = seekSlider.value;
        };
        // Funciones de utilidad
        function getChapterNum(filename, returnString = false) {
            const match = filename.match(/(\d+)(?:\.mp3)?$/);
            if (!match) return returnString ? '?' : 0;
            return returnString ? match[1] : parseInt(match[1], 10);
        }
        
        // Iniciar lista y reproducción
        let manifestData = [];
        let playlist = [];
        let trackIndex = 0; 
        let currentBookName;
        let currentBookNode;
        
        // Precargar manifest y configurar evento de interacción
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM cargado, iniciando carga de libros...');
            try {
                await loadBooks();
                console.log('Libros cargados correctamente');
                
                // Configurar controles de audio después de cargar los libros
                const lastBook = localStorage.getItem('audio-last-book');
                if (lastBook) {
                    bookSelect.value = lastBook;
                    // Disparar el evento change para cargar los capítulos
                    const event = new Event('change');
                    bookSelect.dispatchEvent(event);
                }
            } catch (error) {
                console.error('Error al cargar los libros:', error);
                alert('Error al cargar la lista de libros. Por favor, recarga la página.');
            }
            
            // Configurar controles de audio para el botón de reproducción
            const playPauseBtn = document.getElementById('play-pause');
            playPauseBtn.addEventListener('click', function() {
                if (audioPlayer.paused) {
                    // Si no hay fuente, intentar cargar el primer capítulo
                    if (!audioPlayer.src && playlist.length > 0) {
                        audioPlayer.src = playlist[0];
                    }
                    audioPlayer.play().then(() => {
                        this.innerHTML = '<i class="fas fa-pause"></i>';
                    }).catch(err => {
                        console.error('Error al reproducir:', err);
                        this.innerHTML = '<i class="fas fa-play"></i>';
                    });
                } else {
                    audioPlayer.pause();
                    this.innerHTML = '<i class="fas fa-play"></i>';
                }
            });
        });
    </script>
    <script>
        const menuBtn = document.getElementById('side-menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        if (menuBtn) menuBtn.addEventListener('click', () => sideMenu.classList.toggle('active'));
        document.addEventListener('click', e => {
            if (sideMenu.classList.contains('active') && !sideMenu.contains(e.target) && !menuBtn.contains(e.target)) {
                sideMenu.classList.remove('active');
            }
        });
    </script>
</body>
</html>
