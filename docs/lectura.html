<!DOCTYPE html>
<!-- Build timestamp: 2025-04-25T21:20:00Z -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lectura - Biblia de Poder y Milagros</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- corregido path para iOS icon -->
    <link rel="apple-touch-icon" href="../icons/pymicon.png">
    <style>
        /* Estilos para el bot√≥n flotante de notas */
        .floating-notes-btn {
            position: fixed;
            width: 50px;
            height: 50px;
            background: rgba(76, 175, 80, 0.2);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(76, 175, 80, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #4CAF50;
            cursor: grab;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .floating-notes-btn:hover {
            transform: scale(1.1);
            background: rgba(76, 175, 80, 0.3);
        }

        .floating-notes-btn:active {
            cursor: grabbing;
        }

        /* Estilos para el modal personalizado */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .custom-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .custom-modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .custom-modal-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .custom-modal-button.confirm {
            background-color: #4CAF50;
            color: white;
        }

        .custom-modal-button.cancel {
            background-color: #f44336;
            color: white;
        }

        .custom-modal-button:hover {
            opacity: 0.9;
        }

        /* Estilos para el panel de notas */
        .notes-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-sizing: border-box;
        }

        .notes-panel.active {
            right: 0;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
        }

        .notes-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-btn {
            padding: 8px 15px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #4CAF50;
            color: white;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .note-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .note-form input,
        .note-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .note-form textarea {
            flex: 1;
            min-height: 200px;
            resize: none;
        }

        .note-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .note-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #eee;
        }

        .note-item:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .note-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .note-preview {
            color: #666;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .note-actions .btn {
            padding: 4px 8px;
            font-size: 12px;
        }

        .close-notes {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        :root {
            --primary-color: #4CAF50;
            --text-color: #333;
            --bg-color: #fff;
            --verse-font-size: 16px;
            --menu-bg: rgba(0, 0, 0, 0.6);
            --menu-blur: blur(10px);
        }

        [data-theme="dark"] {
            --primary-color: #45a049;
            --text-color: #fff;
            --bg-color: #121212;
            --menu-bg: rgba(0, 0, 0, 0.8);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s;
        }

        .controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--menu-bg);
            backdrop-filter: var(--menu-blur);
            color: white;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .controls.hidden {
            transform: translateY(-100%);
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }

        .home-icon {
            text-decoration: none;
            font-size: 24px;
            color: var(--primary-color);
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .home-icon:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .select-css {
            padding: 8px 12px;
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
            outline: none;
        }

        .select-css:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .select-css option {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 8px;
        }

        .search-wrapper { display: inline-flex; align-items: center; }
        .search-wrapper .search-input { display: none; }
        .search-wrapper.active .search-input { 
            display: inline-block;
            max-width: 180px;
            opacity: 1;
            margin-left: 8px;
            padding: 8px 12px;
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            outline: none;
        }

        .search-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .pericopes-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 8px;
            white-space: nowrap;
        }

        .pericopes-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            opacity: 0.9;
        }

        /* Controles de fuente */
        .font-controls {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: 8px;
        }
        
        .font-button {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .font-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        /* Asegurar contraste en modo oscuro */
        [data-theme="dark"] .font-button {
            background: #4a6b57;
        }

        .chapter-content {
            max-width: 1200px;
            margin: 120px auto 80px;
            padding: 0 20px;
        }

        .chapter-title {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 20px 0 30px 0;
            padding: 10px;
        }

        .verse {
            margin-bottom: 0.8em;
            padding: 0.4em;
            line-height: 1.6;
            border-radius: 4px;
            transition: background-color 1s ease;
        }

        .verse:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .verse.highlighted {
            background-color: rgba(76, 175, 80, 0.15);
        }
        /* Dark mode: highlighted verse text black for readability */
        [data-theme="dark"] .verse.highlighted {
            color: #000;
        }
        .verse.bookmarked { background: #fffa8c; }
        .verse.comment { 
            border-left: 4px solid var(--primary-color);
            position: relative;
        }
        .verse.comment::after {
            content: 'üí¨';
            position: absolute;
            right: 5px;
            top: 2px;
            font-size: 0.8em;
            opacity: 0.7;
        }
        .verse.memorized { background: #c6f4d6; }
        /* Dark mode: texto negro para bookmarked y memorized */
        [data-theme="dark"] .verse.bookmarked,
        [data-theme="dark"] .verse.memorized {
            color: #000;
        }

        .verse-number {
            color: var(--primary-color);
            font-weight: bold;
            margin-right: 0.5em;
            font-size: 0.9em;
        }

        .verse-text {
            font-size: var(--verse-font-size);
            line-height: 1.6;
        }

        .navigation-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--menu-bg);
            backdrop-filter: var(--menu-blur);
            color: white;
            padding: 12px;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .navigation-bottom.hidden {
            transform: translateY(100%);
        }

        .nav-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #chapter-select {
            min-width: 120px;
            text-align: center;
        }

        .chapter-grid, .verse-grid {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .chapter-grid.active, .verse-grid.active {
            display: flex;
        }
        .chapter-grid .grid-content, .verse-grid .grid-content {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px,1fr));
            gap: 10px;
        }
        /* Header for modal grids */
        .chapter-grid .grid-header, .verse-grid .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .close-grid {
            cursor: pointer;
            font-size: 1.5em;
            line-height: 1;
        }

        /* Bot√≥n de t√≠tulo: l√≠nea √∫nica con indicador */
        .chapter-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            transition: background 0.3s, color 0.3s;
        }

        .chapter-btn:hover,
        .chapter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .chapter-btn::after {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            opacity: 0;
            transition: opacity 0.3s;
            margin-left: 8px;
        }

        .chapter-btn.active::after {
            opacity: 1;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        #search-results-count {
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .search-results {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            background: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1100;
            padding: 20px;
            overflow-y: auto;
        }

        .search-results.active {
            display: block;
        }

        /* Bot√≥n cerrar resultados de b√∫squeda */
        .search-results .close-search {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
        }

        .search-results .close-search:hover {
            color: var(--primary-color);
        }

        .result-item {
            padding: 12px;
            border-bottom: 1px solid rgba(128,128,128,0.2);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .result-item:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .result-book {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .result-text {
            font-size: 0.9em;
            line-height: 1.5;
        }

        /* Modal para comentarios */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1300;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%,-50%);
            background: var(--bg-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1301;
            max-width: 90%; width: 300px;
        }
        .modal textarea {
            width: 100%; height: 100px; resize: vertical;
        }
        .modal-actions {
            display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px;
        }
        .modal-actions button {
            padding: 6px 12px;
        }

        /* Verso marcado y men√∫ contextual */
        .verse-menu {
            display: none;
            position: absolute;
            background: var(--bg-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1200;
            padding: 8px;
        }
        .verse-menu ul { list-style: none; margin: 0; padding: 0; }
        .verse-menu li {
            padding: 8px; cursor: pointer;
        }
        .verse-menu li:hover { background: rgba(0,0,0,0.05); }
        /* Responsive: wrap controls and selectors on small screens */
        @media (max-width: 768px) {
            .top-row, .navigation {
                flex-wrap: wrap;
            }
            /* Reduce spacing on mobile */
            .top-row > *, .navigation > * {
                margin: 3px 5px;
            }
            .navigation {
                margin: 8px 0;
            }
            /* Allow selectors and input to shrink and limit width */
            .select-css, .search-input {
                max-width: 80px;
                flex: 0 1 auto;
            }
        }
        /* Responsive: men√∫ m√°s compacto en m√≥viles */
        @media (max-width: 600px) {
            .controls { padding: 8px; }
            .controls .home-icon,
            .controls .theme-toggle {
                width: 32px;
                height: 32px;
                font-size: 20px;
                padding: 4px;
            }
            .selector-row {
                padding: 8px;
                top: 48px; /* altura de controls reducida */
            }
            #version-selector {
                width: 180px;
                min-width: 150px;
            }
            #book-select {
                width: 120px;
                min-width: 100px;
            }
        }
        /* Extra controls (hidden por defecto) */
        .extra-controls {
            display: none;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            margin: 10px 20px;
        }
        .extra-controls.active {
            display: flex;
        }
        /* Main menu toggle button */
        .main-menu-toggle {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-menu-toggle:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        /* Men√∫ lateral */
        .side-menu {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background: var(--bg-color);
            box-shadow: 2px 0 8px rgba(0,0,0,0.2);
            transition: left 0.3s ease;
            z-index: 1001;
        }
        .side-menu.active {
            left: 0;
        }
        .side-menu ul { list-style: none; padding: 20px; margin: 0; }
        .side-menu ul li { padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
        .side-menu ul li:last-child { border-bottom: none; }
        .side-menu-toggle {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }
        .side-menu-toggle:hover { background-color: rgba(0,0,0,0.05); border-radius: 50%; }
        
        /* Outline grid styling */
        .outline-grid {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .outline-grid.active {
            display: flex;
        }
        .outline-grid .grid-content {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px,1fr));
            gap: 10px;
        }
        .outline-grid .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
        /* Verse grid styling and hide dropdowns */
        #chapter-select, #verse-select {
            display: none !important;
        }

        /* Mostrar grid de cap√≠tulos cuando est√© activo */
        .chapter-grid.active { display: flex; }
        
        /* Estilos para mensajes de carga y error */
        .loading, .error-message {
            padding: 20px;
            text-align: center;
            font-size: 1.2em;
            color: #333;
            background-color: #f8f8f8;
            border-radius: 5px;
            margin: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        
        .error-message p {
            margin: 10px 0;
        }
        
        [data-theme="dark"] .loading {
            color: #e0e0e0;
            background-color: #2d2d2d;
        }
        
        [data-theme="dark"] .error-message {
            color: #f5c6cb;
            background-color: #721c24;
            border-color: #f5c6cb;
        }
    </style>
    <script>
        // Inicializar strongsData como un objeto vac√≠o
        let strongsData = {};
        // Intentar cargar strongs.json, pero no es cr√≠tico si falla
        fetch('strongs.json')
          .then(res => res.ok ? res.json() : {})
          .then(data => { 
              strongsData = data; 
              console.log('Datos de Strong cargados correctamente');
          })
          .catch(err => {
              console.warn('No se pudo cargar strongs.json. Las anotaciones de Strong no estar√°n disponibles.');
          });
    </script>
    <!-- texto actualizado -->
    <div id="install-button" style="display:none;position:fixed;bottom:80px;right:20px;padding:10px 20px;background:#4CAF50;color:#fff;border:none;border-radius:20px;z-index:1000;">Descargar esta App</div>
</head>
<body>
    <!-- Men√∫ lateral -->
    <div id="side-menu" class="side-menu">
        <ul>
            <li onclick="window.location.href='index.html'">P√°gina principal</li>
            <li onclick="window.location.href='lectura.html'">Leer Biblia</li>
            <li onclick="window.location.href='audio.html'">Escuchar</li>
            <li onclick="window.location.href='memorizados.html'">Memorizados</li>
            <li onclick="window.location.href='historias.html'">Historias</li>
            <li onclick="window.location.href='diccionario.html'">Diccionario</li>
            <li onclick="window.location.href='bookmarks.html'">Marcados</li>
            <li onclick="window.location.href='comments.html'">Comentarios</li>
            <li id="chapter-menu-toggle">Cap√≠tulos</li>
        </ul>
    </div>
    <div class="controls" id="controls">
        <div class="top-row">
            <button id="side-menu-toggle" class="side-menu-toggle">‚ò∞</button>
            <select id="version-selector" class="select-css">
                <option value="Reina-Valera-1960" selected>Reina-Valera 1960</option>
                <option value="TLA">Traducci√≥n en Lenguaje Actual</option>
                <option value="Dios-Habla-Hoy">Dios Habla Hoy</option>
                <option value="La-Biblia-de-Las-Americas">La Biblia de las Am√©ricas</option>
                <option value="Nueva-Traduccion-Viviente">Nueva Traducci√≥n Viviente</option>
            </select>
            <select id="book-select" class="select-css"></select>
            <button id="pericopes-button" class="pericopes-button" title="Ver per√≠copas del cap√≠tulo">Per√≠copas</button>
            <div class="search-wrapper">
                <button id="search-button" class="search-button">üîç</button>
                <input id="search-input" class="search-input" placeholder="Buscar vers√≠culo" />
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle" title="Cambiar tema">üåô</button>
            <button id="main-menu-toggle" class="main-menu-toggle">‚ãÆ</button>
        </div>
        <div id="extra-controls" class="extra-controls">
            <div class="font-controls">
                <button id="decrease-font" class="font-button" onclick="adjustFontSize(-1)" title="Disminuir tama√±o de fuente">A-</button>
                <button id="increase-font" class="font-button" onclick="adjustFontSize(1)" title="Aumentar tama√±o de fuente">A+</button>
                <button id="reset-font" class="font-button" title="Restablecer tama√±o de fuente">‚Ü∫</button>
            </div>
        </div>
    </div> <!-- cierre .controls -->

    <!-- Overlay de resultados de b√∫squeda -->
    <div id="search-results" class="search-results">
        <div class="search-results-header">
            <div id="search-results-count">0 resultados</div>
            <button id="close-search" class="close-search">&times;</button>
        </div>
        <div id="results-content"></div>
    </div>

    <!-- Men√∫ contextual para vers√≠culos -->
    <div id="verse-menu" class="verse-menu">
        <ul>
            <li id="menu-toggle-bookmark">Marcar vers√≠culo</li>
            <li id="menu-add-comment">Agregar comentario</li>
            <li id="menu-memorize-verse">Memorizar vers√≠culo</li>
            <li id="menu-copy-verse">Copiar vers√≠culo</li>
        </ul>
    </div>

    <!-- Modal de comentarios -->
    <div id="comment-backdrop" class="modal-backdrop"></div>
    <div id="comment-modal" class="modal">
        <h3>Comentario</h3>
        <textarea id="modal-comment-input"></textarea>
        <div class="modal-actions">
            <button id="modal-save-btn">Guardar</button>
            <button id="modal-cancel-btn">Cancelar</button>
        </div>
    </div>

    <div class="chapter-grid" id="chapter-grid"></div>
    <div class="verse-grid" id="verse-grid"></div>
    <div class="outline-grid" id="outline-grid"></div>
    <!-- outline-grid removed temporarily until feature complete -->
    <div class="chapter-content" id="chapter-content">
        <div id="verses"></div>
    </div> <!-- cierre .chapter-content -->

    <div class="navigation-bottom" id="navigation-bottom">
        <button class="nav-button" id="prev-button">‚Üê Anterior</button>
        <button class="nav-button" id="chapter-button">Cap√≠tulo <span id="current-chapter-button">1</span></button>
        <button class="nav-button" id="next-button">Siguiente ‚Üí</button>
    </div>

    <div id="strongs-backdrop" class="modal-backdrop"></div>
    <div id="strongs-modal" class="modal">
        <div id="strongs-content"></div>
        <button id="strongs-close">Cerrar</button>
    </div>

    <script>
        // Variables globales para el sistema de notas
        let notes = [];
        let currentNoteId = null; // Variable para rastrear la nota que se est√° editando
        const NOTES_STORAGE_KEY = 'bible_notes';

        // Variables globales para el sistema de confirmaci√≥n
        let customConfirm;
        
        // Inicializar el sistema de confirmaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            // Sistema de confirmaci√≥n personalizado
            customConfirm = (function() {
                const modal = document.getElementById('customConfirmModal');
                const message = document.getElementById('customConfirmMessage');
                const confirmBtn = document.getElementById('customConfirmOk');
                const cancelBtn = document.getElementById('customConfirmCancel');
                
                if (!modal || !message || !confirmBtn || !cancelBtn) {
                    console.error('Error: No se encontraron todos los elementos del modal de confirmaci√≥n');
                    return function() { return Promise.resolve(false); };
                }
                
                return function(msg) {
                    return new Promise((resolve) => {
                        message.textContent = msg;
                        modal.style.display = 'flex';
                        
                        const handleConfirm = () => {
                            modal.style.display = 'none';
                            confirmBtn.removeEventListener('click', handleConfirm);
                            cancelBtn.removeEventListener('click', handleCancel);
                            resolve(true);
                        };
                        
                        const handleCancel = () => {
                            modal.style.display = 'none';
                            confirmBtn.removeEventListener('click', handleConfirm);
                            cancelBtn.removeEventListener('click', handleCancel);
                            resolve(false);
                        };
                        
                        confirmBtn.addEventListener('click', handleConfirm);
                        cancelBtn.addEventListener('click', handleCancel);
                    });
                };
            })();
        });

        // Funci√≥n para mostrar mensajes personalizados
        async function showConfirm(message) {
            if (!customConfirm) {
                // Si el modal no est√° listo, usar confirm nativo
                console.warn('Modal no inicializado, usando confirm nativo');
                return confirm(message);
            }
            return await customConfirm(message);
        }

        let xmlDoc = null;
        let currentBook = '';
        let currentChapter = 1;
        let currentVerse = 0;
        let currentVersion = 'Reina-Valera-1960';
        const audioPlayer = null;
        let playlist = [];
        let trackIndex = 0;

        // Controlar la visibilidad de los men√∫s al hacer scroll
        let lastScrollY = window.scrollY;
        let ticking = false;
        let lastTouchY = 0;
        let touchStartY = 0;
        let menuVisible = true;

        // Cargar preferencia de tema SOLO UNA VEZ
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-toggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Funci√≥n para manejar el scroll
        function handleScroll() {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    const currentScrollY = window.scrollY;
                    const scrollingDown = currentScrollY > lastScrollY;
                    
                    // Solo cambiamos la visibilidad si el scroll es significativo
                    if (Math.abs(currentScrollY - lastScrollY) > 50) {
                        menuVisible = !scrollingDown;
                        document.getElementById('controls').classList.toggle('hidden', !menuVisible);
                        document.getElementById('navigation-bottom').classList.toggle('hidden', !menuVisible);
                    }
                    
                    lastScrollY = currentScrollY;
                    ticking = false;
                });
                ticking = true;
            }
        }

        // Funci√≥n para manejar el toque
        function handleTouch(e) {
            const currentY = e.touches[0].clientY;
            
            if (e.type === 'touchstart') {
                touchStartY = currentY;
                lastTouchY = currentY;
                return;
            }
            
            const deltaY = currentY - lastTouchY;
            
            // Solo cambiamos la visibilidad si el movimiento es significativo
            if (Math.abs(deltaY) > 30) {
                menuVisible = deltaY > 0;
                document.getElementById('controls').classList.toggle('hidden', !menuVisible);
                document.getElementById('navigation-bottom').classList.toggle('hidden', !menuVisible);
            }
            
            lastTouchY = currentY;
        }

        // Event listeners para scroll y touch
        window.addEventListener('scroll', handleScroll, { passive: true });
        document.addEventListener('touchstart', handleTouch, { passive: true });
        document.addEventListener('touchmove', handleTouch, { passive: true });

        // Mostrar men√∫s al tocar cerca de ellos
        document.addEventListener('touchstart', (e) => {
            const touchY = e.touches[0].clientY;
            const windowHeight = window.innerHeight;
            
            // Si el toque est√° cerca del borde superior o inferior
            if (touchY < 50 || touchY > windowHeight - 50) {
                menuVisible = true;
                document.getElementById('controls').classList.remove('hidden');
                document.getElementById('navigation-bottom').classList.remove('hidden');
            }
        }, { passive: true });

        // Funci√≥n para cambiar el tema
        function toggleTheme() {
            const body = document.body;
            const button = document.getElementById('theme-toggle');
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            button.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }

        // Event listeners para los botones de navegaci√≥n
        document.getElementById('prev-button').addEventListener('click', () => {
            if (currentChapter > 1) {
                currentChapter--;
                loadChapter();
                updateControls();
                updateURL();
                window.scrollTo({ top:0, behavior:'smooth' });
            }
        });
        document.getElementById('next-button').addEventListener('click', () => {
            const totalChapters = xmlDoc.querySelector(`b[n="${currentBook}"]`).getElementsByTagName('c').length;
            if (currentChapter < totalChapters) {
                currentChapter++;
                loadChapter();
                updateControls();
                updateURL();
                window.scrollTo({ top:0, behavior:'smooth' });
            }
        });

        // Funci√≥n para cargar cap√≠tulos
        async function loadChapters() {
            const book = document.getElementById('book-select').value;
            if (!book) return;

            const chapters = xmlDoc.querySelector(`b[n="${book}"]`).getElementsByTagName('c');
            const chapterSelect = document.getElementById('chapter-select');
            chapterSelect.innerHTML = '<option value="" disabled selected>Selecciona un cap√≠tulo</option>' +
                Array.from(chapters).map((_, index) => `
                    <option value="${index + 1}" ${currentChapter === index + 1 ? 'selected' : ''}>
                        Cap√≠tulo ${index + 1}
                    </option>
                `).join('');
        }

        // Funci√≥n para cargar cap√≠tulo
        async function loadChapter() {
            const versesContainer = document.getElementById('verses');
            versesContainer.innerHTML = '<div class="loading">Cargando...</div>';

            try {
                const chapter = xmlDoc.querySelector(`b[n="${currentBook}"] c[n="${currentChapter}"]`);
                if (!chapter) throw new Error('No se encontr√≥ el cap√≠tulo');

                let html = `
                    <div class="chapter-title">
                        ${currentBook} - Cap√≠tulo ${currentChapter}
                    </div>
                `;
                
                const verses = chapter.getElementsByTagName('v');
                html += Array.from(verses).map(verse => {
                    const verseNum = verse.getAttribute('n');
                    const isHighlighted = parseInt(verseNum) === currentVerse;
                    return `
                        <div class="verse ${isHighlighted ? 'highlighted' : ''}" 
                             data-verse="${verseNum}"
                             onclick="highlightVerse(this)">
                            <span class="verse-number">${verseNum}</span>
                            <span class="verse-text">${
                                Array.from(verse.childNodes)
                                    .filter(n => n.nodeType === Node.TEXT_NODE)
                                    .map(n => n.textContent)
                                    .join('').trim()
                            }</span>
                        </div>
                    `;
                }).join('');

                versesContainer.innerHTML = html;

                // Desplazarse al vers√≠culo si est√° especificado
                if (currentVerse > 0) {
                    const verseElement = versesContainer.querySelector(`.verse[data-verse="${currentVerse}"]`);
                    if (verseElement) {
                        setTimeout(() => {
                            // Asegurarse de que el vers√≠culo est√© visible
                            verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Resaltar el vers√≠culo
                            verseElement.classList.add('highlighted');
                            // Quitar el resaltado despu√©s de 3 segundos
                            setTimeout(() => verseElement.classList.remove('highlighted'), 3000);
                        }, 100);
                    } else {
                        console.warn(`No se encontr√≥ el vers√≠culo ${currentVerse}`);
                    }
                }
                
                // Agregar bot√≥n de per√≠copas despu√©s de cargar el cap√≠tulo
                try {
                    agregarBotonPericopas();
                } catch (error) {
                    console.error('Error al agregar bot√≥n de per√≠copas:', error);
                }
            } catch (error) {
                console.error('Error loading chapter:', error);
                versesContainer.innerHTML = `<div class="error">Error al cargar el cap√≠tulo: ${error.message}</div>`;
            }
        }

        // Funci√≥n para actualizar controles
        function updateControls() {
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            
            if (!currentBook) {
                prevButton.disabled = true;
                nextButton.disabled = true;
                return;
            }

            const totalChapters = xmlDoc.querySelector(`b[n="${currentBook}"]`).getElementsByTagName('c').length;
            
            prevButton.disabled = currentChapter <= 1;
            nextButton.disabled = currentChapter >= totalChapters;
            
            // Actualizar texto del bot√≥n de cap√≠tulo
            document.getElementById('current-chapter-button').textContent = currentChapter;
        }

        // Funci√≥n para actualizar URL
        function updateURL() {
            const url = new URL(window.location);
            url.searchParams.set('book', currentBook);
            url.searchParams.set('chapter', currentChapter);
            window.history.pushState({}, '', url);
        }

        // Funci√≥n para cargar la Biblia
        async function loadBible(version) {
            try {
                // Mostrar indicador de carga
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading';
                loadingDiv.textContent = 'Cargando versi√≥n ' + version + '...';
                document.getElementById('verses').innerHTML = '';
                document.getElementById('verses').appendChild(loadingDiv);
                
                // Intentar cargar la versi√≥n solicitada
                const url = `biblia-files/${version}.xmm`;
                console.log('[BIBLIA] Intentando cargar:', url);
                
                let response;
                try {
                    response = await fetch(url);
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                } catch (firstError) {
                    console.log('[BIBLIA] Primera carga fallida, intentando ruta alternativa...');
                    // Si falla, intentar con la ruta completa
                    const fullUrl = window.location.href.replace(/\/lectura\.html.*$/, '') + '/biblia-files/' + version + '.xmm';
                    console.log('[BIBLIA] Intentando con ruta completa:', fullUrl);
                    response = await fetch(fullUrl);
                    if (!response.ok) {
                        throw new Error('No se pudo cargar el archivo: ' + url + ' (Error: ' + firstError.message + ')' + 
                                      ' ni ' + fullUrl + ' (HTTP ' + response.status + ')');
                    }
                }
                
                const xmlText = await response.text();
                xmlDoc = new DOMParser().parseFromString(xmlText, 'text/xml');
                
                // Verificar que el XML se haya parseado correctamente
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    throw new Error('Error al analizar el archivo XML');
                }
                
                currentVersion = version;
                
                // Actualizar el selector de versiones
                const versionSelect = document.getElementById('version-selector');
                if (versionSelect) {
                    versionSelect.value = version;
                }
                
                console.log('[BIBLIA] Versi√≥n cargada correctamente:', version);
                return true;
                
            } catch (error) {
                console.error('[BIBLIA] Error al cargar la Biblia:', error);
                
                // Mostrar mensaje de error al usuario
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `
                    <p>No se pudo cargar la versi√≥n seleccionada.</p>
                    <p>Detalles: ${error.message}</p>
                    <p>Por favor, intente con otra versi√≥n o recargue la p√°gina.</p>
                `;
                
                const versesEl = document.getElementById('verses');
                if (versesEl) {
                    versesEl.innerHTML = '';
                    versesEl.appendChild(errorDiv);
                }
                
                // Intentar cargar una versi√≥n por defecto si es posible
                if (version !== 'Reina-Valera-1960' && document.getElementById('version-selector')) {
                    console.log('[BIBLIA] Intentando cargar Reina-Valera-1960 como respaldo...');
                    document.getElementById('version-selector').value = 'Reina-Valera-1960';
                    return loadBible('Reina-Valera-1960');
                }
                
                return false;
            }
        }

        // Event listener para el selector de versiones
        document.getElementById('version-selector').addEventListener('change', async (e) => {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.textContent = 'Cargando versi√≥n...';
            document.getElementById('verses').innerHTML = '';
            document.getElementById('verses').appendChild(loadingDiv);
            
            await loadBible(e.target.value);
            setupBookSelector();
            if (currentBook) {
                document.getElementById('book-select').value = currentBook;
                loadChapters();
                loadChapter();
                updateControls();
            }
        });

        // Configurar selector de libros
        function setupBookSelector() {
            const books = xmlDoc.getElementsByTagName('b');
            const bookSelect = document.getElementById('book-select');
            bookSelect.innerHTML = '<option value="">Selecciona un libro</option>';
            
            Array.from(books).forEach(book => {
                const option = document.createElement('option');
                option.value = book.getAttribute('n');
                option.textContent = book.getAttribute('n');
                bookSelect.appendChild(option);
            });
        }

        // Funci√≥n para cargar desde URL y carga por defecto del primer libro
        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const bookParam = params.get('book');
            const chapterParam = params.get('chapter');
            const verseParam = params.get('verse');

            if (bookParam) {
                currentBook = bookParam;
                currentChapter = chapterParam ? parseInt(chapterParam) : 1;
                currentVerse = verseParam ? parseInt(verseParam) : 0;
            } else {
                // Cargar primer libro por defecto
                const firstBookElem = xmlDoc.getElementsByTagName('b')[0];
                currentBook = firstBookElem.getAttribute('n');
                currentChapter = 1;
                currentVerse = 0;
            }

            // Actualizar selector de libros y cargar cap√≠tulo
            const bookSelect = document.getElementById('book-select');
            bookSelect.value = currentBook;
            loadChapters();
            loadChapter();
            updateControls();
        }

        // Iniciar la aplicaci√≥n
        async function init() {
            try {
                console.log('[Init] Iniciando carga de la Biblia...');
                console.log(`[Init] Cargando versi√≥n: ${currentVersion}`);
                await loadBible(currentVersion);
                setupBookSelector();
                loadFromUrl();
                console.log('[Init] Aplicaci√≥n inicializada correctamente');
            } catch (error) {
                console.error('[Init] Error durante la inicializaci√≥n:', error);
                document.getElementById('verses').innerHTML = `
                    <div class="error">
                        <p>Error al cargar la Biblia. Por favor, recarga la p√°gina.</p>
                        <p>${error.message}</p>
                    </div>`;
            }
        }

        init();

        // Deshabilitado Service Worker para evitar cach√© en lectura.html
        // if('serviceWorker' in navigator) {
        //     navigator.serviceWorker.register('service-worker.js');
        // }
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault(); deferredPrompt = e;
            document.getElementById('install-button').style.display = 'block';
        });
        document.getElementById('install-button').addEventListener('click', async () => {
            deferredPrompt.prompt();
            await deferredPrompt.userChoice;
            document.getElementById('install-button').style.display = 'none';
            deferredPrompt = null;
        });
    </script>
    <script>
        // Cargar tama√±o de fuente guardado
        const savedSize = localStorage.getItem('verseFontSize');
        const defaultSize = 16; // Tama√±o de fuente predeterminado
        const minSize = 12;     // Tama√±o m√≠nimo de fuente
        const maxSize = 24;     // Tama√±o m√°ximo de fuente
        const step = 2;         // Incremento/decremento de tama√±o
        
        // Funci√≥n para actualizar el tama√±o de fuente mostrado
        function updateFontSizeDisplay(size) {
            const sizeDisplay = document.querySelector('.font-size-display');
            if (sizeDisplay) {
                sizeDisplay.textContent = `${size}px`;
            }
        }
        
        // Inicializar tama√±o de fuente
        if (savedSize) {
            const size = parseFloat(savedSize);
            if (!isNaN(size) && size >= minSize && size <= maxSize) {
                document.documentElement.style.setProperty('--verse-font-size', size + 'px');
                updateFontSizeDisplay(size);
            } else {
                // Si el valor guardado no es v√°lido, usar el valor predeterminado
                document.documentElement.style.setProperty('--verse-font-size', defaultSize + 'px');
                localStorage.setItem('verseFontSize', defaultSize);
                updateFontSizeDisplay(defaultSize);
            }
        } else {
            // Usar valor predeterminado si no hay valor guardado
            document.documentElement.style.setProperty('--verse-font-size', defaultSize + 'px');
            updateFontSizeDisplay(defaultSize);
        }
        
        // Ajustar tama√±o de fuente globalmente
        function adjustFontSize(delta) {
            const root = document.documentElement;
            const current = parseFloat(getComputedStyle(root).getPropertyValue('--verse-font-size'));
            // Calcular nuevo tama√±o con l√≠mites
            let newSize = current + (delta * step);
            newSize = Math.max(minSize, Math.min(newSize, maxSize));
            
            // Aplicar solo si hubo cambio
            if (newSize !== current) {
                root.style.setProperty('--verse-font-size', newSize + 'px');
                localStorage.setItem('verseFontSize', newSize);
                updateFontSizeDisplay(newSize);
            }
        }
        
        // Funci√≥n para restablecer el tama√±o de fuente
        function resetFontSize() {
            document.documentElement.style.setProperty('--verse-font-size', defaultSize + 'px');
            localStorage.setItem('verseFontSize', defaultSize);
            updateFontSizeDisplay(defaultSize);
        }
        
        // A√±adir manejadores de eventos una vez que el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            // Manejador para el bot√≥n de reinicio
            const resetBtn = document.getElementById('reset-font');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetFontSize);
            }
            
            // Manejadores para los botones de tama√±o de fuente
            const decreaseBtn = document.getElementById('decrease-font');
            const increaseBtn = document.getElementById('increase-font');
            
            if (decreaseBtn) {
                decreaseBtn.addEventListener('click', () => adjustFontSize(-1));
            }
            if (increaseBtn) {
                increaseBtn.addEventListener('click', () => adjustFontSize(1));
            }
        });
    </script>
    <script>
        // Toggle side menu
        const menuToggle = document.getElementById('main-menu-toggle');
        const extraControls = document.getElementById('extra-controls');
        const sideMenuToggleBtn = document.getElementById('side-menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        
        if (menuToggle && extraControls) {
            menuToggle.addEventListener('click', () => extraControls.classList.toggle('active'));
        }
        if (sideMenuToggleBtn && sideMenu) {
            sideMenuToggleBtn.addEventListener('click', () => sideMenu.classList.toggle('active'));
        }
        // Cerrar men√∫ lateral al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (sideMenu.classList.contains('active') && !sideMenu.contains(e.target) && !sideMenuToggleBtn.contains(e.target)) {
                sideMenu.classList.remove('active');
            }
        });
        // Agregar listener al item de cap√≠tulos
        const chapterMenuToggle = document.getElementById('chapter-menu-toggle');
        if (chapterMenuToggle) chapterMenuToggle.addEventListener('click', () => {
            showChapterGrid();
            sideMenu.classList.remove('active');
        });
    </script>
    <script>
        // Chapter & verse grid selection
        function showChapterGrid() {
            const grid = document.getElementById('chapter-grid');
            const chapters = xmlDoc.querySelector(`b[n="${currentBook}"]`).getElementsByTagName('c');
            const chapterButtons = Array.from(chapters).map((_, i) =>
                `<button class="chapter-btn" data-chap="${i+1}">Cap√≠tulo ${i+1}</button>`
            ).join('');
            grid.innerHTML = `<div class="grid-content">
                <div class="grid-header">
                    <span>Selecciona Cap√≠tulo</span><span class="close-grid" data-target="chapter-grid">&times;</span>
                </div>
                ${chapterButtons}
            </div>`;
            grid.classList.add('active');
        }
        function showVerseGrid() {
            const grid = document.getElementById('verse-grid');
            const verses = xmlDoc.querySelector(`b[n="${currentBook}"] c[n="${currentChapter}"]`).getElementsByTagName('v');
            const buttons = Array.from(verses)
                .map(v => `<button class="chapter-btn" data-verse="${v.getAttribute('n')}">Vers√≠culo ${v.getAttribute('n')}</button>`)
                .join('');
            grid.innerHTML = `<div class="grid-content">
                <div class="grid-header">
                    <span>Selecciona Vers√≠culo</span><span class="close-grid" data-target="verse-grid">&times;</span>
                </div>
                ${buttons}
            </div>`;
            grid.classList.add('active');
        }
        // Handle chapter button click
        document.getElementById('chapter-grid').addEventListener('click', e => {
            const chap = e.target.dataset.chap;
            if (!chap) return;
            currentChapter = parseInt(chap, 10);
            document.getElementById('chapter-grid').classList.remove('active');
            updateControls();
            showVerseGrid();
        });
        // Handle verse button click
        document.getElementById('verse-grid').addEventListener('click', e => {
            if (!e.target.dataset.verse) return;
            currentVerse = parseInt(e.target.dataset.verse);
            document.getElementById('verse-grid').classList.remove('active');
            loadChapter(); updateControls(); updateURL();
        });
        // Close modal grids
        document.addEventListener('click', e => {
            if (e.target.classList.contains('close-grid')) {
                document.getElementById(e.target.dataset.target).classList.remove('active');
            }
        });
    </script>
    <script>
        // Bind bot√≥n 'Cap√≠tulo' inferior al grid principal
        document.getElementById('chapter-button').addEventListener('click', showChapterGrid);
        // Bind selector de libro para abrir grid de cap√≠tulos
        document.getElementById('book-select').addEventListener('change', e => {
            currentBook = e.target.value;
            currentChapter = 1;
            updateControls();
            updateURL();
            showChapterGrid();
        });
    </script>
    <script>
        // Populate verse-select with verses of current chapter
        function populateVerseSelect() {
            const verseSelect = document.getElementById('verse-select');
            const verses = xmlDoc.querySelector(`b[n="${currentBook}"] c[n="${currentChapter}"]`).getElementsByTagName('v');
            verseSelect.innerHTML = '<option value="" disabled selected>Selecciona un vers√≠culo</option>';
            Array.from(verses).forEach(v => {
                const num = v.getAttribute('n');
                const opt = document.createElement('option');
                opt.value = num;
                opt.textContent = 'Vers√≠culo ' + num;
                verseSelect.appendChild(opt);
            });
            verseSelect.disabled = false;
        }
        // Handle verse selection
        document.getElementById('verse-select').addEventListener('change', (e) => {
            currentVerse = parseInt(e.target.value);
            loadChapter();
            updateControls();
            updateURL();
        });
    </script>
    <script>
        // Obtiene los temas directamente del XML
        function getOutlines(book, chapter) {
            const nodes = xmlDoc.querySelectorAll(`b[n="${book}"] c[n="${chapter}"] o`);
            return Array.from(nodes).map(o => ({
                title: o.getAttribute('title'),
                start: parseInt(o.getAttribute('start'), 10),
                end: parseInt(o.getAttribute('end'), 10)
            }));
        }

        // Muestra modal de temas
        function showOutlineGrid() {
            const grid = document.getElementById('outline-grid');
            const outlines = getOutlines(currentBook, currentChapter);
            const header = `<div class="grid-header"><span>Temas ${currentBook} ${currentChapter}</span><span class="close-grid" data-target="outline-grid">&times;</span></div>`;
            if (outlines.length === 0) {
                grid.innerHTML = `<div class="grid-content">${header}<div style="padding:10px;text-align:center;">No hay temas disponibles</div></div>`;
            } else {
                const buttons = outlines.map(o =>
                    `<button class="chapter-btn" data-start="${o.start}" data-end="${o.end}">${o.title}</button>`
                ).join('');
                grid.innerHTML = `<div class="grid-content">${header}${buttons}</div>`;
            }
            grid.classList.add('active');
        }
        // Maneja selecci√≥n de tema
        document.getElementById('outline-grid').addEventListener('click', e => {
            if (!e.target.dataset.start) return;
            const start = parseInt(e.target.dataset.start, 10);
            currentVerse = start;
            document.getElementById('outline-grid').classList.remove('active');
            loadChapter(); updateControls(); updateURL();
            setTimeout(() => {
                const el = document.querySelector(`.verse[data-verse="${start}"]`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        });
        // Listener Bot√≥n Temas
        document.getElementById('outline-button').addEventListener('click', showOutlineGrid);
    </script>
    <script>
        // Annotate strong numbers - Funci√≥n segura que no falla si no hay datos
        function annotateStrongNumbers() {
            try {
                const verseEls = document.querySelectorAll('.verse-text');
                if (!strongsData || Object.keys(strongsData).length === 0) {
                    console.log('No hay datos de Strong disponibles para anotaciones');
                    return;
                }
                
                const wordMap = {};
                for (const code in strongsData) {
                    const entry = strongsData[code];
                    if (entry && entry.word) {
                        wordMap[entry.word.toLowerCase()] = code;
                    }
                }
                
                verseEls.forEach(el => {
                    el.innerHTML = el.textContent.replace(/\b(\w+)\b/g, (match) => {
                        const code = wordMap[match.toLowerCase()];
                        return code ? `<span class="strong-word" data-strong="${code}">${match}</span>` : match;
                    });
                });
            } catch (error) {
                console.error('Error al anotar n√∫meros de Strong:', error);
            }
        }
        document.body.addEventListener('click', e => {
            const sw = e.target.closest('.strong-word');
            if (!sw) return;
            const info = strongsData[sw.dataset.strong];
            if (!info) return;
            document.getElementById('strongs-content').innerHTML = '<strong>' + info.word + ' (' + sw.dataset.strong + ')</strong><br>' +
                'Translit: ' + info.translit + '<br>' +
                'Def: ' + info.meaning;
            document.getElementById('strongs-backdrop').style.display = 'block';
            document.getElementById('strongs-modal').style.display = 'block';
        });
        document.getElementById('strongs-close').addEventListener('click', () => {
            document.getElementById('strongs-backdrop').style.display = 'none';
            document.getElementById('strongs-modal').style.display = 'none';
        });
        const origLoadChapter = window.loadChapter;
        window.loadChapter = async function() {
            await origLoadChapter();
            annotateStrongNumbers();
            applySavedStates();
        };
        // Reaplicar marcas guardadas: marcados, comentarios y memorizados
        function applySavedStates() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            const comments = JSON.parse(localStorage.getItem('comments') || '{}');
            const memorized = JSON.parse(localStorage.getItem('memorized') || '[]');
            document.querySelectorAll('#verses .verse').forEach(v => {
                const key = `${currentBook}-${currentChapter}-${v.dataset.verse}`;
                if (bookmarks.includes(key)) v.classList.add('bookmarked');
                if (comments[key]) v.classList.add('comment');
                if (memorized.includes(key)) v.classList.add('memorized');
            });
        }
        // Aplicar anotaciones y estados guardados al cargar la p√°gina
        window.addEventListener('load', () => {
            annotateStrongNumbers();
            applySavedStates();
            
            // Cargar notas guardadas al iniciar
            const savedNotes = localStorage.getItem('bible_notes');
            if (savedNotes) {
                notes = JSON.parse(savedNotes);
                renderNotesList();
            }
        });
    </script>
    <script>
        // B√∫squeda de vers√≠culos en toda la Biblia y resaltado de t√©rmino
        const searchWrapper = document.querySelector('.search-wrapper');
        const searchButton = document.getElementById('search-button');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const resultsContent = document.getElementById('results-content');
        const closeSearchBtn = document.getElementById('close-search');
        // Escapar texto para RegExp
        function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\\]\\]/g, '\\\\$&'); }
        searchButton.addEventListener('click', () => {
            searchWrapper.classList.toggle('active');
            if (searchWrapper.classList.contains('active')) searchInput.focus();
        });

        // Manejador para el bot√≥n de per√≠copas
        document.getElementById('pericopes-button').addEventListener('click', () => {
            mostrarPericopas();
        });
        searchInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                const rawQuery = searchInput.value.trim();
                if (!rawQuery) return;
                const query = rawQuery.toLowerCase();
                resultsContent.innerHTML = '';
                // Buscar en todo xmlDoc (toda la Biblia)
                const verses = Array.from(xmlDoc.querySelectorAll('b c v'));
                // Modificado para buscar solo palabras completas
                const regex = new RegExp(`\\b${escapeRegExp(query)}\\b`, 'gi');
                const matches = verses.filter(v => {
                    // Buscar solo palabras completas usando l√≠mites de palabra \b
                    return new RegExp(`\\b${escapeRegExp(query)}\\b`, 'i').test(v.textContent);
                });
                const resultsCount = document.getElementById('search-results-count');
                resultsCount.textContent = `${matches.length} ${matches.length === 1 ? 'resultado' : 'resultados'}`;
                
                if (matches.length) {
                    matches.forEach(v => {
                        const verseNum = v.getAttribute('n');
                        const chapterNum = v.parentNode.getAttribute('n');
                        const bookName = v.parentNode.parentNode.getAttribute('n');
                        const text = v.textContent;
                        // Resaltar t√©rmino
                        const highlighted = text.replace(regex, match => `<mark>${match}</mark>`);
                        const item = document.createElement('div');
                        item.className = 'result-item';
                        item.innerHTML = `<div class="result-book">${bookName} ${chapterNum}:${verseNum}</div><div class="result-text">${highlighted}</div>`;
                        item.addEventListener('click', () => {
                            searchResults.classList.remove('active');
                            // Navegar a cap√≠tulo y vers√≠culo
                            currentBook = bookName;
                            currentChapter = parseInt(chapterNum);
                            currentVerse = parseInt(verseNum);
                            document.getElementById('book-select').value = currentBook;
                            loadChapters(); loadChapter(); updateControls(); updateURL();
                            setTimeout(() => {
                                const el = document.querySelector(`.verse[data-verse="${currentVerse}"]`);
                                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        });
                        resultsContent.appendChild(item);
                    });
                    searchResults.classList.add('active');
                } else {
                    resultsCount.textContent = '0 resultados';
                    alert('No se encontraron resultados');
                }
            }
        });
        closeSearchBtn.addEventListener('click', () => {
            searchResults.classList.remove('active');
        });
    </script>
    <script>
        // Men√∫ contextual al hacer doble clic en vers√≠culo
        const verseContainer = document.getElementById('verses');
        const verseMenu = document.getElementById('verse-menu');
        let activeVerseEl = null;
        // Funci√≥n para mostrar el men√∫ contextual
        function showVerseMenu(verseEl, x, y) {
            if (!verseEl) return;
            activeVerseEl = verseEl;
            
            // Verificar si el vers√≠culo ya tiene un comentario
            const verseNum = verseEl.dataset.verse;
            const key = `${currentBook}-${currentChapter}-${verseNum}`;
            const comments = JSON.parse(localStorage.getItem('comments') || '{}');
            const hasComment = !!comments[key];
            
            // Actualizar el texto del bot√≥n de comentario
            const commentBtn = document.getElementById('menu-add-comment');
            commentBtn.textContent = hasComment ? 'Ver/Editar Comentario' : 'Agregar Comentario';
            
            // Posicionar y mostrar el men√∫
            verseMenu.style.left = `${x}px`;
            verseMenu.style.top = `${y}px`;
            verseMenu.style.display = 'block';
        }

        // Mostrar men√∫ contextual al hacer clic derecho en un vers√≠culo
        verseContainer.addEventListener('contextmenu', (e) => {
            const verseEl = e.target.closest('.verse');
            if (!verseEl) return;
            e.preventDefault();
            showVerseMenu(verseEl, e.clientX, e.clientY);
        });

        // Mostrar men√∫ contextual al hacer doble clic en un vers√≠culo
        verseContainer.addEventListener('dblclick', (e) => {
            const verseEl = e.target.closest('.verse');
            if (!verseEl) return;
            e.preventDefault();
            const rect = verseEl.getBoundingClientRect();
            showVerseMenu(verseEl, rect.left + window.scrollX + 10, rect.top + window.scrollY + 10);
        });
        document.addEventListener('click', e => {
            if (!e.target.closest('#verse-menu')) {
                verseMenu.style.display = 'none';
            }
        });
        document.getElementById('menu-toggle-bookmark').addEventListener('click', () => {
            if (!activeVerseEl) return;
            activeVerseEl.classList.toggle('bookmarked');
            const key = currentBook + '-' + currentChapter + '-' + activeVerseEl.dataset.verse;
            let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            if (activeVerseEl.classList.contains('bookmarked')) {
                if (!bookmarks.includes(key)) bookmarks.push(key);
            } else {
                bookmarks = bookmarks.filter(k => k !== key);
            }
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            verseMenu.style.display = 'none';
        });
        // Funci√≥n para abrir el modal de comentarios
        function openCommentModal(verseEl) {
            if (!verseEl) return;
            activeVerseEl = verseEl;
            const verseNum = verseEl.dataset.verse;
            const key = `${currentBook}-${currentChapter}-${verseNum}`;
            const comments = JSON.parse(localStorage.getItem('comments') || '{}');
            const existingComment = comments[key] || '';
            
            // Actualizar el t√≠tulo del modal
            const modalTitle = document.querySelector('#comment-modal h3');
            modalTitle.textContent = existingComment ? 'Editar Comentario' : 'Agregar Comentario';
            
            // Cargar el comentario existente si existe
            document.getElementById('modal-comment-input').value = existingComment;
            
            // Mostrar el modal
            document.getElementById('comment-backdrop').style.display = 'block';
            document.getElementById('comment-modal').style.display = 'block';
            verseMenu.style.display = 'none';
            
            // Enfocar el textarea
            document.getElementById('modal-comment-input').focus();
        }
        
        // Manejador para el bot√≥n de agregar/editar comentario
        document.getElementById('menu-add-comment').addEventListener('click', () => {
            if (!activeVerseEl) return;
            openCommentModal(activeVerseEl);
        });
        
        // Manejador para el bot√≥n de guardar comentario
        document.getElementById('modal-save-btn').addEventListener('click', () => {
            if (!activeVerseEl) return;
            
            const comment = document.getElementById('modal-comment-input').value.trim();
            const verseNum = activeVerseEl.dataset.verse;
            const key = `${currentBook}-${currentChapter}-${verseNum}`;
            const comments = JSON.parse(localStorage.getItem('comments') || '{}');
            
            if (comment) {
                // Actualizar o agregar comentario
                activeVerseEl.classList.add('comment');
                activeVerseEl.dataset.comment = comment;
                comments[key] = comment;
                // Actualizar el t√≠tulo del bot√≥n si es necesario
                document.querySelector('#menu-add-comment').textContent = 'Editar Comentario';
            } else {
                // Eliminar comentario si est√° vac√≠o
                delete comments[key];
                activeVerseEl.classList.remove('comment');
                delete activeVerseEl.dataset.comment;
                // Actualizar el t√≠tulo del bot√≥n
                document.querySelector('#menu-add-comment').textContent = 'Agregar Comentario';
            }
            
            // Guardar cambios
            localStorage.setItem('comments', JSON.stringify(comments));
            
            // Cerrar modal
            document.getElementById('comment-modal').style.display = 'none';
            document.getElementById('comment-backdrop').style.display = 'none';
            document.getElementById('modal-comment-input').value = '';
        });
        document.getElementById('modal-cancel-btn').addEventListener('click', () => {
            document.getElementById('comment-modal').style.display = 'none';
            document.getElementById('comment-backdrop').style.display = 'none';
            document.getElementById('modal-comment-input').value = '';
        });
        document.getElementById('menu-memorize-verse').addEventListener('click', () => {
            if (!activeVerseEl) return;
            activeVerseEl.classList.toggle('memorized');
            const key = currentBook + '-' + currentChapter + '-' + activeVerseEl.dataset.verse;
            let memorized = JSON.parse(localStorage.getItem('memorized') || '[]');
            if (activeVerseEl.classList.contains('memorized')) {
                if (!memorized.includes(key)) memorized.push(key);
            } else {
                memorized = memorized.filter(k => k !== key);
            }
            localStorage.setItem('memorized', JSON.stringify(memorized));
            verseMenu.style.display = 'none';
        });
        document.getElementById('menu-copy-verse').addEventListener('click', () => {
            if (!activeVerseEl) return;
            const text = activeVerseEl.querySelector('.verse-text').textContent;
            navigator.clipboard.writeText(text);
            verseMenu.style.display = 'none';
        });
    </script>
    <!-- SOLUCION FINAL: Per√≠copas 100% en espa√±ol con datos completos -->
    <script src="pericopas-datos-completo.js?v=20250519-2031"></script>
    
    <script>
        // Sistema simplificado de per√≠copas en espa√±ol
        (function() {
            // Desactivar cualquier sistema anterior
            if (window.initPericopesInterface) window.initPericopesInterface = function() {};
            if (window.showPericopes) window.showPericopes = function() {};
            
            // Variables globales para los elementos del formulario
            let noteTitle, noteContent;
            
            // Cargar borrador de nota si existe
            function loadDraftNote() {
                // Asegurarse de que los elementos del formulario est√©n disponibles
                noteTitle = document.getElementById('note-title');
                noteContent = document.getElementById('note-content');
                
                if (!noteTitle || !noteContent) {
                    console.error('No se encontraron los elementos del formulario de notas');
                    return;
                }
                
                const draft = localStorage.getItem('bible-note-draft');
                if (draft) {
                    try {
                        const { title, content } = JSON.parse(draft);
                        noteTitle.value = title || '';
                        noteContent.value = content || '';
                    } catch (e) {
                        console.error('Error al cargar el borrador de la nota:', e);
                        localStorage.removeItem('bible-note-draft'); // Limpiar borrador corrupto
                    }
                }
            }
            
            // Guardar borrador de nota
            function saveDraftNote() {
                try {
                    // Asegurarse de que los elementos del formulario est√©n disponibles
                    if (!noteTitle) noteTitle = document.getElementById('note-title');
                    if (!noteContent) noteContent = document.getElementById('note-content');
                    
                    if (noteTitle && noteContent) {
                        const draft = {
                            title: noteTitle.value || '',
                            content: noteContent.value || ''
                        };
                        localStorage.setItem('bible-note-draft', JSON.stringify(draft));
                    }
                } catch (e) {
                    console.error('Error al guardar el borrador de la nota:', e);
                }
            }
            
            // Inicializar el sistema de notas
            document.addEventListener('DOMContentLoaded', function() {
                // Cargar borrador al iniciar
                loadDraftNote();
                
                // Guardar borrador cada vez que se escriba en los campos
                if (noteTitle) {
                    noteTitle.addEventListener('input', saveDraftNote);
                }
                if (noteContent) {
                    noteContent.addEventListener('input', saveDraftNote);
                }
                console.log('Inicializando per√≠copas 100% en espa√±ol');
                
                // Procesar par√°metros de URL para navegaci√≥n directa
                setTimeout(function() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const libro = urlParams.get('book');
                    const capitulo = urlParams.get('chapter');
                    const versiculo = urlParams.get('verse');
                    
                    if (libro && capitulo) {
                        console.log(`Intentando navegar a ${libro} ${capitulo}:${versiculo || '1'}`);
                        cargarCapitulo(libro, capitulo, versiculo);
                    }
                }, 500);
                
                // Agregar bot√≥n de per√≠copas cuando cargue un cap√≠tulo
                agregarBotonPericopas();
                const observer = new MutationObserver(function() {
                    agregarBotonPericopas();
                });
                observer.observe(document.body, { childList: true, subtree: true });
            });
            
            // Funci√≥n para cargar cap√≠tulos
            function cargarCapitulo(libro, capitulo, versiculo) {
                // Simular clics en selectores
                const selectorLibro = document.querySelector('select.book-select');
                const selectorCapitulo = document.querySelector('select.chapter-select');
                
                if (selectorLibro && selectorCapitulo) {
                    // Seleccionar libro
                    for (let i = 0; i < selectorLibro.options.length; i++) {
                        if (selectorLibro.options[i].textContent.includes(libro)) {
                            selectorLibro.selectedIndex = i;
                            selectorLibro.dispatchEvent(new Event('change'));
                            break;
                        }
                    }
                    
                    // Esperar un momento y seleccionar cap√≠tulo
                    setTimeout(() => {
                        for (let i = 0; i < selectorCapitulo.options.length; i++) {
                            if (selectorCapitulo.options[i].value == capitulo) {
                                selectorCapitulo.selectedIndex = i;
                                selectorCapitulo.dispatchEvent(new Event('change'));
                                break;
                            }
                        }
                        
                        // Esperar a que cargue el cap√≠tulo y navegar al vers√≠culo
                        if (versiculo) {
                            setTimeout(() => {
                                const elementoVersiculo = document.querySelector(`.verse[data-verse="${versiculo}"]`);
                                if (elementoVersiculo) {
                                    elementoVersiculo.scrollIntoView({ behavior: 'smooth' });
                                    elementoVersiculo.classList.add('highlight');
                                    setTimeout(() => elementoVersiculo.classList.remove('highlight'), 2000);
                                }
                            }, 500);
                        }
                    }, 300);
                }
            }
            
            // Funci√≥n para mostrar per√≠copas
            window.mostrarPericopas = function() {
                console.log('[Per√≠copas] Iniciando b√∫squeda de per√≠copas...');
                
                // Obtener libro y cap√≠tulo actuales
                const titulo = document.querySelector('.chapter-title');
                if (!titulo) {
                    console.error('[Per√≠copas] No se pudo encontrar el t√≠tulo del cap√≠tulo');
                    return;
                }
                
                const tituloTexto = titulo.textContent.trim();
                console.log('[Per√≠copas] T√≠tulo del cap√≠tulo:', tituloTexto);
                
                // Intentar con el formato "Libro - Cap√≠tulo X" primero
                let match = tituloTexto.match(/(.+?)\s*-\s*Cap√≠tulo\s*(\d+)/i);
                
                // Si no coincide, intentar con el formato anterior por si acaso
                if (!match) {
                    match = tituloTexto.match(/([A-Za-z\u00C0-\u00FF\s]+)\s+(\d+)/);
                }
                
                if (!match) {
                    console.error('[Per√≠copas] No se pudo extraer libro y cap√≠tulo del t√≠tulo');
                    return;
                }
                
                let nombreLibro = match[1].trim();
                const capitulo = match[2];
                
                // Si el nombre del libro est√° vac√≠o, usar la variable global currentBook
                if (!nombreLibro && window.currentBook) {
                    nombreLibro = window.currentBook;
                    console.log('[Per√≠copas] Usando currentBook como nombre del libro:', nombreLibro);
                }
                
                const libroKey = obtenerCodigoLibro(nombreLibro);
                
                console.log('[Per√≠copas] Datos extra√≠dos:', { 
                    nombreLibro, 
                    capitulo, 
                    libroKey,
                    currentBook: window.currentBook // Variable global que deber√≠a existir
                });
                
                // Verificar si PERICOPES_DATA est√° disponible
                if (typeof window.PERICOPES_DATA === 'undefined') {
                    console.error('[Per√≠copas] Error: PERICOPES_DATA no est√° definido');
                    alert('Error: No se pudieron cargar los datos de per√≠copas');
                    return;
                }
                
                // Intentar con el c√≥digo del libro y tambi√©n con el nombre del libro actual
                const clavesABuscar = [
                    `${libroKey}-${capitulo}`,
                    `${window.currentBook || ''}-${capitulo}`.toUpperCase()
                ];
                
                console.log('[Per√≠copas] Buscando per√≠copas con claves:', clavesABuscar);
                
                let pericopas = [];
                let claveEncontrada = '';
                
                // Buscar en todas las claves posibles
                for (const clave of clavesABuscar) {
                    if (window.PERICOPES_DATA[clave]) {
                        pericopas = window.PERICOPES_DATA[clave];
                        claveEncontrada = clave;
                        break;
                    }
                }
                
                console.log('[Per√≠copas] Resultados de b√∫squeda:', {
                    claveEncontrada,
                    cantidadPericopas: pericopas.length,
                    muestrasClaves: Object.keys(window.PERICOPES_DATA).slice(0, 5)
                });
                
                if (pericopas.length === 0) {
                    const mensaje = `No hay per√≠copas disponibles para ${nombreLibro} ${capitulo} (${libroKey}-${capitulo})`;
                    console.warn('[Per√≠copas]', mensaje);
                    alert(mensaje);
                    return;
                }
                
                // Crear modal si no existe
                crearModalPericopas();
                
                // Actualizar contenido
                const contenido = document.getElementById('pericopes-content');
                contenido.innerHTML = '';
                pericopas.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'pericope-item';
                    div.innerHTML = `
                        <div class="pericope-title">${p.title}</div>
                        <div class="pericope-verses">Vers√≠culos ${p.verses}</div>
                    `;
                    div.onclick = () => {
                        document.getElementById('pericopes-modal').style.display = 'none';
                        document.getElementById('pericopes-backdrop').style.display = 'none';
                        const verso = document.querySelector(`.verse[data-verse="${p.startVerseId}"]`);
                        if (verso) {
                            verso.scrollIntoView({ behavior: 'smooth' });
                            verso.classList.add('highlight');
                            setTimeout(() => verso.classList.remove('highlight'), 2000);
                        }
                    };
                    contenido.appendChild(div);
                });
                
                // Mostrar modal
                document.getElementById('pericopes-modal').style.display = 'block';
                document.getElementById('pericopes-backdrop').style.display = 'block';
            };
            
            // Funci√≥n para crear modal de per√≠copas
            function crearModalPericopas() {
                if (document.getElementById('pericopes-modal')) return;
                
                // Estilos
                const estilos = document.createElement('style');
                estilos.textContent = `
                    #pericopes-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                      background-color: rgba(0,0,0,0.5); z-index: 9998; }
                    #pericopes-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                      background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                      z-index: 9999; max-width: 90%; width: 500px; max-height: 80vh; overflow-y: auto; }
                    #pericopes-header { display: flex; justify-content: space-between; align-items: center;
                      margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
                    #pericopes-title { font-size: 18px; font-weight: bold; }
                    #pericopes-close { background: none; border: none; font-size: 24px; cursor: pointer; }
                    .pericope-item { padding: 10px; margin-bottom: 10px; background-color: #f9f9f9;
                      border-radius: 5px; cursor: pointer; transition: all 0.2s; }
                    .pericope-item:hover { background-color: #eaeaea; }
                    .pericope-title { font-weight: bold; margin-bottom: 5px; }
                    .pericope-verses { font-size: 12px; color: #666; }
                    #pericopas-boton { display: inline-block; background-color: var(--primary-color, #4CAF50);
                      color: white; padding: 6px 12px; border-radius: 4px; margin: 10px 0; cursor: pointer; }
                    .verse.highlight { background-color: #ffff99; transition: background-color 1s; }
                `;
                document.head.appendChild(estilos);
                
                // Backdrop
                const backdrop = document.createElement('div');
                backdrop.id = 'pericopes-backdrop';
                backdrop.style.display = 'none';
                backdrop.onclick = () => {
                    document.getElementById('pericopes-modal').style.display = 'none';
                    backdrop.style.display = 'none';
                };
                document.body.appendChild(backdrop);
                
                // Modal
                const modal = document.createElement('div');
                modal.id = 'pericopes-modal';
                modal.style.display = 'none';
                modal.innerHTML = `
                    <div id="pericopes-header">
                        <div id="pericopes-title">Per√≠copas del cap√≠tulo</div>
                        <button id="pericopes-close">&times;</button>
                    </div>
                    <div id="pericopes-content"></div>
                `;
                document.body.appendChild(modal);
                
                // Bot√≥n cerrar
                document.getElementById('pericopes-close').onclick = () => {
                    modal.style.display = 'none';
                    backdrop.style.display = 'none';
                };
            }
            
            // Funci√≥n para agregar bot√≥n de per√≠copas
            function agregarBotonPericopas() {
                console.log('[Per√≠copas] Iniciando agregarBotonPericopas');
                
                // Verificar si ya existe el bot√≥n
                if (document.getElementById('pericopas-boton')) {
                    console.log('[Per√≠copas] El bot√≥n ya existe');
                    return;
                }
                
                // Verificar si los datos de per√≠copas est√°n disponibles
                console.log('[Per√≠copas] Verificando datos de per√≠copas...');
                if (typeof PERICOPES_DATA === 'undefined') {
                    console.warn('[Per√≠copas] Los datos de per√≠copas no est√°n disponibles (PERICOPES_DATA no est√° definido)');
                    console.log('[Per√≠copas] Verificando si window.PERICOPES_DATA existe:', typeof window.PERICOPES_DATA);
                    return;
                }
                
                console.log('[Per√≠copas] Datos de per√≠copas disponibles:', Object.keys(PERICOPES_DATA).length > 0);
                console.log('[Per√≠copas] Muestra de claves de per√≠copas:', Object.keys(PERICOPES_DATA).slice(0, 5));
                
                // Obtener libro y cap√≠tulo actual
                const libroActual = document.getElementById('book-select')?.value;
                const capituloActual = parseInt(document.getElementById('chapter-select')?.value) || 1;
                
                if (!libroActual) return;
                
                // Obtener el c√≥digo del libro
                const codigoLibro = window.obtenerCodigoLibro?.(libroActual);
                if (!codigoLibro) {
                    console.warn('[Per√≠copas] No se pudo obtener el c√≥digo del libro:', libroActual);
                    return;
                }
                
                const clavePericopa = `${codigoLibro}-${capituloActual}`;
                const pericopas = PERICOPES_DATA[clavePericopa];
                
                // Si no hay per√≠copas para este cap√≠tulo, no mostrar el bot√≥n
                if (!pericopas || pericopas.length === 0) {
                    console.log(`[Per√≠copas] No hay per√≠copas para ${clavePericopa}`);
                    console.log(`[Per√≠copas] Claves disponibles en PERICOPES_DATA:`, Object.keys(PERICOPES_DATA));
                    return;
                }
                
                console.log(`[Per√≠copas] Encontradas ${pericopas.length} per√≠copas para ${clavePericopa}:`, pericopas);
                
                // Crear el bot√≥n
                const boton = document.createElement('button');
                boton.id = 'pericopas-boton';
                boton.className = 'pericopas-btn';
                boton.innerHTML = 'üìñ Ver per√≠copas del cap√≠tulo';
                
                // A√±adir estilos al bot√≥n
                const style = document.createElement('style');
                style.textContent = `
                    .pericopas-btn {
                        display: block;
                        margin: 15px auto;
                        padding: 8px 16px;
                        background-color: var(--primary-color, #4CAF50);
                        color: white;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    }
                    .pericopas-btn:hover {
                        background-color: #45a049;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                    }
                    .pericopas-btn:active {
                        transform: translateY(0);
                    }
                    .pericopas-container {
                        margin: 20px 0;
                        padding: 15px;
                        background-color: rgba(76, 175, 80, 0.1);
                        border-radius: 8px;
                        border-right: 4px solid var(--primary-color, #4CAF50);
                    }
                    .pericopa-item {
                        margin: 15px 0;
                        padding: 12px;
                        background: white;
                        border-radius: 6px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                        border-left: 3px solid var(--primary-color, #4CAF50);
                    }
                    .pericopa-item h4 {
                        margin: 0 0 8px 0;
                        color: #2c3e50;
                        font-size: 1.1em;
                        border-bottom: 1px solid #eee;
                        padding-bottom: 5px;
                    }
                    .pericopa-item p {
                        margin: 8px 0 0 0;
                        color: #34495e;
                        font-size: 0.95em;
                        line-height: 1.6;
                    }
                `;
                document.head.appendChild(style);
                
                // Funci√≥n para mostrar/ocultar las per√≠copas
                function togglePericopas() {
                    let contenedor = document.getElementById('pericopas-container');
                    
                    // Si ya existe, alternar visibilidad
                    if (contenedor) {
                        if (contenedor.style.display === 'none') {
                            contenedor.style.display = 'block';
                            boton.textContent = 'Ocultar per√≠copas';
                        } else {
                            contenedor.style.display = 'none';
                            boton.textContent = 'üìñ Ver per√≠copas del cap√≠tulo';
                        }
                        return;
                    }
                    
                    // Si no existe, crear el contenedor
                    contenedor = document.createElement('div');
                    contenedor.id = 'pericopas-container';
                    contenedor.className = 'pericopas-container';
                    
                    // Agregar t√≠tulo
                    const titulo = document.createElement('h3');
                    titulo.textContent = `Per√≠copas de ${libroActual} ${capituloActual}`;
                    titulo.style.marginTop = '0';
                    titulo.style.color = 'var(--primary-color, #4CAF50)';
                    contenedor.appendChild(titulo);
                    
                    // Agregar cada per√≠copa
                    pericopas.forEach((pericopa, index) => {
                        const item = document.createElement('div');
                        item.className = 'pericopa-item';
                        
                        const tituloPericopa = document.createElement('h4');
                        tituloPericopa.textContent = pericopa.title || `Per√≠copa ${index + 1}`;
                        
                        // Convertir saltos de l√≠nea en p√°rrafos
                        const contenido = document.createElement('div');
                        const parrafos = (pericopa.text || '').split('\n').filter(p => p.trim() !== '');
                        
                        if (parrafos.length > 0) {
                            parrafos.forEach(parrafo => {
                                if (parrafo.trim() !== '') {
                                    const p = document.createElement('p');
                                    p.textContent = parrafo.trim();
                                    contenido.appendChild(p);
                                }
                            });
                        } else {
                            const p = document.createElement('p');
                            p.textContent = pericopa.text || '';
                            contenido.appendChild(p);
                        }
                        
                        item.appendChild(tituloPericopa);
                        item.appendChild(contenido);
                        contenedor.appendChild(item);
                    });
                    
                    // Insertar despu√©s del t√≠tulo del cap√≠tulo
                    const tituloCap = document.querySelector('h2');
                    if (tituloCap) {
                        tituloCap.insertAdjacentElement('afterend', contenedor);
                    } else {
                        // Si no hay t√≠tulo, insertar al principio del contenedor de vers√≠culos
                        const versContainer = document.getElementById('verses');
                        if (versContainer) {
                            versContainer.insertBefore(contenedor, versContainer.firstChild);
                        }
                    }
                    
                    boton.textContent = 'Ocultar per√≠copas';
                }
                
                // Asignar evento al bot√≥n
                boton.onclick = togglePericopas;
                
                // Insertar el bot√≥n despu√©s del t√≠tulo del cap√≠tulo
                const tituloCap = document.querySelector('h2');
                if (tituloCap) {
                    tituloCap.insertAdjacentElement('afterend', boton);
                } else {
                    // Si no hay t√≠tulo, insertar al principio del contenedor de vers√≠culos
                    const versContainer = document.getElementById('verses');
                    if (versContainer) {
                        versContainer.insertBefore(boton, versContainer.firstChild);
                    }
                }
                
                console.log(`[Per√≠copas] Bot√≥n agregado para ${clavePericopa} (${pericopas.length} per√≠copas)`);
            }
            
            // Obtener c√≥digo de libro
            function obtenerCodigoLibro(nombre) {
                const mapeoLibros = {
                    'g√©nesis': 'GEN', 'genesis': 'GEN',
                    '√©xodo': 'EXO', 'exodo': 'EXO',
                    'lev√≠tico': 'LEV', 'levitico': 'LEV',
                    'n√∫meros': 'NUM', 'numeros': 'NUM',
                    'deuteronomio': 'DEU',
                    'josu√©': 'JOS', 'josue': 'JOS',
                    'jueces': 'JDG',
                    'rut': 'RUT',
                    'samuel': 'SA', '1 samuel': '1SA', '2 samuel': '2SA',
                    'reyes': 'KI', '1 reyes': '1KI', '2 reyes': '2KI',
                    'cr√≥nicas': 'CH', 'cronicas': 'CH', '1 cr√≥nicas': '1CH', '2 cr√≥nicas': '2CH',
                    'esdras': 'EZR',
                    'nehem√≠as': 'NEH', 'nehemias': 'NEH',
                    'ester': 'EST',
                    'job': 'JOB',
                    'salmos': 'PSA', 'salmo': 'PSA',
                    'proverbios': 'PRO',
                    'eclesiast√©s': 'ECC', 'eclesiastes': 'ECC',
                    'cantares': 'SNG',
                    'isa√≠as': 'ISA', 'isaias': 'ISA',
                    'jerem√≠as': 'JER', 'jeremias': 'JER',
                    'lamentaciones': 'LAM',
                    'ezequiel': 'EZK',
                    'daniel': 'DAN',
                    'oseas': 'HOS',
                    'joel': 'JOL',
                    'am√≥s': 'AMO', 'amos': 'AMO',
                    'abd√≠as': 'OBA', 'abdias': 'OBA',
                    'jon√°s': 'JON', 'jonas': 'JON',
                    'miqueas': 'MIC',
                    'nah√∫m': 'NAM', 'nahum': 'NAM',
                    'habacuc': 'HAB',
                    'sofon√≠as': 'ZEP', 'sofonias': 'ZEP',
                    'hageo': 'HAG',
                    'zacar√≠as': 'ZEC', 'zacarias': 'ZEC',
                    'malaqu√≠as': 'MAL', 'malaquias': 'MAL',
                    'mateo': 'MAT',
                    'marcos': 'MRK',
                    'lucas': 'LUK',
                    'juan': 'JHN',
                    '1 juan': '1JN', '2 juan': '2JN', '3 juan': '3JN',
                    'hechos': 'ACT',
                    'romanos': 'ROM',
                    'corintios': 'CO', '1 corintios': '1CO', '2 corintios': '2CO',
                    'g√°latas': 'GAL', 'galatas': 'GAL',
                    'efesios': 'EPH',
                    'filipenses': 'PHP',
                    'colosenses': 'COL',
                    'tesalonicenses': 'TH', '1 tesalonicenses': '1TH', '2 tesalonicenses': '2TH',
                    'timoteo': 'TI', '1 timoteo': '1TI', '2 timoteo': '2TI',
                    'tito': 'TIT',
                    'filem√≥n': 'PHM', 'filemon': 'PHM',
                    'hebreos': 'HEB',
                    'santiago': 'JAS',
                    'pedro': 'PE', '1 pedro': '1PE', '2 pedro': '2PE',
                    // 'juan' ya est√° mapeado a 'JHN' m√°s arriba
                    'judas': 'JUD',
                    'apocalipsis': 'REV'
                };
                
                // Normalizar nombre (quitar acentos, min√∫sculas)
                const normalizado = nombre.normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .toLowerCase();
                
                // Buscar coincidencia exacta
                if (mapeoLibros[normalizado]) return mapeoLibros[normalizado];
                
                // Extraer n√∫mero si existe (ej. "1 Corintios" -> "1" y "Corintios")
                const match = normalizado.match(/^(\d+)\s*(.+)$/); 
                if (match && mapeoLibros[match[2]]) {
                    return match[1] + mapeoLibros[match[2]];
                }
                
                // Si no se encuentra, devolver el mismo nombre (para debug)
                return nombre;
            }
        })();
    </script>
    
    <!-- Cargar datos de per√≠copas primero -->
    <script src="pericopas-datos-completo.js"></script>
    <script>
        // Verificar que las per√≠copas est√©n correctamente cargadas
        console.log('[Per√≠copas] Estado de carga:', {
            pericopesDisponibles: typeof PERICOPES_DATA !== 'undefined',
            totalCapitulos: typeof PERICOPES_DATA !== 'undefined' ? Object.keys(PERICOPES_DATA).length : 0
        });
        
        // Mostrar algunos ejemplos de per√≠copas cargadas
        if (typeof PERICOPES_DATA !== 'undefined') {
            // Mostrar un ejemplo de Tito cap√≠tulo 1
            const titoCap1 = PERICOPES_DATA['TIT-1'] || [];
            console.log('[Per√≠copas] Ejemplo de Tito 1:', titoCap1);
            
            // Mostrar libros disponibles (solo los primeros 5 para no saturar la consola)
            const libros = Object.keys(PERICOPES_DATA);
            console.log('[Per√≠copas] Total de cap√≠tulos con per√≠copas:', libros.length);
            console.log('[Per√≠copas] Ejemplos de cap√≠tulos con per√≠copas:', libros.slice(0, 5));
            
            // Verificar si hay datos para el libro actual
            function verificarPericopasDisponibles(libro, capitulo) {
                const clave = `${libro}-${capitulo}`;
                const tienePericopas = PERICOPES_DATA[clave] && PERICOPES_DATA[clave].length > 0;
                console.log(`[Per√≠copas] Verificando ${clave}:`, tienePericopas ? 'Disponible' : 'No disponible');
                return tienePericopas;
            }
            
            // Hacer la funci√≥n accesible globalmente
            window.verificarPericopasDisponibles = verificarPericopasDisponibles;
        } else {
            console.error('[Per√≠copas] Error: No se pudo cargar el objeto PERICOPES_DATA');
        }
    </script>
    <script src="app.js"></script>
    
    <!-- Bot√≥n flotante y panel de notas -->
    <div class="floating-notes-btn" id="floating-notes-btn">
        <i class="fas fa-pen"></i>
    </div>

    <div class="notes-panel" id="notes-panel">
        <div class="notes-header">
            <h3>Mis Notas</h3>
            <button class="close-notes" id="close-notes">&times;</button>
        </div>
        
        <div class="notes-tabs">
            <button class="tab-btn active" data-tab="quick-note">Nota R√°pida</button>
            <button class="tab-btn" data-tab="all-notes">Todas las Notas</button>
        </div>
        
        <!-- Pesta√±a de Nota R√°pida -->
        <div class="tab-content active" id="quick-note">
            <div class="note-form">
                <input type="text" id="note-title" placeholder="T√≠tulo de la nota" class="form-control">
                <textarea id="note-content" placeholder="Escribe tu nota aqu√≠..." class="form-control"></textarea>
                <div class="note-actions">
                    <button class="btn btn-primary" id="save-note">Guardar Nota</button>
                </div>
            </div>
        </div>
        
        <!-- Pesta√±a de Todas las Notas -->
        <div class="tab-content" id="all-notes">
            <div class="notes-list" id="notes-list">
                <!-- Las notas se cargar√°n aqu√≠ din√°micamente -->
                <div class="no-notes">No hay notas guardadas a√∫n.</div>
            </div>
        </div>
    </div>
    
    <!-- Font Awesome para los √≠conos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Script para la funcionalidad de notas -->
    <script>
        // C√≥digo JavaScript para la funcionalidad de notas
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos del DOM
            const floatingBtn = document.getElementById('floating-notes-btn');
            const notesPanel = document.getElementById('notes-panel');
            const closeNotes = document.getElementById('close-notes');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const saveNoteBtn = document.getElementById('save-note');
            const noteTitle = document.getElementById('note-title');
            const noteContent = document.getElementById('note-content');
            const notesList = document.getElementById('notes-list');
            
            // Variables para el sistema de notas
            let currentNoteId = null; // Variable para rastrear la nota que se est√° editando
            let notes = JSON.parse(localStorage.getItem('bible-notes')) || [];
            const DRAFT_NOTE_KEY = 'bible-note-draft';
            
            // Limpiar borrador de nota
            function clearDraftNote() {
                try {
                    localStorage.removeItem(DRAFT_NOTE_KEY);
                } catch (e) {
                    console.error('Error al limpiar el borrador de la nota:', e);
                }
            }
            
            // Mostrar/ocultar panel de notas
            function toggleNotesPanel() {
                notesPanel.classList.toggle('active');
                if (notesPanel.classList.contains('active')) {
                    renderNotesList();
                }
            }
            
            // Cambiar entre pesta√±as
            function switchTab(e) {
                const tabId = this.getAttribute('data-tab');
                
                // Actualizar botones de pesta√±a
                tabButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Mostrar contenido de la pesta√±a seleccionada
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabId) {
                        content.classList.add('active');
                    }
                });
                
                // Si es la pesta√±a de todas las notas, actualizar la lista
                if (tabId === 'all-notes') {
                    renderNotesList();
                }
            }
            
            // Guardar nota
            async function saveNote() {
                // Asegurarse de que tenemos referencias a los elementos del formulario
                if (!noteTitle) noteTitle = document.getElementById('note-title');
                if (!noteContent) noteContent = document.getElementById('note-content');
                
                // Verificar que los elementos del formulario existan
                if (!noteTitle || !noteContent) {
                    console.error('Error: No se encontraron los campos del formulario de notas');
                    showNotification('Error: No se pudo acceder al formulario de notas');
                    return;
                }
                
                const title = noteTitle.value.trim() || 'Nota sin t√≠tulo';
                const content = noteContent.value.trim();
                let reference;
                
                try {
                    reference = getCurrentReference();
                } catch (error) {
                    console.error('Error al obtener la referencia:', error);
                    reference = 'Referencia no disponible';
                }
                
                const now = new Date().toISOString();
                
                console.log('Guardando nota:', { title, content, reference, currentNoteId });
                
                // Validar contenido
                if (!content) {
                    showNotification('Por favor ingresa el contenido de la nota');
                    return;
                }
                
                try {
                    // Si estamos editando una nota existente
                    if (currentNoteId) {
                        const index = notes.findIndex(n => n.id === currentNoteId);
                        if (index !== -1) {
                            notes[index] = {
                                ...notes[index],
                                title,
                                content,
                                updatedAt: now
                            };
                            console.log('Nota actualizada:', notes[index]);
                        }
                    } else {
                        // Crear nueva nota
                        const newNote = {
                            id: Date.now(),
                            title,
                            content,
                            reference,
                            createdAt: now,
                            updatedAt: now
                        };
                        notes.unshift(newNote);
                        console.log('Nueva nota creada:', newNote);
                    }
                    
                    // Guardar en localStorage
                    saveNotes();
                    
                    // Mostrar mensaje de √©xito
                    showNotification('Nota guardada correctamente');
                    
                    // Limpiar formulario y borrador
                    noteTitle.value = '';
                    noteContent.value = '';
                    currentNoteId = null;
                    clearDraftNote(); // Limpiar el borrador guardado
                    
                    // Cambiar a la pesta√±a de todas las notas
                    const allNotesTab = document.querySelector('.tab-btn[data-tab="all-notes"]');
                    if (allNotesTab) allNotesTab.click();
                    
                } catch (error) {
                    console.error('Error al guardar la nota:', error);
                    showNotification('Error al guardar la nota. Por favor, int√©ntalo de nuevo.');
                }
            }
            
            // Obtener referencia actual
            function getCurrentReference() {
                try {
                    // Intenta obtener la referencia actual de la p√°gina
                    const referenceElement = document.querySelector('.current-reference');
                    if (referenceElement) {
                        return referenceElement.textContent.trim() || 'Referencia no disponible';
                    }
                    
                    // Si no se encuentra un elemento con la clase current-reference,
                    // intenta obtener la referencia del t√≠tulo de la p√°gina
                    const titleElement = document.querySelector('h1, h2, h3');
                    if (titleElement) {
                        return titleElement.textContent.trim() || 'Referencia no disponible';
                    }
                    
                    // Si no se puede determinar la referencia, devolver un valor por defecto
                    return 'Referencia no disponible';
                } catch (error) {
                    console.error('Error al obtener la referencia actual:', error);
                    return 'Referencia no disponible';
                }
            }
            
            // Funci√≥n para mostrar di√°logo de confirmaci√≥n
            function showConfirm(message) {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0, 0, 0, 0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 2000;
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        max-width: 80%;
                        text-align: center;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                    `;
                    
                    const messageEl = document.createElement('p');
                    messageEl.textContent = message;
                    messageEl.style.marginBottom = '20px';
                    
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.style.display = 'flex';
                    buttonsContainer.style.justifyContent = 'center';
                    buttonsContainer.style.gap = '10px';
                    
                    const confirmButton = document.createElement('button');
                    confirmButton.textContent = 'S√≠';
                    confirmButton.style.padding = '8px 20px';
                    confirmButton.style.background = '#4CAF50';
                    confirmButton.style.color = 'white';
                    confirmButton.style.border = 'none';
                    confirmButton.style.borderRadius = '4px';
                    confirmButton.style.cursor = 'pointer';
                    
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'No';
                    cancelButton.style.padding = '8px 20px';
                    cancelButton.style.background = '#f44336';
                    cancelButton.style.color = 'white';
                    cancelButton.style.border = 'none';
                    cancelButton.style.borderRadius = '4px';
                    cancelButton.style.cursor = 'pointer';
                    
                    confirmButton.onclick = () => {
                        document.body.removeChild(modal);
                        resolve(true);
                    };
                    
                    cancelButton.onclick = () => {
                        document.body.removeChild(modal);
                        resolve(false);
                    };
                    
                    buttonsContainer.appendChild(confirmButton);
                    buttonsContainer.appendChild(cancelButton);
                    
                    modalContent.appendChild(messageEl);
                    modalContent.appendChild(buttonsContainer);
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                });
            }
            
            // Funci√≥n para mostrar notificaciones
            function showNotification(message, duration = 3000) {
                // Crear el elemento de notificaci√≥n si no existe
                let notification = document.getElementById('notification-toast');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.id = 'notification-toast';
                    notification.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background-color: #4CAF50;
                        color: white;
                        padding: 12px 24px;
                        border-radius: 4px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        z-index: 1000;
                        opacity: 0;
                        transition: opacity 0.3s ease-in-out;
                        max-width: 90%;
                        text-align: center;
                    `;
                    document.body.appendChild(notification);
                }
                
                // Establecer el mensaje
                notification.textContent = message;
                
                // Mostrar la notificaci√≥n
                notification.style.opacity = '1';
                
                // Ocultar despu√©s de la duraci√≥n especificada
                setTimeout(() => {
                    notification.style.opacity = '0';
                    // Eliminar despu√©s de la animaci√≥n
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, duration);
            }
            
            // Guardar notas en localStorage
            function saveNotes() {
                localStorage.setItem('bible-notes', JSON.stringify(notes));
                renderNotesList();
            }
            
            // Renderizar lista de notas
            function renderNotesList() {
                if (notes.length === 0) {
                    notesList.innerHTML = '<div class="no-notes">No hay notas guardadas a√∫n.</div>';
                    return;
                }
                
                notesList.innerHTML = notes.map(note => `
                    <div class="note-item" data-id="${note.id}">
                        <div class="note-title">${note.title}</div>
                        <div class="note-preview">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</div>
                        <div class="note-actions">
                            <button class="btn btn-secondary edit-note" data-id="${note.id}">Editar</button>
                            <button class="btn btn-danger delete-note" data-id="${note.id}">Eliminar</button>
                            <button class="btn btn-secondary download-note" data-id="${note.id}">Descargar</button>
                        </div>
                    </div>
                `).join('');
                
                // Agregar eventos a los botones de las notas
                document.querySelectorAll('.edit-note').forEach(btn => {
                    btn.addEventListener('click', editNote);
                });
                
                document.querySelectorAll('.delete-note').forEach(btn => {
                    btn.addEventListener('click', deleteNote);
                });
                
                document.querySelectorAll('.download-note').forEach(btn => {
                    btn.addEventListener('click', downloadNote);
                });
                
                // Hacer clic en una nota para ver su contenido
                document.querySelectorAll('.note-item').forEach(item => {
                    item.addEventListener('click', viewNote);
                });
            }
            
            // Editar nota
            function editNote(e) {
                e.stopPropagation();
                const noteId = this.getAttribute('data-id');
                const note = notes.find(n => n.id === noteId);
                
                if (note) {
                    // Llenar el formulario con los datos de la nota
                    noteTitle.value = note.title;
                    noteContent.value = note.content;
                    
                    // Cambiar a la pesta√±a de edici√≥n
                    document.querySelector('.tab-btn[data-tab="quick-note"]').click();
                    
                    // Desplazarse al formulario
                    notesPanel.scrollTop = 0;
                }
            }
            
            // Eliminar nota
            async function deleteNote(e) {
                try {
                    e.stopPropagation();
                    const noteItem = e.target.closest('.note-item');
                    if (!noteItem) {
                        console.error('No se pudo encontrar el elemento de la nota');
                        return;
                    }
                    
                    // Asegurarse de que el ID sea un n√∫mero para comparaci√≥n correcta
                    const noteId = parseInt(noteItem.dataset.id);
                    console.log('Eliminando nota ID:', noteId, 'Tipo:', typeof noteId);
                    
                    const confirmDelete = await showConfirm('¬øEst√°s seguro de que quieres eliminar esta nota?');
                    if (confirmDelete) {
                        // Convertir el ID a n√∫mero para la comparaci√≥n
                        notes = notes.filter(note => note.id !== noteId);
                        saveNotes();
                        renderNotesList();
                        
                        // Si est√°bamos editando la nota que se elimin√≥, limpiar el formulario
                        if (currentNoteId === noteId) {
                            if (noteTitle) noteTitle.value = '';
                            if (noteContent) noteContent.value = '';
                            currentNoteId = null;
                        }
                        
                        console.log('Nota eliminada. Notas restantes:', notes);
                        showNotification('Nota eliminada correctamente');
                    }
                } catch (error) {
                    console.error('Error al eliminar la nota:', error);
                }
            }
            
            // Descargar nota
            function downloadNote(e) {
                e.stopPropagation();
                const noteId = parseInt(this.getAttribute('data-id'));
                const note = notes.find(n => n.id === noteId);
                
                if (note) {
                    const blob = new Blob([`# ${note.title}\n\n${note.content}`], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${note.title.replace(/[^\w\s]/gi, '')}.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }
            
            // Ver nota completa
            function viewNote(e) {
                // Evitar que se active al hacer clic en los botones
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                
                const noteId = parseInt(this.getAttribute('data-id'));
                const note = notes.find(n => n.id === noteId);
                
                if (note) {
                    // Mostrar la nota en un modal o en el √°rea de edici√≥n
                    noteTitle.value = note.title;
                    noteContent.value = note.content;
                    
                    // Cambiar a la pesta√±a de edici√≥n
                    document.querySelector('.tab-btn[data-tab="quick-note"]').click();
                }
            }
            
            // Hacer el bot√≥n flotante arrastrable
            function makeDraggable(element) {
                let posX = 0, posY = 0, mouseX = 0, mouseY = 0;
                let isDragging = false;
                
                // Estilos iniciales
                element.style.position = 'fixed';
                element.style.cursor = 'grab';
                
                // Posici√≥n inicial (centrado verticalmente a la derecha)
                const initialPos = {
                    top: (window.innerHeight - element.offsetHeight) / 2,
                    right: 20
                };
                
                // Cargar posici√≥n guardada o usar posici√≥n inicial
                const savedPos = JSON.parse(localStorage.getItem('floating-btn-pos'));
                const position = savedPos || initialPos;
                
                // Aplicar posici√≥n
                element.style.top = `${position.top}px`;
                element.style.right = `${position.right}px`;
                
                // Guardar posici√≥n inicial si no existe
                if (!savedPos) {
                    localStorage.setItem('floating-btn-pos', JSON.stringify(initialPos));
                }
                
                // Funci√≥n para iniciar arrastre
                function startDrag(e) {
                    e.preventDefault();
                    
                    // Obtener posici√≥n t√°ctil o del mouse
                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                    
                    if (!clientX || !clientY) return;
                    
                    // Obtener posici√≥n inicial
                    mouseX = clientX;
                    mouseY = clientY;
                    
                    // Obtener posici√≥n actual del elemento
                    posX = element.offsetLeft;
                    posY = element.offsetTop;
                    
                    isDragging = true;
                    element.style.cursor = 'grabbing';
                    
                    // Prevenir el scroll en dispositivos t√°ctiles
                    document.body.style.overflow = 'hidden';
                    
                    // Agregar eventos de arrastre
                    document.addEventListener('mousemove', dragElement);
                    document.addEventListener('mouseup', stopDrag);
                    document.addEventListener('touchmove', dragElement, { passive: false });
                    document.addEventListener('touchend', stopDrag);
                }
                
                // Iniciar arrastre
                element.addEventListener('mousedown', startDrag);
                element.addEventListener('touchstart', startDrag, { passive: true });
                
                // Funci√≥n de arrastre
                function dragElement(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    
                    // Obtener posici√≥n t√°ctil o del mouse
                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                    
                    if (!clientX || !clientY) return;
                    
                    // Calcular nueva posici√≥n
                    const dx = clientX - mouseX;
                    const dy = clientY - mouseY;
                    
                    // Calcular l√≠mites
                    const maxX = window.innerWidth - element.offsetWidth;
                    const maxY = window.innerHeight - element.offsetHeight;
                    
                    // Calcular nuevas coordenadas
                    let newLeft = posX + dx;
                    let newTop = posY + dy;
                    
                    // Asegurar que el elemento no salga de los l√≠mites
                    newLeft = Math.max(0, Math.min(newLeft, maxX));
                    newTop = Math.max(0, Math.min(newTop, maxY));
                    
                    // Aplicar nueva posici√≥n
                    element.style.left = `${newLeft}px`;
                    element.style.top = `${newTop}px`;
                    element.style.right = 'auto';
                    
                    // Guardar posici√≥n
                    savePosition(newLeft, newTop);
                }
                
                // Detener arrastre
                function stopDrag() {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    element.style.cursor = 'grab';
                    document.body.style.overflow = '';
                    
                    // Remover todos los listeners de arrastre
                    document.removeEventListener('mousemove', dragElement);
                    document.removeEventListener('mouseup', stopDrag);
                    document.removeEventListener('touchmove', dragElement);
                    document.removeEventListener('touchend', stopDrag);
                }
                
                // Guardar posici√≥n
                function savePosition(left, top) {
                    // Calcular posici√≥n relativa a la derecha para guardar
                    const right = window.innerWidth - (left + element.offsetWidth);
                    const pos = { top, right };
                    localStorage.setItem('floating-btn-pos', JSON.stringify(pos));
                }
                
                // Manejar redimensionamiento de la ventana
                window.addEventListener('resize', function() {
                    const saved = JSON.parse(localStorage.getItem('floating-btn-pos'));
                    if (saved) {
                        // Asegurar que el bot√≥n siga siendo visible al redimensionar
                        const maxRight = Math.max(0, window.innerWidth - element.offsetWidth);
                        const maxTop = Math.max(0, window.innerHeight - element.offsetHeight);
                        
                        const newRight = Math.min(saved.right, maxRight);
                        const newTop = Math.min(saved.top, maxTop);
                        
                        element.style.right = `${newRight}px`;
                        element.style.top = `${newTop}px`;
                        element.style.left = 'auto';
                    }
                });
            }
            
            // Event listeners originales
            floatingBtn.addEventListener('click', toggleNotesPanel);
            closeNotes.addEventListener('click', toggleNotesPanel);
            saveNoteBtn.addEventListener('click', saveNote);
            
            // Agregar manejadores para las pesta√±as
            tabButtons.forEach(button => {
                button.addEventListener('click', switchTab);
            });
            
            // Hacer el bot√≥n arrastrable
            makeDraggable(floatingBtn);
            
            // Soporte t√°ctil mejorado
            floatingBtn.addEventListener('touchend', function(e) {
                // Si no hubo movimiento significativo, abrir el panel
                if (!isDragging) {
                    toggleNotesPanel();
                }
                isDragging = false;
                e.preventDefault();
            }, { passive: false });
            
            // Inicializar el panel de notas
            renderNotesList();
            
            // Cerrar el panel al hacer clic fuera de √©l
            document.addEventListener('click', (e) => {
                if (!notesPanel.contains(e.target) && !floatingBtn.contains(e.target)) {
                    notesPanel.classList.remove('active');
                }
            });
            
            // Cerrar con la tecla Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && notesPanel.classList.contains('active')) {
                    notesPanel.classList.remove('active');
                }
            });
            
            console.log('Sistema de notas cargado correctamente');
        });
    </script>
    
    <!-- Modal personalizado para confirmaciones -->
    <div id="customConfirmModal" class="custom-modal">
        <div class="custom-modal-content">
            <p id="customConfirmMessage">¬øEst√°s seguro?</p>
            <div class="custom-modal-buttons">
                <button id="customConfirmCancel" class="custom-modal-button cancel">Cancelar</button>
                <button id="customConfirmOk" class="custom-modal-button confirm">Aceptar</button>
            </div>
        </div>
    </div>
</body>
</html>
