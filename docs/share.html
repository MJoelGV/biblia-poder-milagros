<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compartir Vers√≠culo</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <style>
        :root { --primary-color: #4CAF50; --bg-color: #fff; --text-color: #333; }
        body { margin:0; font-family: Arial, sans-serif, 'Great Vibes'; background:#f0f0f0; color:var(--text-color); }
        .header { display:flex; align-items:center; padding:10px; background:var(--primary-color); color:#fff; }
        .header a { color:#fff; text-decoration:none; margin-right:10px; font-size:24px; }
        #share-container { display:flex; justify-content:center; padding:20px; }
        #verse-card {
            width: 360px;
            height: 640px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 0;
            border-radius: 15px;
            box-sizing: border-box;
        }
        #text-box {
            position: absolute;
            top: 30%;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
        }
        #verse-text { font-size:1.5em; margin-bottom:15px; line-height:1.6; text-align:center; color: #fff!important; text-shadow: 2px 2px 4px rgba(0,0,0,0.5)!important; }
        #verse-ref { font-style:italic; margin-top:10px; color: #fff!important; text-shadow: 2px 2px 4px rgba(0,0,0,0.5)!important; }
        /* Swiper Carousel styles */
        .swiper-container {
            width: 260px;
            margin: 0 auto;
            overflow: hidden;
            padding-bottom: 20px;
        }
        .swiper-slide {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .bg-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: transform 0.3s, border-color 0.3s;
            transform: scale(0.8);
        }
        .swiper-slide-active .bg-thumb {
            transform: scale(1.2);
            border-color: var(--primary-color);
        }
        .swiper-slide-next .bg-thumb,
        .swiper-slide-prev .bg-thumb {
            transform: scale(0.8);
        }
        #download-btn { display:block; margin:20px auto; padding:10px 20px; background:var(--primary-color);
            color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:16px; }
        /* Verse search selectors */
        #search-panel { text-align: center; margin: 20px 0; }
        #search-panel select { margin: 0 5px; padding: 5px; font-size: 16px; }
    </style>
</head>
<body>
    <script>
        // Unregister any existing service workers to bypass cache
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(reg => reg.unregister()));
        }
    </script>
    <div class="header">
        <a href="index.html">üè† Inicio</a>
        <h1>Compartir Vers√≠culo</h1>
    </div>
    <div id="search-panel">
        <select id="book-select"></select>
        <select id="chapter-select"></select>
        <select id="verse-select"></select>
    </div>
    <div id="share-container">
        <div id="verse-card"></div>
    </div>
    <div id="bg-options">
        <h2>Elegir fondo</h2>
        <div class="swiper-container" id="carousel">
            <div class="swiper-wrapper">
                <div class="swiper-slide"><img class="bg-thumb" src="https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?auto=format&fit=crop&w=400&q=80" data-bg="https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?auto=format&fit=crop&w=1200&q=80"></div>
                <div class="swiper-slide"><img class="bg-thumb" src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=400&q=80" data-bg="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1200&q=80"></div>
                <div class="swiper-slide"><img class="bg-thumb" src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=400&q=80" data-bg="https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&q=80"></div>
                <div class="swiper-slide"><img class="bg-thumb" src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=400&q=80" data-bg="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80"></div>
                <div class="swiper-slide"><img class="bg-thumb" src="https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?auto=format&fit=crop&w=400&q=80" data-bg="https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?auto=format&fit=crop&w=1200&q=80"></div>
                <div class="swiper-slide"><img class="bg-thumb" src="https://images.unsplash.com/photo-1508609349937-5ec4ae374ebf?auto=format&fit=crop&w=400&q=80" data-bg="https://images.unsplash.com/photo-1508609349937-5ec4ae374ebf?auto=format&fit=crop&w=1200&q=80"></div>
            </div>
        </div>
    </div>
    <button id="download-btn">Descargar imagen</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        let bookParam = (params.get('book') || '').toLowerCase();
        let chapter = params.get('chapter'), verse = params.get('verse');
        const bookNames = {
            genesis: 'G√©nesis', exodus: '√âxodo', leviticus: 'Lev√≠tico', numbers: 'N√∫meros', deuteronomy: 'Deuteronomio',
            joshua: 'Josu√©', judges: 'Jueces', ruth: 'Rut', samuel1: '1 Samuel', samuel2: '2 Samuel',
            kings1: '1 Reyes', kings2: '2 Reyes', psalms: 'Salmos', proverbs: 'Proverbios', isaiah: 'Isa√≠as', jeremiah: 'Jerem√≠as',
            daniel: 'Daniel', hosea: 'Oseas', joel: 'Joel', amos: 'Am√≥s', obadiah: 'Abd√≠as', jonah: 'Jon√°s', micah: 'Miqueas',
            nahum: 'Nah√∫m', habakkuk: 'Habacuc', zephaniah: 'Sofon√≠as', haggai: 'Hageo', zechariah: 'Zacar√≠as', malachi: 'Malaqu√≠as'
        };
        const displayBook = bookNames[bookParam] || bookParam;
        const verseCard = document.getElementById('verse-card');
        const downloadBtn = document.getElementById('download-btn');
        let xmlData;
        const bookSelect = document.getElementById('book-select');
        const chapterSelect = document.getElementById('chapter-select');
        const verseSelect = document.getElementById('verse-select');

        async function loadBg(url) {
            const res = await fetch(url);
            const blob = await res.blob();
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            }).then(dataUrl => { verseCard.style.backgroundImage = `url('${dataUrl}')`; });
        }

        const swiper = new Swiper('#carousel', {
            slidesPerView: 3,
            spaceBetween: 10,
            centeredSlides: true,
            loop: true,
            loopedSlides: 6,
        });

        swiper.on('slideChange', () => {
            const slide = swiper.slides[swiper.activeIndex];
            const img = slide.querySelector('.bg-thumb');
            loadBg(img.dataset.bg);
        });

        swiper.on('init', () => loadBg(swiper.slides[swiper.activeIndex].querySelector('.bg-thumb').dataset.bg));
        swiper.init();

        function populateBookSelect() {
            bookSelect.innerHTML = '';
            for (let slug in bookNames) {
                const opt = document.createElement('option'); opt.value = slug; opt.text = bookNames[slug];
                if (slug === bookParam) opt.selected = true;
                bookSelect.append(opt);
            }
        }

        function loadChapters(bSlug) {
            chapterSelect.innerHTML = '';
            const name = bookNames[bSlug];
            const bNode = Array.from(xmlData.getElementsByTagName('b')).find(b=>b.getAttribute('n')===name);
            if (!bNode) return;
            Array.from(bNode.getElementsByTagName('c')).forEach(c=>{
                const n = c.getAttribute('n'); const o=document.createElement('option'); o.value=o.text=n;
                if (n===chapter) o.selected=true; chapterSelect.append(o);
            });
        }

        function loadVerses(bSlug, chNum) {
            verseSelect.innerHTML = '';
            const name = bookNames[bSlug];
            const bNode = Array.from(xmlData.getElementsByTagName('b')).find(b=>b.getAttribute('n')===name);
            if (!bNode) return;
            const cNode = Array.from(bNode.getElementsByTagName('c')).find(c=>c.getAttribute('n')===chNum);
            if (!cNode) return;
            Array.from(cNode.getElementsByTagName('v')).forEach(vn=>{
                const n=vn.getAttribute('n'); const o=document.createElement('option'); o.value=o.text=n;
                if (n===verse) o.selected=true; verseSelect.append(o);
            });
        }

        function updateVerse() {
            const name = bookNames[bookParam];
            const bNode = Array.from(xmlData.getElementsByTagName('b')).find(b=>b.getAttribute('n')===name);
            const cNode = Array.from(bNode.getElementsByTagName('c')).find(c=>c.getAttribute('n')===chapter);
            const vNode = Array.from(cNode.getElementsByTagName('v')).find(v=>v.getAttribute('n')===verse);
            if (vNode) {
                verseCard.innerHTML = `<div id="text-box"><div id="verse-text">${vNode.textContent}</div><div id="verse-ref">${name} ${chapter}:${verse}</div></div>`;
            }
        }

        // Load XML and initialize selectors
        (async () => {
            try {
                const res = await fetch('biblia-files/Reina-Valera-1960.xmm');
                const xmlText = await res.text();
                xmlData = new DOMParser().parseFromString(xmlText, 'text/xml');
                populateBookSelect();
                loadChapters(bookParam);
                loadVerses(bookParam, chapter);
                updateVerse();
                // attach selector events
                bookSelect.onchange = e=>{bookParam=e.target.value; loadChapters(bookParam); chapter=chapterSelect.value; loadVerses(bookParam,chapter); updateVerse();};
                chapterSelect.onchange = e=>{chapter=e.target.value; loadVerses(bookParam,chapter); updateVerse();};
                verseSelect.onchange = e=>{verse=e.target.value; updateVerse();};
            } catch(e) {
                console.error(e);
                verseCard.textContent = 'Error cargando vers√≠culo';
            }
        })();

        downloadBtn.addEventListener('click', () => {
            html2canvas(verseCard).then(canvas => {
                const link = document.createElement('a');
                link.download = `verse-${bookParam}-${chapter}-${verse}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        });
    </script>
</body>
</html>
