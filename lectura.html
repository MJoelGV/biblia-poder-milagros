<!DOCTYPE html>
<!-- Build timestamp: 2025-04-25T21:20:00Z -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lectura - Biblia de Poder y Milagros</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- corregido path para iOS icon -->
    <link rel="apple-touch-icon" href="../icons/pymicon.png">
    <style>
        :root {
            --primary-color: #4CAF50;
            --text-color: #333;
            --bg-color: #fff;
            --verse-font-size: 1.1em;
            --menu-bg: rgba(0, 0, 0, 0.6);
            --menu-blur: blur(10px);
        }

        [data-theme="dark"] {
            --primary-color: #45a049;
            --text-color: #fff;
            --bg-color: #121212;
            --menu-bg: rgba(0, 0, 0, 0.8);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s;
        }

        .controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--menu-bg);
            backdrop-filter: var(--menu-blur);
            color: white;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .controls.hidden {
            transform: translateY(-100%);
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }

        .home-icon {
            text-decoration: none;
            font-size: 24px;
            color: var(--primary-color);
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .home-icon:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .select-css {
            padding: 8px 12px;
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
            outline: none;
        }

        .select-css:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .select-css option {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 8px;
        }

        .search-wrapper { display: inline-flex; align-items: center; }
        .search-wrapper .search-input { display: none; }
        .search-wrapper.active .search-input { 
            display: inline-block;
            max-width: 180px;
            opacity: 1;
            margin-left: 8px;
            padding: 8px 12px;
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            outline: none;
        }

        .search-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .chapter-content {
            max-width: 1200px;
            margin: 120px auto 80px;
            padding: 0 20px;
        }

        .chapter-title {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 20px 0 30px 0;
            padding: 10px;
        }

        .verse {
            margin-bottom: 0.8em;
            padding: 0.4em;
            line-height: 1.6;
            border-radius: 4px;
            transition: background-color 1s ease;
        }

        .verse:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .verse.highlighted {
            background-color: rgba(76, 175, 80, 0.15);
        }
        /* Dark mode: highlighted verse text black for readability */
        [data-theme="dark"] .verse.highlighted {
            color: #000;
        }
        .verse.bookmarked { background: #fffa8c; }
        .verse.comment { border-left: 4px solid var(--primary-color); }
        .verse.memorized { background: #c6f4d6; }
        /* Dark mode: texto negro para bookmarked y memorized */
        [data-theme="dark"] .verse.bookmarked,
        [data-theme="dark"] .verse.memorized {
            color: #000;
        }

        .verse-number {
            color: var(--primary-color);
            font-weight: bold;
            margin-right: 0.5em;
            font-size: 0.9em;
        }

        .verse-text {
            font-size: var(--verse-font-size);
            line-height: 1.6;
        }

        .navigation-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--menu-bg);
            backdrop-filter: var(--menu-blur);
            color: white;
            padding: 12px;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .navigation-bottom.hidden {
            transform: translateY(100%);
        }

        .nav-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #chapter-select {
            min-width: 120px;
            text-align: center;
        }

        .chapter-grid, .verse-grid {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .chapter-grid.active, .verse-grid.active {
            display: flex;
        }
        .chapter-grid .grid-content, .verse-grid .grid-content {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px,1fr));
            gap: 10px;
        }
        /* Header for modal grids */
        .chapter-grid .grid-header, .verse-grid .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .close-grid {
            cursor: pointer;
            font-size: 1.5em;
            line-height: 1;
        }

        /* Botón de título: línea única con indicador */
        .chapter-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            transition: background 0.3s, color 0.3s;
        }

        .chapter-btn:hover,
        .chapter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .chapter-btn::after {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            opacity: 0;
            transition: opacity 0.3s;
            margin-left: 8px;
        }

        .chapter-btn.active::after {
            opacity: 1;
        }

        .search-results {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            background: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1100;
            padding: 20px;
            overflow-y: auto;
        }

        .search-results.active {
            display: block;
        }

        /* Botón cerrar resultados de búsqueda */
        .search-results .close-search {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
        }

        .search-results .close-search:hover {
            color: var(--primary-color);
        }

        .result-item {
            padding: 12px;
            border-bottom: 1px solid rgba(128,128,128,0.2);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .result-item:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .result-book {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .result-text {
            font-size: 0.9em;
            line-height: 1.5;
        }

        /* Modal para comentarios */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1300;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%,-50%);
            background: var(--bg-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1301;
            max-width: 90%; width: 300px;
        }
        .modal textarea {
            width: 100%; height: 100px; resize: vertical;
        }
        .modal-actions {
            display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px;
        }
        .modal-actions button {
            padding: 6px 12px;
        }

        /* Verso marcado y menú contextual */
        .verse-menu {
            display: none;
            position: absolute;
            background: var(--bg-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1200;
            padding: 8px;
        }
        .verse-menu ul { list-style: none; margin: 0; padding: 0; }
        .verse-menu li {
            padding: 8px; cursor: pointer;
        }
        .verse-menu li:hover { background: rgba(0,0,0,0.05); }
        /* Responsive: wrap controls and selectors on small screens */
        @media (max-width: 768px) {
            .top-row, .navigation {
                flex-wrap: wrap;
            }
            /* Reduce spacing on mobile */
            .top-row > *, .navigation > * {
                margin: 3px 5px;
            }
            .navigation {
                margin: 8px 0;
            }
            /* Allow selectors and input to shrink and limit width */
            .select-css, .search-input {
                max-width: 80px;
                flex: 0 1 auto;
            }
        }
        /* Responsive: menú más compacto en móviles */
        @media (max-width: 600px) {
            .controls { padding: 8px; }
            .controls .home-icon,
            .controls .theme-toggle {
                width: 32px;
                height: 32px;
                font-size: 20px;
                padding: 4px;
            }
            .selector-row {
                padding: 8px;
                top: 48px; /* altura de controls reducida */
            }
            #version-selector {
                width: 180px;
                min-width: 150px;
            }
            #book-select {
                width: 120px;
                min-width: 100px;
            }
        }
        /* Extra controls (hidden por defecto) */
        .extra-controls {
            display: none;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            margin: 10px 20px;
        }
        .extra-controls.active {
            display: flex;
        }
        /* Main menu toggle button */
        .main-menu-toggle {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-menu-toggle:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        /* Menú lateral */
        .side-menu {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background: var(--bg-color);
            box-shadow: 2px 0 8px rgba(0,0,0,0.2);
            transition: left 0.3s ease;
            z-index: 1001;
        }
        .side-menu.active {
            left: 0;
        }
        .side-menu ul { list-style: none; padding: 20px; margin: 0; }
        .side-menu ul li { padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
        .side-menu ul li:last-child { border-bottom: none; }
        .side-menu-toggle {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }
        .side-menu-toggle:hover { background-color: rgba(0,0,0,0.05); border-radius: 50%; }
        
        /* Outline grid styling */
        .outline-grid {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .outline-grid.active {
            display: flex;
        }
        .outline-grid .grid-content {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px,1fr));
            gap: 10px;
        }
        .outline-grid .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
        /* Verse grid styling and hide dropdowns */
        #chapter-select, #verse-select {
            display: none !important;
        }

        /* Mostrar grid de capítulos cuando esté activo */
        .chapter-grid.active { display: flex; }
    </style>
    <script>
        let strongsData = {};
        fetch('strongs.json')
          .then(res => res.json())
          .then(data => { strongsData = data; });
    </script>
    <!-- texto actualizado -->
    <div id="install-button" style="display:none;position:fixed;bottom:80px;right:20px;padding:10px 20px;background:#4CAF50;color:#fff;border:none;border-radius:20px;z-index:1000;">Descargar esta App</div>
</head>
<body>
    <!-- Menú lateral -->
    <div id="side-menu" class="side-menu">
        <ul>
            <li onclick="window.location.href='index.html'">Página principal</li>
            <li onclick="window.location.href='lectura.html'">Leer Biblia</li>
            <li onclick="window.location.href='audio.html'">Escuchar</li>
            <li onclick="window.location.href='memorizados.html'">Memorizados</li>
            <li onclick="window.location.href='historias.html'">Historias</li>
            <li onclick="window.location.href='diccionario.html'">Diccionario</li>
            <li onclick="window.location.href='bookmarks.html'">Marcados</li>
            <li onclick="window.location.href='comments.html'">Comentarios</li>
            <li id="chapter-menu-toggle">Capítulos</li>
        </ul>
    </div>
    <div class="controls" id="controls">
        <div class="top-row">
            <button id="side-menu-toggle" class="side-menu-toggle">☰</button>
            <select id="version-selector" class="select-css">
                <option value="Reina-Valera-1960" selected>Reina-Valera 1960</option>
                <option value="TLA">Traducción en Lenguaje Actual</option>
                <option value="Dios-Habla-Hoy">Dios Habla Hoy</option>
                <option value="La-Biblia-de-Las-Americas">La Biblia de las Américas</option>
                <option value="Nueva-Traduccion-Viviente">Nueva Traducción Viviente</option>
            </select>
            <select id="book-select" class="select-css"></select>
            <div class="search-wrapper">
                <button id="search-button" class="search-button">🔍</button>
                <input id="search-input" class="search-input" placeholder="Buscar versículo" />
            </div>
            <button id="main-menu-toggle" class="main-menu-toggle">⋮</button>
        </div>
        <div id="extra-controls" class="extra-controls">
            <a href="/biblia-poder-milagros/" class="home-icon">🏠</a>
            <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">🌙</button>
            <button id="decrease-font" class="theme-toggle" onclick="adjustFontSize(-0.1)">A-</button>
            <button id="increase-font" class="theme-toggle" onclick="adjustFontSize(0.1)">A+</button>
        </div>
    </div> <!-- cierre .controls -->

    <!-- Overlay de resultados de búsqueda -->
    <div id="search-results" class="search-results">
        <button id="close-search" class="close-search">&times;</button>
        <div id="results-content"></div>
    </div>

    <!-- Menú contextual para versículos -->
    <div id="verse-menu" class="verse-menu">
        <ul>
            <li id="menu-toggle-bookmark">Marcar versículo</li>
            <li id="menu-add-comment">Agregar comentario</li>
            <li id="menu-memorize-verse">Memorizar versículo</li>
            <li id="menu-copy-verse">Copiar versículo</li>
        </ul>
    </div>

    <!-- Modal de comentarios -->
    <div id="comment-backdrop" class="modal-backdrop"></div>
    <div id="comment-modal" class="modal">
        <h3>Comentario</h3>
        <textarea id="modal-comment-input"></textarea>
        <div class="modal-actions">
            <button id="modal-save-btn">Guardar</button>
            <button id="modal-cancel-btn">Cancelar</button>
        </div>
    </div>

    <div class="chapter-grid" id="chapter-grid"></div>
    <div class="verse-grid" id="verse-grid"></div>
    <div class="outline-grid" id="outline-grid"></div>
    <!-- outline-grid removed temporarily until feature complete -->
    <div class="chapter-content" id="chapter-content">
        <div id="verses"></div>
    </div> <!-- cierre .chapter-content -->

    <div class="navigation-bottom" id="navigation-bottom">
        <button class="nav-button" id="prev-button">← Anterior</button>
        <button class="nav-button" id="chapter-button">Capítulo <span id="current-chapter-button">1</span></button>
        <button class="nav-button" id="next-button">Siguiente →</button>
    </div>

    <div id="strongs-backdrop" class="modal-backdrop"></div>
    <div id="strongs-modal" class="modal">
        <div id="strongs-content"></div>
        <button id="strongs-close">Cerrar</button>
    </div>

    <script>
        let xmlDoc = null;
        let currentBook = '';
        let currentChapter = 1;
        let currentVerse = 0;
        let currentVersion = 'Reina-Valera-1960';
        const audioPlayer = null;
        let playlist = [];
        let trackIndex = 0;

        // Controlar la visibilidad de los menús al hacer scroll
        let lastScrollY = window.scrollY;
        let ticking = false;
        let lastTouchY = 0;
        let touchStartY = 0;
        let menuVisible = true;

        // Cargar preferencia de tema SOLO UNA VEZ
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-toggle').textContent = savedTheme === 'dark' ? '☀️' : '🌙';
        }

        // Función para manejar el scroll
        function handleScroll() {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    const currentScrollY = window.scrollY;
                    const scrollingDown = currentScrollY > lastScrollY;
                    
                    // Solo cambiamos la visibilidad si el scroll es significativo
                    if (Math.abs(currentScrollY - lastScrollY) > 50) {
                        menuVisible = !scrollingDown;
                        document.getElementById('controls').classList.toggle('hidden', !menuVisible);
                        document.getElementById('navigation-bottom').classList.toggle('hidden', !menuVisible);
                    }
                    
                    lastScrollY = currentScrollY;
                    ticking = false;
                });
                ticking = true;
            }
        }

        // Función para manejar el toque
        function handleTouch(e) {
            const currentY = e.touches[0].clientY;
            
            if (e.type === 'touchstart') {
                touchStartY = currentY;
                lastTouchY = currentY;
                return;
            }
            
            const deltaY = currentY - lastTouchY;
            
            // Solo cambiamos la visibilidad si el movimiento es significativo
            if (Math.abs(deltaY) > 30) {
                menuVisible = deltaY > 0;
                document.getElementById('controls').classList.toggle('hidden', !menuVisible);
                document.getElementById('navigation-bottom').classList.toggle('hidden', !menuVisible);
            }
            
            lastTouchY = currentY;
        }

        // Event listeners para scroll y touch
        window.addEventListener('scroll', handleScroll, { passive: true });
        document.addEventListener('touchstart', handleTouch, { passive: true });
        document.addEventListener('touchmove', handleTouch, { passive: true });

        // Mostrar menús al tocar cerca de ellos
        document.addEventListener('touchstart', (e) => {
            const touchY = e.touches[0].clientY;
            const windowHeight = window.innerHeight;
            
            // Si el toque está cerca del borde superior o inferior
            if (touchY < 50 || touchY > windowHeight - 50) {
                menuVisible = true;
                document.getElementById('controls').classList.remove('hidden');
                document.getElementById('navigation-bottom').classList.remove('hidden');
            }
        }, { passive: true });

        // Función para cambiar el tema
        function toggleTheme() {
            const body = document.body;
            const button = document.getElementById('theme-toggle');
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            button.textContent = isDark ? '🌙' : '☀️';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }

        // Event listeners para los selectores

        document.getElementById('book-select').addEventListener('change', (e) => {
            currentBook = e.target.value;
            showChapterGrid();
        });

        // Event listeners para los botones de navegación
        document.getElementById('prev-button').addEventListener('click', () => {
            if (currentChapter > 1) {
                currentChapter--;
                loadChapter();
                updateControls();
                updateURL();
                window.scrollTo({ top:0, behavior:'smooth' });
            }
        });
        document.getElementById('next-button').addEventListener('click', () => {
            const totalChapters = xmlDoc.querySelector(`b[n="${currentBook}"]`).getElementsByTagName('c').length;
            if (currentChapter < totalChapters) {
                currentChapter++;
                loadChapter();
                updateControls();
                updateURL();
                window.scrollTo({ top:0, behavior:'smooth' });
            }
        });

        // Función para cargar capítulos
        async function loadChapters() {
            const book = document.getElementById('book-select').value;
            if (!book) return;

            const chapters = xmlDoc.querySelector(`b[n="${book}"]`).getElementsByTagName('c');
            const chapterSelect = document.getElementById('chapter-select');
            chapterSelect.innerHTML = '<option value="" disabled selected>Selecciona un capítulo</option>' +
                Array.from(chapters).map((_, index) => `
                    <option value="${index + 1}" ${currentChapter === index + 1 ? 'selected' : ''}>
                        Capítulo ${index + 1}
                    </option>
                `).join('');
        }

        // Función para cargar capítulo
        async function loadChapter() {
            const versesContainer = document.getElementById('verses');
            versesContainer.innerHTML = '<div class="loading">Cargando...</div>';

            try {
                const chapter = xmlDoc.querySelector(`b[n="${currentBook}"] c[n="${currentChapter}"]`);
                if (!chapter) throw new Error('No se encontró el capítulo');

                let html = `
                    <div class="chapter-title">
                        ${currentBook} - Capítulo ${currentChapter}
                    </div>
                `;
                
                const verses = chapter.getElementsByTagName('v');
                html += Array.from(verses).map(verse => {
                    const verseNum = verse.getAttribute('n');
                    const isHighlighted = parseInt(verseNum) === currentVerse;
                    return `
                        <div class="verse ${isHighlighted ? 'highlighted' : ''}" 
                             data-verse="${verseNum}"
                             onclick="highlightVerse(this)">
                            <span class="verse-number">${verseNum}</span>
                            <span class="verse-text">${
                                Array.from(verse.childNodes)
                                    .filter(n => n.nodeType === Node.TEXT_NODE)
                                    .map(n => n.textContent)
                                    .join('').trim()
                            }</span>
                        </div>
                    `;
                }).join('');

                versesContainer.innerHTML = html;

                if (currentVerse > 0) {
                    const verseElement = versesContainer.querySelector(`.verse[data-verse="${currentVerse}"]`);
                    if (verseElement) {
                        setTimeout(() => {
                            verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // difuminar highlight después de unos segundos
                            setTimeout(() => verseElement.classList.remove('highlighted'), 3000);
                        }, 100);
                    }
                }
                restoreStates();
            } catch (error) {
                console.error('Error loading chapter:', error);
                versesContainer.innerHTML = `<div class="error">Error al cargar el capítulo: ${error.message}</div>`;
            }
        }

        // Función para actualizar controles
        function updateControls() {
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const chapterSelect = document.getElementById('chapter-select');
            
            if (!currentBook) {
                prevButton.disabled = true;
                nextButton.disabled = true;
                return;
            }

            const totalChapters = xmlDoc.querySelector(`b[n="${currentBook}"]`).getElementsByTagName('c').length;
            
            prevButton.disabled = currentChapter <= 1;
            nextButton.disabled = currentChapter >= totalChapters;
            
            // Actualizar el selector de capítulos
            chapterSelect.value = currentChapter;
        }

        // Función para actualizar URL
        function updateURL() {
            const url = new URL(window.location);
            url.searchParams.set('book', currentBook);
            url.searchParams.set('chapter', currentChapter);
            window.history.pushState({}, '', url);
        }

        // Función para cargar la Biblia
        async function loadBible(version) {
            try {
                const url = `biblia-files/${version}.xmm`;
                console.log('[BIBLIA] Intentando cargar:', url);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('No se pudo cargar el archivo: ' + url + ' (HTTP ' + response.status + ')');
                }
                const xmlText = await response.text();
                xmlDoc = new DOMParser().parseFromString(xmlText, 'text/xml');
                currentVersion = version;
                
                if (currentBook) {
                    loadChapter();
                }
            } catch (error) {
                console.error('[BIBLIA] Error loading Bible:', error);
                document.getElementById('verses').innerHTML = `<div class="error">Error al cargar la Biblia: ${error.message}</div>`;
            }
        }

        // Event listener para el selector de versiones
        document.getElementById('version-selector').addEventListener('change', async (e) => {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.textContent = 'Cargando versión...';
            document.getElementById('verses').innerHTML = '';
            document.getElementById('verses').appendChild(loadingDiv);
            
            await loadBible(e.target.value);
            setupBookSelector();
            if (currentBook) {
                document.getElementById('book-select').value = currentBook;
                loadChapters();
                loadChapter();
                updateControls();
            }
        });

        // Configurar selector de libros
        function setupBookSelector() {
            const books = xmlDoc.getElementsByTagName('b');
            const bookSelect = document.getElementById('book-select');
            bookSelect.innerHTML = '<option value="">Selecciona un libro</option>';
            
            Array.from(books).forEach(book => {
                const option = document.createElement('option');
                option.value = book.getAttribute('n');
                option.textContent = book.getAttribute('n');
                bookSelect.appendChild(option);
            });
        }

        // Función para cargar desde URL
        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const bookParam = params.get('book');
            const chapterParam = params.get('chapter');
            const verseParam = params.get('verse');

            if (bookParam) {
                currentBook = bookParam;
                currentChapter = chapterParam ? parseInt(chapterParam) : 1;
                currentVerse = verseParam ? parseInt(verseParam) : 0;

                document.getElementById('book-select').value = currentBook;
                loadChapters();
                loadChapter();
                updateControls();
            }
        }

        // Iniciar la aplicación
        async function init() {
            await loadBible(currentVersion);
            setupBookSelector();
            loadFromUrl();
        }

        init();

        // Deshabilitado Service Worker para evitar caché en lectura.html
        // if('serviceWorker' in navigator) {
        //     navigator.serviceWorker.register('service-worker.js');
        // }
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault(); deferredPrompt = e;
            document.getElementById('install-button').style.display = 'block';
        });
        document.getElementById('install-button').addEventListener('click', async () => {
            deferredPrompt.prompt();
            await deferredPrompt.userChoice;
            document.getElementById('install-button').style.display = 'none';
            deferredPrompt = null;
        });
    </script>
    <script>
        // Load saved font size
        const savedSize = localStorage.getItem('verseFontSize');
        if (savedSize) document.documentElement.style.setProperty('--verse-font-size', savedSize + 'em');

        // Adjust font size globally
        function adjustFontSize(delta) {
            const root = document.documentElement;
            const current = parseFloat(getComputedStyle(root).getPropertyValue('--verse-font-size')) || 1.1;
            const newSize = Math.min(Math.max(current + delta, 0.6), 3);
            root.style.setProperty('--verse-font-size', newSize + 'em');
            localStorage.setItem('verseFontSize', newSize);
        }
    </script>
    <script>
        // Toggle extra controls
        const menuToggle = document.getElementById('main-menu-toggle');
        const extraControls = document.getElementById('extra-controls');
        if (menuToggle && extraControls) {
            menuToggle.addEventListener('click', () => extraControls.classList.toggle('active'));
        }
        // Toggle side menu
        const sideMenuToggleBtn = document.getElementById('side-menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        if (sideMenuToggleBtn && sideMenu) {
            sideMenuToggleBtn.addEventListener('click', () => sideMenu.classList.toggle('active'));
        }
        // Cerrar menú lateral al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (sideMenu.classList.contains('active') && !sideMenu.contains(e.target) && !sideMenuToggleBtn.contains(e.target)) {
                sideMenu.classList.remove('active');
            }
        });
        // Agregar listener al item de capítulos
        const chapterMenuToggle = document.getElementById('chapter-menu-toggle');
        if (chapterMenuToggle) chapterMenuToggle.addEventListener('click', () => {
            showChapterGrid();
            sideMenu.classList.remove('active');
        });
    </script>
    <script>
        // Chapter & verse grid selection
        function showChapterGrid() {
            const grid = document.getElementById('chapter-grid');
            const chapters = xmlDoc.querySelector(`b[n="${currentBook}"]`).getElementsByTagName('c');
            const chapterButtons = Array.from(chapters).map((_, i) =>
                `<button class="chapter-btn" data-chapter="${i+1}">Capítulo ${i+1}</button>`
            ).join('');
            grid.innerHTML = `<div class="grid-content">
                <div class="grid-header">
                    <span>Selecciona Capítulo</span><span class="close-grid" data-target="chapter-grid">&times;</span>
                </div>
                ${chapterButtons}
            </div>`;
            grid.classList.add('active');
        }
        function showVerseGrid() {
            const grid = document.getElementById('verse-grid');
            const verses = xmlDoc.querySelector(`b[n="${currentBook}"] c[n="${currentChapter}"]`).getElementsByTagName('v');
            const buttons = Array.from(verses)
                .map(v => `<button class="chapter-btn" data-verse="${v.getAttribute('n')}">Versículo ${v.getAttribute('n')}</button>`)
                .join('');
            grid.innerHTML = `<div class="grid-content">
                <div class="grid-header">
                    <span>Selecciona Versículo</span><span class="close-grid" data-target="verse-grid">&times;</span>
                </div>
                ${buttons}
            </div>`;
            grid.classList.add('active');
        }
        // Handle chapter button click
        document.getElementById('chapter-grid').addEventListener('click', e => {
            if (!e.target.dataset.chapter) return;
            currentChapter = parseInt(e.target.dataset.chapter);
            document.getElementById('chapter-grid').classList.remove('active');
            showVerseGrid();
        });
        // Handle verse button click
        document.getElementById('verse-grid').addEventListener('click', e => {
            if (!e.target.dataset.verse) return;
            currentVerse = parseInt(e.target.dataset.verse);
            document.getElementById('verse-grid').classList.remove('active');
            loadChapter(); updateControls(); updateURL();
        });
        // Close modal grids
        document.addEventListener('click', e => {
            if (e.target.classList.contains('close-grid')) {
                document.getElementById(e.target.dataset.target).classList.remove('active');
            }
        });
    </script>
    <script>
        // Populate verse-select with verses of current chapter
        function populateVerseSelect() {
            const verseSelect = document.getElementById('verse-select');
            const verses = xmlDoc.querySelector(`b[n="${currentBook}"] c[n="${currentChapter}"]`).getElementsByTagName('v');
            verseSelect.innerHTML = '<option value="" disabled selected>Selecciona un versículo</option>';
            Array.from(verses).forEach(v => {
                const num = v.getAttribute('n');
                const opt = document.createElement('option');
                opt.value = num;
                opt.textContent = 'Versículo ' + num;
                verseSelect.appendChild(opt);
            });
            verseSelect.disabled = false;
        }
        // Handle verse selection
        document.getElementById('verse-select').addEventListener('change', (e) => {
            currentVerse = parseInt(e.target.value);
            loadChapter();
            updateControls();
            updateURL();
        });
    </script>
    <script>
        // Obtiene los temas directamente del XML
        function getOutlines(book, chapter) {
            const nodes = xmlDoc.querySelectorAll(`b[n="${book}"] c[n="${chapter}"] o`);
            return Array.from(nodes).map(o => ({
                title: o.getAttribute('title'),
                start: parseInt(o.getAttribute('start'), 10),
                end: parseInt(o.getAttribute('end'), 10)
            }));
        }

        // Muestra modal de temas
        function showOutlineGrid() {
            const grid = document.getElementById('outline-grid');
            const outlines = getOutlines(currentBook, currentChapter);
            const header = `<div class="grid-header"><span>Temas ${currentBook} ${currentChapter}</span><span class="close-grid" data-target="outline-grid">&times;</span></div>`;
            if (outlines.length === 0) {
                grid.innerHTML = `<div class="grid-content">${header}<div style="padding:10px;text-align:center;">No hay temas disponibles</div></div>`;
            } else {
                const buttons = outlines.map(o =>
                    `<button class="chapter-btn" data-start="${o.start}" data-end="${o.end}">${o.title}</button>`
                ).join('');
                grid.innerHTML = `<div class="grid-content">${header}${buttons}</div>`;
            }
            grid.classList.add('active');
        }
        // Maneja selección de tema
        document.getElementById('outline-grid').addEventListener('click', e => {
            if (!e.target.dataset.start) return;
            const start = parseInt(e.target.dataset.start, 10);
            currentVerse = start;
            document.getElementById('outline-grid').classList.remove('active');
            loadChapter();
            updateControls();
            updateURL();
            setTimeout(() => {
                const el = document.querySelector(`.verse[data-verse="${start}"]`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        });
        // Listener Botón Temas
        document.getElementById('outline-button').addEventListener('click', showOutlineGrid);
    </script>
    <script>
        // Mostrar selector de capítulos
        function showChapterGrid() {
            const grid = document.getElementById('chapter-grid');
            const chaptersElem = xmlDoc.querySelectorAll(`b[n=\"${currentBook}\"] c`);
            let html = '<div class="chapter-btn">';
            chaptersElem.forEach(ch => {
                const n = ch.getAttribute('n');
                html += `<button class=\"chapter-item\" data-chap=\"${n}\">${n}</button>`;
            });
            html += '</div>';
            grid.innerHTML = html;
            grid.classList.add('active');
            grid.querySelectorAll('.chapter-item').forEach(btn => {
                btn.addEventListener('click', e => {
                    currentChapter = parseInt(e.target.dataset.chap);
                    loadChapter();
                    updateChapterButton();
                    updateURL();
                    grid.classList.remove('active');
                });
            });
        }
        // Listener para botón Capítulo
        document.getElementById('chapter-button').addEventListener('click', showChapterGrid);
    </script>
    <script>
        // Annotate strong numbers
        function annotateStrongNumbers() {
            const verseEls = document.querySelectorAll('.verse-text');
            const wordMap = {};
            for (const code in strongsData) {
                const entry = strongsData[code];
                wordMap[entry.word.toLowerCase()] = code;
            }
            verseEls.forEach(el => {
                el.innerHTML = el.textContent.replace(/\b(\w+)\b/g, (match) => {
                    const code = wordMap[match.toLowerCase()];
                    return code ? `<span class="strong-word" data-strong="${code}">${match}</span>` : match;
                });
            });
        }
        document.body.addEventListener('click', e => {
            const sw = e.target.closest('.strong-word');
            if (!sw) return;
            const info = strongsData[sw.dataset.strong];
            if (!info) return;
            document.getElementById('strongs-content').innerHTML = '<strong>' + info.word + ' (' + sw.dataset.strong + ')</strong><br>' +
                'Translit: ' + info.translit + '<br>' +
                'Def: ' + info.meaning;
            document.getElementById('strongs-backdrop').style.display = 'block';
            document.getElementById('strongs-modal').style.display = 'block';
        });
        document.getElementById('strongs-close').addEventListener('click', () => {
            document.getElementById('strongs-backdrop').style.display = 'none';
            document.getElementById('strongs-modal').style.display = 'none';
        });
        const origLoadChapter = window.loadChapter;
        window.loadChapter = async function() {
            await origLoadChapter();
            annotateStrongNumbers();
        };
    </script>
</body>
</html>
